<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://cxinxian.github.io">
  <title>Netty 笔记1 | Allen个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一、Java 的I&#x2F;O演进之路Java1.4之前的早期版本，对I&#x2F;O的支持并不完善，使得开发人员在开发高性能I&#x2F;O程序时，面了巨大的挑战和困难，其主要问题如下：  没有数据缓冲区，I&#x2F;O 性能存在问题； 没有C或者C++中的Channel概念，只有输入和输出流； 同步阻塞式 I&#x2F;O 通信（BIO)，通常会导致通信线程被长时间阻塞； 支持的字符集有限">
<meta property="og:type" content="article">
<meta property="og:title" content="Netty 笔记1">
<meta property="og:url" content="http://cxinxian.github.io/2021/09/06/Netty/Netty%20%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Allen个人博客">
<meta property="og:description" content="一、Java 的I&#x2F;O演进之路Java1.4之前的早期版本，对I&#x2F;O的支持并不完善，使得开发人员在开发高性能I&#x2F;O程序时，面了巨大的挑战和困难，其主要问题如下：  没有数据缓冲区，I&#x2F;O 性能存在问题； 没有C或者C++中的Channel概念，只有输入和输出流； 同步阻塞式 I&#x2F;O 通信（BIO)，通常会导致通信线程被长时间阻塞； 支持的字符集有限">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/1-1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/1-2.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/1-3.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/2-1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/2-2.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/2-3.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/2-4.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/2-5.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/2-6.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/4-1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/4-2.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/4-2-3.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/4-2-3.1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty%5C5-1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/5-2.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/5-3.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/5-4.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/5-5.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/5-6.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/7-1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/7-2.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/8-1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty%5C10-1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/10-2.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/10-3.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/10-4.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/10-9.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/10-5.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/10-6.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/10-7.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/10-8.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/11-1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/11-2.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/11-3.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/11-4.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/11-5.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/12-1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/12-2.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/12-3.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/12-4-1.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/12-4-2.png">
<meta property="og:image" content="http://cxinxian.github.io/assets/blogImg/Netty/13-1.png">
<meta property="article:published_time" content="2021-09-06T13:53:21.000Z">
<meta property="article:modified_time" content="2025-02-21T13:55:48.971Z">
<meta property="article:author" content="Allen">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://cxinxian.github.io/assets/blogImg/Netty/1-1.png">
  
    <link rel="alternative" href="/atom.xml" title="Allen个人博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/assets/blogImg/favicon.ico">
  
  <link rel="stylesheet" type="text/css" href="/./main.0cf68a.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="/assets/blogImg/avatar.jpg" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/archives">归档</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/cxinxian" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="/atom.xml" title="rss"><i class="icon-rss"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="/assets/blogImg/avatar.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author"></h1>
			</hgroup>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/cxinxian" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss"><i class="icon-rss"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/archives">归档</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            <article id="post-Netty/Netty 笔记" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Netty 笔记1
    </h1>
  

        
        <a href="/2021/09/06/Netty/Netty%20%E7%AC%94%E8%AE%B0/" class="archive-article-date">
  	<time datetime="2021-09-06T13:53:21.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-09-06</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一、Java-的I-O演进之路"><a href="#一、Java-的I-O演进之路" class="headerlink" title="一、Java 的I&#x2F;O演进之路"></a>一、Java 的I&#x2F;O演进之路</h3><p>Java1.4之前的早期版本，对I&#x2F;O的支持并不完善，使得开发人员在开发高性能I&#x2F;O程序时，面了巨大的挑战和困难，其主要问题如下：</p>
<ul>
<li>没有数据缓冲区，I&#x2F;O 性能存在问题；</li>
<li>没有C或者C++中的Channel概念，只有输入和输出流；</li>
<li>同步阻塞式 I&#x2F;O 通信（BIO)，通常会导致通信线程被长时间阻塞；</li>
<li>支持的字符集有限，硬件可移植不好。</li>
</ul>
<span id="more"></span>

<h4 id="I-O-基础入门"><a href="#I-O-基础入门" class="headerlink" title="I&#x2F;O 基础入门"></a>I&#x2F;O 基础入门</h4><h5 id="Linux-网络-I-O-模型简介："><a href="#Linux-网络-I-O-模型简介：" class="headerlink" title="Linux 网络 I&#x2F;O 模型简介："></a>Linux 网络 I&#x2F;O 模型简介：</h5><p>Unix 网络编程对I&#x2F;O 模型的分类，提供了5种I&#x2F;O模型，分别如下：</p>
<ul>
<li>阻塞I&#x2F;O模型</li>
<li>非阻塞I&#x2F;O模型</li>
<li>I&#x2F;O 复用模型</li>
<li>信号驱动 I&#x2F;O 模型</li>
<li>异步 I&#x2F;O</li>
</ul>
<p><img src="/../assets/blogImg/Netty/1-1.png" alt="1-1"><img src="/../assets/blogImg/Netty/1-2.png" alt="image-20210826165211834"><img src="/../assets/blogImg/Netty/1-3.png" alt="image-20210826165241853"></p>
<h5 id="I-O多路复用"><a href="#I-O多路复用" class="headerlink" title="I&#x2F;O多路复用"></a>I&#x2F;O多路复用</h5><p>I&#x2F;O多路复用技术通过把多个 I&#x2F;O 的阻塞复用到同一个select 的阻塞上，使得系统在单线程的情况下可以同时处理多个客户端请求。与多线程或多进程模型比，I&#x2F;O 多路复用降低了系统开销，节省系统资源。应用场景如下：</p>
<ul>
<li>服务器需要同时处理多个处于监听状态或者多个连接状态的套接字；</li>
<li>服务器需要同时处理多种网络协议套接字。</li>
</ul>
<p>目前之前的 I&#x2F;O 多路复用的系统调用有：select、pselect、poll、epoll</p>
<h4 id="Java-的-I-O-演进"><a href="#Java-的-I-O-演进" class="headerlink" title="Java 的 I&#x2F;O 演进"></a>Java 的 I&#x2F;O 演进</h4><p>在 Java 1.4 推出 Java NIO 之前，基于Java 的所有Socket 通信都采用了同步阻塞模式(BIO)，这种一请求一应答的同学模型简化了上层的应用开发，但性能和可靠性却存在巨大的瓶颈。</p>
<ul>
<li><p>从 JDK1.0 到 JDK1.3 ，只有 BIO</p>
</li>
<li><p>JDK1.4 新增 java.nio 包，提供很多进行异步 I&#x2F;O 开发的类库和 API，主要类和接口：</p>
<ul>
<li><p>进行异步I&#x2F;O操作的缓冲区 ByteBuffer 等；</p>
</li>
<li><p>进行异步I&#x2F;O操作的管道 Pipe；</p>
</li>
<li><p>进行各种 I&#x2F;O 操作（异步or同步）的Channel，包括 ServerSocketChannel 和 SocketChannel；</p>
</li>
<li><p>多种字符集的编解码能力；</p>
</li>
<li><p>实现非阻塞 I&#x2F;O 操作的多路复用器 selector；</p>
</li>
<li><p>基于流行的 Perl 实现的正则表达式类库；</p>
</li>
<li><p>文件通道 FileChannel。<br>它的不足有：</p>
</li>
<li><p>没有统一的文件属性（例如读写权限）</p>
</li>
<li><p>API 能力比较弱，如目录的级联创建何递归遍历，往往需要自己实现</p>
</li>
<li><p>底层存储系统的一个些高级API无法使用</p>
</li>
<li><p>所有文件操作都是同步阻塞调用，不支持异步文件读写</p>
</li>
</ul>
</li>
<li><p>JDK1.7 对原有的 NIO库进行了升级，被称为 NIO2.0，主要改进有：</p>
<ul>
<li>提供能够批量获取文件属性的API，这些API具有与平台无关性，不与特性文件系统相耦合</li>
<li>提供 AIO 功能，支持基于文件的异步 I&#x2F;O 操作和针对网络套接字的异步操作</li>
<li>完成 JSR-51定义的通道功能，包括对配置和多播数据包的支持等。</li>
</ul>
</li>
</ul>
<h3 id="二、NIO入门"><a href="#二、NIO入门" class="headerlink" title="二、NIO入门"></a>二、NIO入门</h3><h4 id="传统的BIO编程"><a href="#传统的BIO编程" class="headerlink" title="传统的BIO编程"></a>传统的BIO编程</h4><p>网络编程的基本模型是 Client&#x2F;Server 模型，也就是两个进程之间进行相互通信，其中服务端提供位置信息（IP地址和监听端口），客户端通过连接操作服务端监听地址发起连接请求，通过三次握手建立连接，如果连接成功，双方就可以通过套接字（Socket）进行通信。</p>
<p>在传统的 BIO 编程中，ServerSocket 负责绑定 IP地址，启动监听端口；Socket 负责发起连接操作，连接成功后，双方通过输入流和输出流进行同步阻塞式通信。</p>
<h5 id="BIO-通信模型图"><a href="#BIO-通信模型图" class="headerlink" title="BIO 通信模型图"></a>BIO 通信模型图</h5><p>采用 BIO 通信模型的服务端，通常由一个独立的 Acceptor 线程负责监听客户端的连接，收到客户端的连接请求后为每个客户端创建一个新的线程进行链路处理，处理完成后，通过输出流返回应答给客户端，线程销毁。</p>
<p><img src="/../assets/blogImg/Netty/2-1.png" alt="image-20210830104806593"></p>
<p>  该模型最大的问题是缺乏弹性伸缩能力，当客户端的访问数量增加时，服务端的线程数和客户端并发访问数呈现1:1的正比例关系，由于线程是虚拟机非常宝贵的系统资源，当线程数量膨胀后，系统性能将会急剧下降，随着并发访问量的继续增大，系统会发生线程堆栈溢出，创建新线程失败等问题，导致进程宕机僵死，无法提供对外服务。</p>
<h5 id="同步阻塞式-I-O-创建的TimeServer-源码分析"><a href="#同步阻塞式-I-O-创建的TimeServer-源码分析" class="headerlink" title="同步阻塞式 I&#x2F;O 创建的TimeServer 源码分析"></a>同步阻塞式 I&#x2F;O 创建的TimeServer 源码分析</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8082</span>;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            server = <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);</span><br><span class="line">            System.out.println(<span class="string">&quot;the time server is start in port:&quot;</span>+port);</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">                <span class="comment">// 阻塞主线程，直到有新的 socket 客户端连接进来</span></span><br><span class="line">                socket = server.accept();</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">TimeServerHandler</span>(socket)).start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (server!=<span class="literal">null</span>)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;The time server close&quot;</span>);</span><br><span class="line">                server.close();</span><br><span class="line">                server = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TimeServerHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Socket socket;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">TimeServerHandler</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.socket = socket;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">readerIn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">printWriter</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 输入流、输出流</span></span><br><span class="line">                readerIn = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="built_in">this</span>.socket.getInputStream()));</span><br><span class="line">                printWriter = <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="built_in">this</span>.socket.getOutputStream(),<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">currentTime</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">                    <span class="comment">// 获取输入流中的内容</span></span><br><span class="line">                    body = readerIn.readLine();</span><br><span class="line">                    <span class="keyword">if</span> (body==<span class="literal">null</span>)<span class="keyword">break</span>;</span><br><span class="line">                    System.out.println(<span class="string">&quot;The time server receive order: &quot;</span>+body);</span><br><span class="line">                    currentTime = <span class="string">&quot;QUERY_TIME_ORDER&quot;</span>.equals(body)?LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)):<span class="string">&quot;BAD QUERY&quot;</span>;</span><br><span class="line">                    <span class="comment">// 输出流输出服务端响应内容</span></span><br><span class="line">                    printWriter.println(currentTime);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">if</span> (readerIn!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        readerIn.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">                        e1.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (printWriter!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    printWriter.close();</span><br><span class="line">                    printWriter = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.socket!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="built_in">this</span>.socket.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">                        e1.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">this</span>.socket = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  程序中通过ServerSocket 监听指定端口，如果没有被占用，服务端监听成功。如果没有客户端接入，则主线程阻塞在 accept() 操作上，直到有新的客户短连接进来。</p>
<h5 id="同步阻塞式-I-O-创建的-TimeClient-源码分析"><a href="#同步阻塞式-I-O-创建的-TimeClient-源码分析" class="headerlink" title="同步阻塞式 I&#x2F;O 创建的 TimeClient 源码分析"></a>同步阻塞式 I&#x2F;O 创建的 TimeClient 源码分析</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8082</span>;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8082</span>);</span><br><span class="line"></span><br><span class="line">            in = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));</span><br><span class="line">            out = <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(socket.getOutputStream(),<span class="literal">true</span>);</span><br><span class="line">            out.println(<span class="string">&quot;QUERY_TIME_ORDER&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Send order to server succeed.&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">resp</span> <span class="operator">=</span> in.readLine();</span><br><span class="line">            System.out.println(<span class="string">&quot;Now is：&quot;</span>+resp);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (in!=<span class="literal">null</span>)&#123;</span><br><span class="line">                in.close();</span><br><span class="line">                in = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (out!=<span class="literal">null</span>)&#123;</span><br><span class="line">                out.close();</span><br><span class="line">                out = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (socket!=<span class="literal">null</span>)&#123;</span><br><span class="line">                socket.close();</span><br><span class="line">                socket=<span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  客户端通过 Socket 连接到服务端，通过 <code>PrintWriter</code> 向服务端发送 <code>QUERY_TIME_ORDER</code> 指令，然后通过 <code>BufferReader</code> 读取服务端响应结果。</p>
<p><strong>BIO</strong>主要问题是当有新的客户端请求接入时，服务端需要创建一个新的线程处理新接入的客户端链路，一个线程只能处理一个客户端连接，在高性能服务器应用领域，往往需要成千上万个客户端的并发连接，无法满足高性能，高并发的接入场景。</p>
<h4 id="伪异步-I-O-编程"><a href="#伪异步-I-O-编程" class="headerlink" title="伪异步 I&#x2F;O 编程"></a>伪异步 I&#x2F;O 编程</h4><p>为解决同步阻塞 **I&#x2F;O ** 面临的一个链路需要一个线程处理的问题，后来有人通过对线程模型的优化——后端通过线程池来处理多个客户端的接入请求，形成客户端M，线程池最大线程数 N 的比例关系，M远大于N，通过线程池灵活地调配资源，设置线程最大值，防止海量并发接入导致资源耗尽。</p>
<h5 id="伪异步-I-O-模型图"><a href="#伪异步-I-O-模型图" class="headerlink" title="伪异步 I&#x2F;O 模型图"></a>伪异步 I&#x2F;O 模型图</h5><p><img src="/../assets/blogImg/Netty/2-2.png" alt="2-1"></p>
<p>当有新的客户端接入时，将客户端 Socket 封装成一个 Task (实现 Runnable 接口）投递到后端线程池中进行处理，线程池维护一个消息队列和 N 个活跃线程，对消息队列中的任务进行处理。</p>
<h5 id="伪异步-I-O-创建的TimeServer-源码分析"><a href="#伪异步-I-O-创建的TimeServer-源码分析" class="headerlink" title="伪异步 I&#x2F;O 创建的TimeServer 源码分析"></a>伪异步 I&#x2F;O 创建的TimeServer 源码分析</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnycBioTimeServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">TimeServerHandlerExecutePool</span> <span class="variable">executePool</span> <span class="operator">=</span> TimeServerHandlerExecutePool.getInstance();</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8082</span>;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            server = <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);</span><br><span class="line">            System.out.println(<span class="string">&quot;the time server is start in port:&quot;</span>+port);</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">                <span class="comment">// 阻塞主线程，直到有新的 socket 客户端连接进来</span></span><br><span class="line">                socket = server.accept();</span><br><span class="line">                executePool.execute(<span class="keyword">new</span> <span class="title class_">TimeServerHandler</span>(socket));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;The time server close&quot;</span>);</span><br><span class="line">                server.close();</span><br><span class="line">                server = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 线程池类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeServerHandlerExecutePool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ExecutorService executorService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> TimeServerHandlerExecutePool INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">static</span> TimeServerHandlerExecutePool <span class="title function_">getInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (TimeServerHandlerExecutePool.class)&#123;</span><br><span class="line">                <span class="keyword">if</span> (INSTANCE==<span class="literal">null</span>)&#123;</span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> <span class="title class_">TimeServerHandlerExecutePool</span>(<span class="number">50</span>,<span class="number">1000</span>);</span><br><span class="line">                    <span class="keyword">return</span> INSTANCE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">TimeServerHandlerExecutePool</span><span class="params">(<span class="type">int</span> maxPoolSize, <span class="type">int</span> queueSize)</span> &#123;</span><br><span class="line">        executorService = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(Runtime.getRuntime().availableProcessors(),maxPoolSize,<span class="number">120L</span>, TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;Runnable&gt;(queueSize));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable runnable)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (executorService!=<span class="literal">null</span>)&#123;</span><br><span class="line">            executorService.execute(runnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>线程池和消息队列类都有界，无论客户端并发连接数量多大，都不会导致线程个数膨胀或者内存溢出。采用线程池实现，避免了并发连接请求对系统资源的消耗问题。但是底层依然是同步阻塞模型，无法从根本上解决问题。</p>
<h5 id="伪异步-I-O-的弊端"><a href="#伪异步-I-O-的弊端" class="headerlink" title="伪异步 I&#x2F;O 的弊端"></a>伪异步 I&#x2F;O 的弊端</h5><ul>
<li><p>读写（read、out）操作都是同步阻塞，阻塞时间取决于对方 <strong>I&#x2F;O</strong> 线程处理速度和网络 <strong>I&#x2F;O</strong> 的传输速度。</p>
</li>
<li><p>线程池阻塞队列积满后，后续入队列操作将被阻塞。</p>
</li>
</ul>
<h4 id="NIO-编程"><a href="#NIO-编程" class="headerlink" title="NIO 编程"></a>NIO 编程</h4><p>相比于<strong>BIO</strong> 的 <code>ServerSocket</code> 和 <code>Socket</code> ，<strong>NIO</strong> 提供了<code>ServerSocketChannel</code> 和 <code>SocketChannel</code> 两种不同的套接字通道实现。新增的通道都支持 <em>阻塞式</em> 和 <em>非阻塞式</em>  两种模式。一般来说，低负载、低并发的应用程序可以选择同步阻塞I&#x2F;O以降低编程复杂度；对于高负载，高并发的网络应用需要使用<strong>NIO</strong>模式进行开发</p>
<h5 id="NIO-类库简介"><a href="#NIO-类库简介" class="headerlink" title="NIO 类库简介"></a>NIO 类库简介</h5><p><strong>NIO</strong> 库是 JDK1.4 中引入的，弥补了原来 <strong>BIO</strong> 同步阻塞的不足，在标准的 Java 代码中提供了高速的、面向块的 <strong>I&#x2F;O</strong>，通过定义包含数据的类，以及通过以块的形式去处理这些数据，<strong>NIO</strong> 不使用本机代码就可以利用低级优化，这是原来 <strong>I&#x2F;O</strong> 包所无法做到的。</p>
<p><strong>缓冲区 Buffer</strong></p>
<p>Buffer 是一个对象，它包含要读出或者写入的数据，在 NIO 库中加入 Buffer对象，体现新库与原来 I&#x2F;O 库的一个重要区别。在面向流的 I&#x2F;O 库中，可以将数据直接读入或者写出到 <strong>Stream</strong> 对象中。</p>
<p>在 NIO 库中，所有数据都是用缓冲区处理的。在读取数据时，直接读到缓冲区中；同样，写数据时，写入到缓冲区中。任何访问 NIO中的数据，都是通过缓冲区进行操作。</p>
<p>缓冲区实质是一个数组。通常它是一个字节数组（ByteBuffer)，也可以使用其他种类数组，缓冲区不仅仅是一个数组，还提供了对数据结构化访问以及维护读写位置（limit) 等信息。</p>
<p><img src="/../assets/blogImg/Netty/2-3.png" alt="image-20210830164049161"></p>
<p>每个 Buffer 类都是 Buffer 接口的一个子实例，除了 ByteBuffer， 每一个 Buffer 类都有完全一样的操作，只是它们所处理的数据类型不一样。因为大多数标准 I&#x2F;O 操作都使用ByteBuffer，所以它具有一般缓冲区操作之外还提供了一些特有的操作，以便网络读写。</p>
<p><strong>通道Channel</strong></p>
<p>Channel 是一个通道，像自来水管一样，网络数据通过 Channel 读取和写入。通道与流的不同之处在于通道是双向的，流只在一个方向移动（一个流必须是 InputStream 或者 OutputStream），而通道可以用于读、写同时进行。</p>
<p>因为 Channel 是全双工，所以比流更好的映射底层操作系统API。</p>
<p><img src="/../assets/blogImg/Netty/2-4.png" alt="2-4"></p>
<p><strong>多路复用器</strong></p>
<p>多路复用器 Selector ， 是Java NIO 编程基础，它提供已经选择就绪的任务的能力。简单来讲，Selector 会不断轮询已经注册在其上的 Channel，如果 Channel 发生读写事件，这个Channel 就处于就绪状态，会被 Selector 轮询出来，然后通过 SelectionKey 可以获取就绪 Channel 集合，进行后续的 I&#x2F;O 操作。</p>
<p>一个多路复用器可以同时轮询多 Channel，由于 JDK 使用了 epoll() 代替传统的 select 实现，所以他并没有最大连接句柄 1024&#x2F;2048 的限制。这也意味着只需要一个线程负责 Selector 的轮询，就可以接入成千上万的客户端。</p>
<h5 id="NIO-服务端序列图"><a href="#NIO-服务端序列图" class="headerlink" title="NIO 服务端序列图"></a>NIO 服务端序列图</h5><p><img src="/../assets/blogImg/Netty/2-5.png" alt="2-5"></p>
<h5 id="NIO-创建的-TimeServer-源码分析"><a href="#NIO-创建的-TimeServer-源码分析" class="headerlink" title="NIO 创建的 TimeServer 源码分析"></a>NIO 创建的 TimeServer 源码分析</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOTimeServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8082</span>;</span><br><span class="line">        <span class="type">MultiplexerTimeServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiplexerTimeServer</span>(port);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(server,<span class="string">&quot;NIO-MultiplexerTimeServer-001&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiplexerTimeServer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line">    <span class="keyword">private</span> ServerSocketChannel servChannel;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> stop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MultiplexerTimeServer</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            servChannel = ServerSocketChannel.open();</span><br><span class="line">            servChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            servChannel.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port),<span class="number">1024</span>);</span><br><span class="line">            servChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">            System.out.println(<span class="string">&quot;The time server is start in port: &quot;</span>+port);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.stop = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!stop)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                selector.select(<span class="number">1000</span>);</span><br><span class="line">                Set&lt;SelectionKey&gt; selectionKeySet = selector.selectedKeys();</span><br><span class="line">                Iterator&lt;SelectionKey&gt; itr = selectionKeySet.iterator();</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">while</span> (itr.hasNext())&#123;</span><br><span class="line">                    key = itr.next();</span><br><span class="line">                    itr.remove();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        handlerInput(key);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        <span class="keyword">if</span> (key!=<span class="literal">null</span>)&#123;</span><br><span class="line">                            key.cancel();</span><br><span class="line">                            <span class="keyword">if</span> (key.channel()!=<span class="literal">null</span>) key.channel().close();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (selector!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 多路复用器关闭后，所有注册在上面的Channel 和 Pipe 等资源都会被自动去注册并关闭，所有并不需要重复释放资源</span></span><br><span class="line">                selector.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlerInput</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (key.isValid())&#123;</span><br><span class="line">            <span class="comment">// 处理新接入的请求信息</span></span><br><span class="line">            <span class="keyword">if</span> (key.isAcceptable())&#123;</span><br><span class="line">                <span class="comment">// accept new Connection</span></span><br><span class="line">                <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">                <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> serverSocketChannel.accept();</span><br><span class="line">                sc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                <span class="comment">// Add the new connection to the selector</span></span><br><span class="line">                sc.register(selector,SelectionKey.OP_READ);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (key.isReadable())&#123;</span><br><span class="line">                <span class="comment">// read the data</span></span><br><span class="line">                <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">readBytes</span> <span class="operator">=</span> sc.read(byteBuffer);</span><br><span class="line">                <span class="keyword">if</span> (readBytes&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                    byteBuffer.flip();</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[byteBuffer.remaining()];</span><br><span class="line">                    byteBuffer.get(bytes);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;The time server receive order : &quot;</span>+ body);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">currentTime</span> <span class="operator">=</span> <span class="string">&quot;QUERY_SERVER_TIME&quot;</span>.equals(body)? LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)):<span class="string">&quot;BAD REQUEST!&quot;</span>;</span><br><span class="line">                    dowrit(sc,currentTime);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span> (readBytes&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="comment">// 关闭链路</span></span><br><span class="line">                    key.cancel();</span><br><span class="line">                    sc.close();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 读到 0字节，忽略</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dowrit</span><span class="params">(SocketChannel sc, String response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (response!=<span class="literal">null</span> &amp;&amp; response.trim().length()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">byte</span>[] bytes = response.getBytes();</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(bytes.length);</span><br><span class="line">            byteBuffer.put(bytes);</span><br><span class="line">            byteBuffer.flip();</span><br><span class="line">            sc.write(byteBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>初始化资源，创建多路复用器 <code>Selector</code>、<code>ServerSocketChannel</code> ，对 Channel 和 TCP 参数进行配置。如：将 ServerSocketChannel 设置为异步非阻塞，backlog &#x3D; 1024。将 ServerSocketChannel 注册到 Selector，监听 SelectionKey.OP_ACCEPT 操作位。</p>
</li>
<li><p>在 run 方法体中循环遍历 selector ，它的休眠时间为 1s ，不管是否有读写事件发生，selector 每隔 1s都会被唤醒一次，selector 提供无参方法 selectedKeys，当有处于就绪状态的 Channel 时，selector 将返回该 Channel 的 SelectionKey 集合</p>
</li>
<li><p>在处理新接入客户端消息时，根据 SelectionKey 操作位判断可获知网络事件类型，通过 ServerSocketChannel 的 accept 接收客户端的连接请求，并创建 SocketChannel 实例 ，完成上述步骤相当于完成 TCP 三次握手，TCP 物理链路正式建立。</p>
</li>
<li><p>读取客户端消息时，先创建一个ByteBuffer ，由于事先不知客户端发送的码流的大小，在例程中，开辟 1MB 大小的缓冲区。接着调用SocketChannel 的 read 方法读取码流，因设置SocketChannel 为异步非阻塞模式，因此 read 也是非阻塞的。读取到码流后，进行解码。首先对 Byteffer 进行 flip() 操作，它的作用是将缓冲区当前的 limit 设为 position，position设置为0，用于后续对缓冲区的操作。然后根据缓冲区的可读字节个数创建字节数组，调用Byteffer的get 方法，将缓冲区中可读的字节数据复制到新创建的字节数组。</p>
<p>读取到数据的字节数可能有以下几种情况</p>
<ul>
<li>返回值大于0：读到了字节，对字节数据编解码</li>
<li>返回值等于0：没有读到字节，属于正常情况，可忽略</li>
<li>返回值小于-1：链路已经关闭，需要关闭 SocketChannel，释放资源。</li>
</ul>
</li>
<li><p>应答消息发送给客户端时，先将字符串编码成字节数组，根据字节数组的容量创建 ByteBuffer，调用 put 方法将字节数组复制到缓冲区中，然后调用 flip 操作，最后调用 SocketChannel 的 write 方法将缓冲区中的数据发送出去。</p>
</li>
</ol>
<h5 id="NIO-客户端序列图"><a href="#NIO-客户端序列图" class="headerlink" title="NIO 客户端序列图"></a>NIO 客户端序列图</h5><p><img src="/../assets/blogImg/Netty/2-6.png" alt="image-20210831105007494"></p>
<h5 id="NIO-创建的TimeClient-源码分析"><a href="#NIO-创建的TimeClient-源码分析" class="headerlink" title="NIO 创建的TimeClient 源码分析"></a>NIO 创建的TimeClient 源码分析</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOTimeClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span>&#123;</span><br><span class="line">        <span class="type">NIOTimeClientHandler</span> <span class="variable">clientHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NIOTimeClientHandler</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8082</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(clientHandler,<span class="string">&quot;NIOTimeClient-02&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NIOTimeClientHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line">    <span class="keyword">private</span> SocketChannel sc;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> isStop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NIOTimeClientHandler</span><span class="params">(String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.host = (host==<span class="literal">null</span> || host.equals(<span class="string">&quot;&quot;</span>) || host.length()==<span class="number">0</span>)?<span class="string">&quot;127.0.0.1&quot;</span>:host;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            sc = SocketChannel.open();</span><br><span class="line">            sc.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doConnect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!isStop)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                selector.select(<span class="number">1000</span>);</span><br><span class="line">                Set&lt;SelectionKey&gt; selectionKeySet = selector.selectedKeys();</span><br><span class="line">                Iterator&lt;SelectionKey&gt; itr = selectionKeySet.iterator();</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">while</span> (itr.hasNext())&#123;</span><br><span class="line">                    key = itr.next();</span><br><span class="line">                    itr.remove();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        handlerInput(key);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        <span class="keyword">if</span> (key!=<span class="literal">null</span>)&#123;</span><br><span class="line">                            key.cancel();</span><br><span class="line">                            <span class="keyword">if</span> (key.channel()!=<span class="literal">null</span>)&#123;</span><br><span class="line">                                key.channel().close();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 多路复用器关闭后，所以注册在上面的Channel 和 Pipe 等资源都会被自动注册并关闭，不需要重复释放资源</span></span><br><span class="line">        <span class="keyword">if</span> (selector!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                selector.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlerInput</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (key.isValid())&#123;</span><br><span class="line">            <span class="comment">// 判断连接是否成功</span></span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">sc</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">            <span class="keyword">if</span> (key.isConnectable())&#123;</span><br><span class="line">                <span class="keyword">if</span> (sc.finishConnect())&#123;</span><br><span class="line">                    sc.register(selector,SelectionKey.OP_READ);</span><br><span class="line">                    doWrite(sc);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 连接失败，退出进程</span></span><br><span class="line">                    System.exit(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (key.isReadable())&#123;</span><br><span class="line">                <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">readSize</span> <span class="operator">=</span> sc.read(byteBuffer);</span><br><span class="line">                <span class="keyword">if</span> (readSize&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                    byteBuffer.flip();</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[byteBuffer.remaining()];</span><br><span class="line">                    byteBuffer.get(bytes);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;NOW is : &quot;</span>+ resp);</span><br><span class="line">                    <span class="built_in">this</span>.isStop = <span class="literal">true</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span> (readSize&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="comment">// 对链路关闭</span></span><br><span class="line">                    key.cancel();</span><br><span class="line">                    sc.close();</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 0 字节，忽略</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doConnect</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">connected</span> <span class="operator">=</span> sc.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="built_in">this</span>.host,<span class="built_in">this</span>.port));</span><br><span class="line">        <span class="comment">// 判断是否连接成功，连接成功，注册读状态到多路复用器中</span></span><br><span class="line">        <span class="comment">// 连接不成功（客户端已经发生 sync 包，还没有收到服务端 ack 包，物理链路还没有建立起来），注册 OP_CONNECT 到多路复用器中，监听服务端ACK应答。</span></span><br><span class="line">        <span class="keyword">if</span> (connected)&#123;</span><br><span class="line">            sc.register(selector,SelectionKey.OP_READ);</span><br><span class="line">            doWrite(sc);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            sc.register(selector, SelectionKey.OP_CONNECT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWrite</span><span class="params">(SocketChannel sc)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] reqbyte = <span class="string">&quot;QUERY_SERVER_TIME&quot;</span>.getBytes();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(reqbyte.length);</span><br><span class="line">        byteBuffer.put(reqbyte);</span><br><span class="line">        byteBuffer.flip();</span><br><span class="line">        sc.write(byteBuffer);</span><br><span class="line">        <span class="keyword">if</span> (!byteBuffer.hasRemaining())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Client has send order to server succeed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li>初始化多路复用器 <code>Selector</code>、<code>SocketChannel</code> ，创建 <code>SocketChannel</code> 对象后，将其设置为异步非阻塞模式。</li>
<li>对 <code>SocketChannel</code> 的 connect 操作进行判断。如果连接成功，则将 <code>SocketChannel</code> 注册到多路复用器 <code>Selector</code> 上，注册 <code>SelectionKey.OP_READ</code>； 如果没有连接成功，说明服务端没有返回 TCP 握手应答信息，但是不意味着连接失败。需要将 <code>SocketChannel</code> 注册到多路复用器<code>Selector</code> 上，注册<code>SelectionKey.OP_CONNECT</code> ，当服务端TCP响应 sync-ack 消息后，<code>Selector</code> 就能轮询到这个 <code>SocketChannel</code> 处于连接就绪。</li>
<li>循环体中轮询多路复用器<code>Selector</code>，当有就绪的 Channel 时，会调用 handlerInput(key) 方法，下面将会分析</li>
<li>在上面的代码 handlerInput 方法中，对 SelectionKey 的状态进行判断，如果处于连接状态，说明服务端 TCP 已经响应返回 ACK 应答消息。这时需要调用 SocketChannel 的 finishConnect 方法判断，如果返回 true，说明客户端连接成功；如果false或者抛出 IOException 异常，说明连接失败。在例程中，连接成功后则把 SocketChannel 注册到多路复用器上，注册<code>SelectionKey.OP_READ</code> 操作位，监听网络读操作，然后发送请求消息给服务端。</li>
<li>发送消息给服务端是先对消息编码成字节数组，然后写入到数据缓冲区 ByteBuffer，最后调用 SocketChannel 的 write 方法发送到服务端。由于发送是异步的，存在 ”半写包“ 问题。通过 <code>hasRemaining</code> 方法可判断缓冲区的消息是否全部发送完成。</li>
<li>如果客户端收到服务端的应答消息，可以根据 <code>SelectionKey</code> 的 <code>isReadable</code>方法判断 SocketChannel 是可读的，因无法事先判断应答码流的大小，我们可以通过 <code>ByteBuffer.allocate(1024)</code> 预先分配 1MB 大小的缓冲区空间用于读取应答消息，然后调用 SocketChannel 的 read() 方法进行异步读取应答消息。</li>
<li>线程退出循环后，我们需要释放连接资源，由于释放多路复用器资源后，JDK底层会释放所有跟此多路复用器相关联的资源，因此我们无需对 Channel、Pipe 等资源进行一一释放。</li>
</ol>
<p><strong>NIO编程优点总结：</strong></p>
<ul>
<li>客户端发起的连接操作是异步的，可以通过在多路复用器注册 <code>SelectionKey.OP_CONNECT</code> 等待后续结果，不需要像之前的客户端那样被同步阻塞。</li>
<li><code>SocketChannel</code> 的读写操作都是异步的，如果没有可读写的数据它是不会同步等待的，直接返回，这样 I&#x2F;O 通信线程就可以处理其他的链路，不需要同步等待这个链路可用。</li>
<li>线程模型优化：由于 JDK 的 Selector 在 Linux 等主流操作系统上通过 epoll 实现，它没有连接句柄数的限制（只受操作系统的最大句柄数或者对单进程的句柄数限制），这意味着一个 Selector 可以同时处理成千上万个客户端连接，而且性能不会随着客户端的增加而线性下降。因此，它非常适合做高性能、高负载的网络服务器。</li>
</ul>
<p>注：JDK1.7 升级了NIO类库，升级后的NIO类库被称作 NIO2.0，Java 正式提供了异步文件I&#x2F;O操作，同时提供了与UNIX 网络编程事件驱动 I&#x2F;O 对应的 AIO。</p>
<h4 id="AIO-编程"><a href="#AIO-编程" class="headerlink" title="AIO 编程"></a>AIO 编程</h4><p>NIO 2.0 引入了新的异步通道概念，并提供了异步文件通道和异步套接字通道的实现。其异步套接字通道是真正的异步非阻塞I&#x2F;O。</p>
<p>异步通道提供了以下两种方式获取操作结果。</p>
<ul>
<li>通过 <code>java.util.concurrent.Future</code> 类来表示异步操作的结果。</li>
<li>在执行异步操作时传入一个 <code>java.nio.channels</code>。</li>
</ul>
<p>CompletionHandler 接口的实现类作为操作完成的回调。</p>
<h5 id="AIO创建的TimeServer-源码分析"><a href="#AIO创建的TimeServer-源码分析" class="headerlink" title="AIO创建的TimeServer 源码分析"></a>AIO创建的TimeServer 源码分析</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsynTimeServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span>&#123;</span><br><span class="line">        <span class="type">AsynTimeServerHandler</span> <span class="variable">serverHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AsynTimeServerHandler</span>(<span class="number">8082</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(serverHandler,<span class="string">&quot;AIO-AsynTimeServerHandler-01&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// AsynTimeServerHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsynTimeServerHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">public</span> CountDownLatch countDownLatch;</span><br><span class="line">    <span class="keyword">public</span> AsynchronousServerSocketChannel asynchronousServerSocketChannel;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AsynTimeServerHandler</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            asynchronousServerSocketChannel = AsynchronousServerSocketChannel.open();</span><br><span class="line">            asynchronousServerSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port));</span><br><span class="line">            System.out.println(<span class="string">&quot;The time server is start in port：&quot;</span>+port);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        countDownLatch = <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        doAccept();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAccept</span><span class="params">()</span> &#123;</span><br><span class="line">        asynchronousServerSocketChannel.accept(<span class="built_in">this</span>,<span class="keyword">new</span> <span class="title class_">AcceptCompletionHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// AcceptCompletionHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AcceptCompletionHandler</span> <span class="keyword">implements</span> <span class="title class_">CompletionHandler</span>&lt;AsynchronousSocketChannel,AsynTimeServerHandler&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(AsynchronousSocketChannel result, AsynTimeServerHandler attachment)</span> &#123;</span><br><span class="line">        attachment.asynchronousServerSocketChannel.accept(attachment,<span class="built_in">this</span>);</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        result.read(byteBuffer,byteBuffer,<span class="keyword">new</span> <span class="title class_">ReadCompletionHandler</span>(result));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, AsynTimeServerHandler attachment)</span> &#123;</span><br><span class="line">        attachment.countDownLatch.countDown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ReadCompletionHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadCompletionHandler</span> <span class="keyword">implements</span> <span class="title class_">CompletionHandler</span>&lt;Integer, ByteBuffer&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> AsynchronousSocketChannel channel;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReadCompletionHandler</span><span class="params">(AsynchronousSocketChannel result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.channel = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer result, ByteBuffer attachment)</span> &#123;</span><br><span class="line">        attachment.flip();</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[attachment.remaining()];</span><br><span class="line">        attachment.get(bytes);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;The time server receive order : &quot;</span>+body);</span><br><span class="line">            <span class="type">String</span> <span class="variable">curentTime</span> <span class="operator">=</span> <span class="string">&quot;AIO_SYNC_SERVERTIME&quot;</span>.equals(body)? LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)):<span class="string">&quot;BAD REQUEST&quot;</span>;</span><br><span class="line">            doWrite(curentTime);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.channel.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWrite</span><span class="params">(String curentTime)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (curentTime!=<span class="literal">null</span> &amp;&amp; curentTime.trim().length()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">byte</span>[] bytes = curentTime.getBytes();</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">writebuffer</span> <span class="operator">=</span> ByteBuffer.allocate(bytes.length);</span><br><span class="line">            writebuffer.put(bytes);</span><br><span class="line">            writebuffer.flip();</span><br><span class="line">            channel.write(writebuffer, writebuffer, <span class="keyword">new</span> <span class="title class_">CompletionHandler</span>&lt;Integer, ByteBuffer&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer result, ByteBuffer buffer)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (buffer.hasRemaining())&#123;</span><br><span class="line">                        <span class="comment">// 如果没有发送完成，则继续发送</span></span><br><span class="line">                        channel.write(buffer,buffer,<span class="built_in">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, ByteBuffer buffer)</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        channel.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在例程中是使用独立线程来创建服务端Handler，在<strong>实际项目中不需要独立线程创建</strong>，因为底层通过JDK的系统回调实现的。</p>
<ol>
<li><p><code>AsynTimeServerHandler</code> 在构造方法中，创建一个异步的服务端通道 <code>AsynchronousServerSocketChannel</code> ，然后调用其<code>bind()</code> 方法绑定监听端口，如果端口合法且没有被占用，则绑定成功。在 run 方法中，初始化 CountDownLatch  对象，其作用是完成一组正在执行的操作之前，允许线程一直阻塞（实际运用中不需用到，此次 CountDownLatch  仅作demo示例）。</p>
</li>
<li><p>在 <code>doAccept()</code> 方法中，用于接收客户端的连接，我们可以传递 CompletionHandler&lt;AsynchronousSocketChannel, ? super A&gt; 的handler 实例接收 accept 操作成功的消息通知。</p>
</li>
<li><p><code>AcceptCompletionHandler</code> 中的 completed 方法可以获取到 AsynTimeServerHandler 的成员变量 <code>AsynchronousServerSocketChannel </code> ，然后调用它的 accept 方法。细心的同学可能会问，为什么在这里会再次调用 accept 方法呢？原因是：调用<code>AsynchronousServerSocketChannel</code> 的 accept 方法后，当有新的客户端连接接入后，系统将会回调我们传入的 CompletionHandler 实例的 completed 方法，表示新的客户端已经接入成功。</p>
<p>链路建立成功后，通过 <code>AsynchronousSocketChannel</code> 的 <code>read()</code> 方法进行异步操作，其参数如下：</p>
<ul>
<li>ByteBuffer dst：结束缓冲区，用于从异步Channel 中读取数据包；</li>
<li>A attachment：异步 Channel 携带的附件，通知回调的时候作为入参使用；</li>
<li>CompletionHandler&lt;Integer,? super A&gt; ，接收通知回调的业务Handler</li>
</ul>
</li>
<li><p>在<code>ReadCompletionHandler</code> 的构造方法中，我们可以拿到 <code>AsynchronousSocketChannel</code> 的实例，主要用来读取半包信息和发送应答。在<code>completed()</code> 方法中是读取消息的处理，首先调用 attachment 的 <code>flip()</code> 方法，为后续读取缓冲区数据做准备。根据缓冲区数据的可读字节数创建 byte 数组，然后根据 byte 数组 new String 创建消息。</p>
<p><code>dowWrite()</code> 方法响应给客户端消息时，首先把字符串消息转换成字节数组，然后通过 ByteBuffer 复制到发送缓冲区，然后通过 <code>AsynchronousSocketChannel</code> 的异步 <code>write()</code> 方法发送消息。<code>write()</code> 方法的参数和<code>read()</code> 方法的参数一样。</p>
</li>
<li><p>CompletionHandler 的 <code>failed()</code> 方法，其作用是当发生异常时，对异常 Throwable 进行判断，根据异常做出相应的逻辑处理，如 I&#x2F;O 异常则关闭链路，释放资源。</p>
</li>
</ol>
<h5 id="AIO创建的-TimeClient-源码分析"><a href="#AIO创建的-TimeClient-源码分析" class="headerlink" title="AIO创建的 TimeClient 源码分析"></a>AIO创建的 TimeClient 源码分析</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsynTimeClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span>&#123;</span><br><span class="line">        <span class="type">AsynTimeClientHandler</span> <span class="variable">clientHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AsynTimeClientHandler</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8082</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(clientHandler,<span class="string">&quot;AIO-AsynTimeClientHandler-01&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// AsynTimeClientHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsynTimeClientHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>, CompletionHandler&lt;Void, AsynTimeClientHandler&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> AsynchronousSocketChannel socketChannel;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> CountDownLatch latch;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AsynTimeClientHandler</span><span class="params">(String host,<span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.host = host;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socketChannel = AsynchronousSocketChannel.open();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        latch = <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        socketChannel.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="built_in">this</span>.host,<span class="built_in">this</span>.port),<span class="built_in">this</span>,<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socketChannel.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Void result, AsynTimeClientHandler attachment)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] req = <span class="string">&quot;AIO_SYNC_SERVERTIME&quot;</span>.getBytes();</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">reqbuffer</span> <span class="operator">=</span> ByteBuffer.allocate(req.length);</span><br><span class="line">        reqbuffer.put(req);</span><br><span class="line">        reqbuffer.flip();</span><br><span class="line">        socketChannel.write(reqbuffer, reqbuffer, <span class="keyword">new</span> <span class="title class_">CompletionHandler</span>&lt;Integer, ByteBuffer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer result, ByteBuffer buffer)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (buffer.hasRemaining())&#123;</span><br><span class="line">                    socketChannel.write(buffer,buffer,<span class="built_in">this</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">ByteBuffer</span> <span class="variable">readbuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                    socketChannel.read(readbuffer, readbuffer, <span class="keyword">new</span> <span class="title class_">CompletionHandler</span>&lt;Integer, ByteBuffer&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(Integer result, ByteBuffer attachment)</span> &#123;</span><br><span class="line">                            attachment.flip();</span><br><span class="line">                            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[attachment.remaining()];</span><br><span class="line">                            attachment.get(bytes);</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                                System.out.println(<span class="string">&quot;NOW is : &quot;</span>+ response);</span><br><span class="line">                                latch.countDown();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                socketChannel.close();</span><br><span class="line">                                latch.countDown();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socketChannel.close();</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">failed</span><span class="params">(Throwable exc, AsynTimeClientHandler attachment)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socketChannel.close();</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>客户端例程中，通过新建一个线程来创建一个异步时间服务器连接对象，实际项目中无需独立线程来创建异步连接对象的。</p>
<ol>
<li><p>在<code>AsynTimeClientHandler</code> 的源码中，在构造方法中创建了 <code>AsynchronousSocketChannel</code> 对象，在 <code>run()</code> 方法中，<code>CountDownLatch</code> 进行等待，防止异步操作没有执行完成线程就退出。同时 通过 <code>AsynchronousSocketChannel</code> 对象调用<code>connect</code> 方法发起异步操作，根据服务端地址和端口连接服务端，该方法除地址外的另外两个参数：</p>
<ul>
<li><p>A attachment：<code>AsynchronousSocketChannel</code>的附件，用于回调通知时作为入参被传递，调用者可以自定义。</p>
</li>
<li><p>CompletionHandler&lt;Void, ? super A&gt; handler : 异步操作回调通知接口，由调用者实现。</p>
<p>例程中两个参数都使用了 AsynTimeClientHandler 本身，因为它也实现了 CompletionHandler 接口。</p>
</li>
</ul>
</li>
<li><p>异步连接成功后的方法回调是 <code>completed()</code> ，在该方法中我们可以创建请求体消息，把字符串消息编码成字节数组，然后复制到 ByteBuffer ，最后调用 <code>AsynchronousSocketChannel</code> 的 <code>write</code> 方法发送到服务端，<code>write()</code> 的方法参数与服务端类似，此处就不展开细说。</p>
</li>
<li><p>客户端在读取服务端应答的消息时是通过 <code>AsynchronousSocketChannel</code> 的 <code>read()</code> 方法，其方法入参也和服务端一样。</p>
</li>
</ol>
<h5 id="AIO-的线程堆栈"><a href="#AIO-的线程堆栈" class="headerlink" title="AIO 的线程堆栈"></a>AIO 的线程堆栈</h5><p>通过打印线程堆栈信息可知，JDK 底层通过线程池 <code>ThreadPoolExecutor</code> 来执行回调通知，异步回调通知由 <code>cun.nio.AsynchronousChannelGroupImpl</code> 实现，通过层层调用，最终回调 <code>com.phei.netty.aio.AsynTimeClientHandler$1.completed</code> 方法，完成回调通知。</p>
<h4 id="名词概念澄清"><a href="#名词概念澄清" class="headerlink" title="名词概念澄清"></a>名词概念澄清</h4><h5 id="1、异步阻塞I-O"><a href="#1、异步阻塞I-O" class="headerlink" title="1、异步阻塞I&#x2F;O"></a>1、异步阻塞I&#x2F;O</h5><p>不少人喜欢把 JDK1.4 提供的NIO模型叫做异步非阻塞 I&#x2F;O，如果严格按照 UNIX 网络编程模型和 JDK的实现区分，实际上只能被称为非阻塞I&#x2F;O，不能叫异步非阻塞I&#x2F;O。在 JDK 1.4和 JDK 1.5 update 10之前的版本，JDK 的 Selector 是基于 select&#x2F;pull 模型实现，是基于 I&#x2F;O 复用技术的非阻塞 I&#x2F;O，在 JDK1.5 update 10 和 Linux core2.6以上版本，Sun 优化了 Selector 的实现，底层使用 epoll 替换了 select&#x2F;pull ，上层 API 并没有改变，属于 JDK NIO 的性能优化，没有改变 I&#x2F;O模型，依然是非阻塞 I&#x2F;O。</p>
<p>直到 JDK 1.7的出现，提供的NIO2.0 新增了异步套接字通道，才真正的实现了异步 I&#x2F;O ，也叫AIO。</p>
<h5 id="2、多路复用器-Selector"><a href="#2、多路复用器-Selector" class="headerlink" title="2、多路复用器 Selector"></a>2、多路复用器 Selector</h5><p>对于Selector，有的人叫多路复用器，有的叫选择器，实质是同一东西的不同叫法。</p>
<p>Java NIO 的实现关键是多路复用 I&#x2F;O 技术，其核心就是通过 Selector 来轮询注册在其上的 Channel，当发现有一个或者多个Channel  处于就绪状态，就会从阻塞状态返回就绪的Channel 集合，进行 I&#x2F;O 操作。</p>
<h5 id="3、伪异步-I-O"><a href="#3、伪异步-I-O" class="headerlink" title="3、伪异步 I&#x2F;O"></a>3、伪异步 I&#x2F;O</h5><p>伪异步I&#x2F;O 概念来源于实践，在没有 NIO 模型之前，为解决 Tomcat 通信线程同步 I&#x2F;O 导致业务线程被挂住问题，使用线程池和消息队列来隔离 I&#x2F;O 线程和业务线程，这样就业务线程不会被 I&#x2F;O 线程阻塞。</p>
<h4 id="4种-I-O-的对比"><a href="#4种-I-O-的对比" class="headerlink" title="4种 I&#x2F;O 的对比"></a>4种 I&#x2F;O 的对比</h4><h5 id="为什么不选择原生JAVA-的NIO编程"><a href="#为什么不选择原生JAVA-的NIO编程" class="headerlink" title="为什么不选择原生JAVA 的NIO编程"></a>为什么不选择原生JAVA 的NIO编程</h5><ol>
<li>NIO 类库和API 复杂，使用麻烦，需要熟练掌握 Selector、ServerSocketChannel、SocketChannel、ByteBuffer 等。</li>
<li>需要具备其他额外技能做铺垫，如 Java 多线程编程，因为 NIO 编程涉及到 Rector 模式，需要对多线程和网络编程非常熟悉，才能写出高质量的NIO 程序。</li>
<li>可靠性能力补齐，工作量和难度都非常大，如客户端断连和重连、网络闪断、半包读写、失败缓存、网络拥塞和异常码流处理等问题。</li>
<li>Java NIO 臭名昭著的 epoll bug，它会导致 Selector 空轮询，最终导致 CPU 100%，虽然官方声称 JDK 1.6 版已修复，但在 JDK 1.7依然存在，只是bug 发生的概率降低了。</li>
</ol>
<h5 id="为什么选择-Netty"><a href="#为什么选择-Netty" class="headerlink" title="为什么选择 Netty"></a>为什么选择 Netty</h5><p>Netty的优点如下：</p>
<ol>
<li>API 使用简单，开发门槛较低</li>
<li>功能强大，预置了多种编解码功能，支持多种主流协议</li>
<li>定制能力强，可通过 ChannelHandler 对通信框架进行灵活的扩展。</li>
<li>性能高，通过与其他业界的主流 NIO 框架对比，Netty 的综合性能最高。</li>
<li>成熟、稳定，Netty 已经修复所有已经发现的 JDK NIO BUG，业务人员无再为 NIO 的 BUG 而烦恼。</li>
<li>社区活跃，版本迭代周期短，发现BUG 可以及时修复，同时更多的新功能会被加入。</li>
<li>经历了大规模的商业应用考验，质量得到验证。</li>
</ol>
<h3 id="三、Netty-入门应用"><a href="#三、Netty-入门应用" class="headerlink" title="三、Netty 入门应用"></a>三、Netty 入门应用</h3><h4 id="3-1、Netty-时间服务器服务端"><a href="#3-1、Netty-时间服务器服务端" class="headerlink" title="3.1、Netty 时间服务器服务端"></a>3.1、Netty 时间服务器服务端</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyTimeServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChildChannelHandler</span>());</span><br><span class="line">            <span class="comment">// 绑定端口，等待同步成功</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> serverBootstrap.bind(port).sync();</span><br><span class="line">            <span class="comment">// 等待服务端监听端口关闭</span></span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ChildChannelHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">TimeServerHandler</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">TimeServerHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[buf.readableBytes()];</span><br><span class="line">            buf.readBytes(bytes);</span><br><span class="line">            <span class="type">String</span> <span class="variable">reqBody</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;The time Server receive the reqesut is : &quot;</span>+reqBody);</span><br><span class="line">            <span class="type">String</span> <span class="variable">currentTime</span> <span class="operator">=</span> <span class="string">&quot;NETTY_SEVER_TIME&quot;</span>.equals(reqBody)? LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)):<span class="string">&quot;BAD REQUEST&quot;</span>;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">resp</span> <span class="operator">=</span> Unpooled.copiedBuffer(currentTime.getBytes());</span><br><span class="line">            ctx.write(resp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            ctx.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;channelReadComplete....&quot;</span>);</span><br><span class="line">            ctx.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span>&#123;</span><br><span class="line">        <span class="type">NettyTimeServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyTimeServer</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            server.bind(<span class="number">8082</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Netty 创建服务端的步骤主要分为以下几个：</p>
<ol>
<li>通过<code>NioEventLoopGroup</code> 创建 <code>EventLoopGroup </code> 线程组实例，它包含了一组NIO线程组，专门用于网络事件的处理，实际上就是 <code>Reactor</code> 线程组。创建两个的原因是：一个用于服务端接收客户端的连接，另一个用于<code>SocketChannel</code> 网络读写。</li>
<li>创建 <code>ServerBootStrap</code> 对象，其作用是启动 NIO 服务端的辅助启动类，目的是降低服务端的开发复杂度。通过它可以设置 <code>EventLoopGroup</code> 线程组，配置TCP 参数，设置创建channl 为<code>NioServerSocketChannel</code> 类，最后绑定 I&#x2F;O 事件处理类 <code>ChildChannelHandler</code> ，主要用于处理网络 I&#x2F;O 事件处理，如记录日志，消息编解码等。</li>
<li>配置完成后，通过<code>ServerBootStrap</code> 的实例调用<code>bind()</code> 方法绑定监听端口，接着，调用同步阻塞方法<code>sync()</code> 等待绑定操作完成。最后会返回一个 <code>ChannelFuture</code> 的实例，类似于<code>java.util.concurrent.Future</code> ，用于异步操作的回调通知。</li>
<li>调用 <code>future.channel().closeFuture().sync()</code> 方法进行阻塞是为了等待服务端链路关闭后才退出main 函数。</li>
<li>在 finally 中关闭 EventLoopGroup 线程组释放资源。</li>
<li><code>TimeServerHandler</code>  继承自 <code>ChannelHandlerAdapter</code> ，用于对网络事件进行读写操作。关键方法是<code>channelRead、channelReadComplete、exceptionCaught</code><ul>
<li>channelRead 方法主要是接收客户端消息，其有两个入参，一个 <code>ChannelHandlerContext</code> ，可以通过其 write 方法异步发送消息响应给客户端；而另一 Object 类型的msg 参数则为接收到的请求信息，可以被转换为 ByteBuf ，ByteBuf 类似于 JDK 中的 ByteBuffer ，不过它提供了更加灵活和强大的功能。可以公共 ByteBuf 的 readableBytes 获取缓冲区中的可读字节数。</li>
<li>channelReadComplete 方法中，调用了 ChannelHandlerContext 的 flush 方法，其作用是将消息发送队列中的消息写入到 <code>SocketChannel </code> 中发送给对方。从性能角度考虑，为了防止频繁地唤醒 Selector 进行消息发送，Netty 的 write 方法并不直接将消息写入到 SocketChannel 中，调用 write 方法只是把待发送的消息放到发送缓冲数组中，再通过调用flush 方法，将缓冲区中的消息全部写入到 SocketChannel 中。</li>
<li>exceptionCaught 是异常处理方法，出现异常是通过调用 ChannelHandlerContext 的 close 方法及时关闭释放资源。</li>
</ul>
</li>
</ol>
<h4 id="3-2、Netty-时间服务器客户端"><a href="#3-2、Netty-时间服务器客户端" class="headerlink" title="3.2、Netty 时间服务器客户端"></a>3.2、Netty 时间服务器客户端</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyTimeClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(String address, <span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 配置客户端 NIO 线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">clientGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(clientGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY,<span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">TimeClientHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">// 发送异步连接操作</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(address,port).sync();</span><br><span class="line">            <span class="comment">// 等待客户端链路关闭</span></span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            clientGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeClientHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">byte</span>[] req = <span class="string">&quot;NETTY_SEVER_TIME&quot;</span>.getBytes();</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.buffer(req.length);</span><br><span class="line">            buf.writeBytes(req);</span><br><span class="line">            ctx.writeAndFlush(buf);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">            <span class="type">byte</span>[] resp = <span class="keyword">new</span> <span class="title class_">byte</span>[buf.readableBytes()];</span><br><span class="line">            buf.readBytes(resp);</span><br><span class="line">            <span class="type">String</span> <span class="variable">respStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(resp,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;NettyTimeClient receive server response time is：&quot;</span>+respStr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            ctx.flush();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">// 释放资源</span></span><br><span class="line">            ctx.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">NettyTimeClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyTimeClient</span>();</span><br><span class="line">        client.connect(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8082</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比起创建服务端，创建Netty 客户端更加简单</p>
<ol>
<li>在connect 方法中，首先通过<code>NioEventLoopGroup</code>创建 <code>EventLoopGroup</code> 的实例，处理客户端的网络 I&#x2F;O 线程组，然后创建客户端的辅助启动类 <code>Bootstrap</code>的实例并进行配置。客户端使用的 Channel 为 <code>NioSocketChannel</code> ，最后添加绑定 ChannelHandler 处理网络 I&#x2F;O 事件。</li>
<li><code>TimeClientHandler</code>  中有三个重要的方法，分别为：<code>channelActive、channelReadComplete、exceptionCaught</code> ，后两个就不展开说了，与上面的服务端相似，主要说下 <code>channelActive</code> 方法，该方法主要是在客户端与服务端TCP 通信链路建立后，Netty 的 NIO 线程会调用该方法。</li>
</ol>
<h3 id="四、TCP-粘包-拆包问题的解决之道"><a href="#四、TCP-粘包-拆包问题的解决之道" class="headerlink" title="四、TCP 粘包&#x2F;拆包问题的解决之道"></a>四、TCP 粘包&#x2F;拆包问题的解决之道</h3><h4 id="4-1、TCP-粘包-拆包"><a href="#4-1、TCP-粘包-拆包" class="headerlink" title="4.1、TCP 粘包&#x2F;拆包"></a>4.1、TCP 粘包&#x2F;拆包</h4><p>TCP 是个 “流” 协议，所谓流，就是没有界限的一串数据。TCP 并不了解上层业务数据的具体含义，它会根据缓冲区的实际情况进行包的划分，所以在业务上任务，一个完整的包可能会被拆分成多个包进行发送，也有可能把多个小的包封装成一个大的数据包发送，这就是所谓的 TCP 粘包和拆包问题。</p>
<h5 id="4-1-1-TCP-粘包-拆包问题说明"><a href="#4-1-1-TCP-粘包-拆包问题说明" class="headerlink" title="4.1.1 TCP 粘包&#x2F;拆包问题说明"></a>4.1.1 TCP 粘包&#x2F;拆包问题说明</h5><p><img src="/../assets/blogImg/Netty/4-1.png" alt="4-1"></p>
<p>假设客户端分别发送了两个数据包 D1 和 D2 个服务端，由于服务端一次读到的字节数是不确定的，可能存在以下 4 种情况。</p>
<ul>
<li>服务端分两次读取到了两个独立的数据包，分别是 D1 和 D2，没有发生粘包和拆包问题。</li>
<li>服务端一次读到了两个数据包，D1 和 D2 粘在一起，被称为 TCP 粘包。</li>
<li>服务端分两次读到了两个数据包，第一次读取到了完整的 D1 包和 D2 包的部分内容，第二次读到了 D2 包的剩余内容，这被称为 TCP 拆包。</li>
<li>服务端分两次读到了两个数据包，第一次读取到 D1包的部分内容，第二次读到了 D1包剩余的内容以及完整的D2 包内容。</li>
</ul>
<p>如果服务端 TCP 接收滑窗非常小，而数据包 D1 和 D2 比较大，有可能会发生第5种情况，服务端要分多次才能将 D1 和 D 包完全接收，期间发生多次拆包。</p>
<h5 id="4-1-2、TCP-粘包拆包发生的原因"><a href="#4-1-2、TCP-粘包拆包发生的原因" class="headerlink" title="4.1.2、TCP 粘包拆包发生的原因"></a>4.1.2、TCP 粘包拆包发生的原因</h5><ol>
<li>应用程序 write 写入的字节大小大于套接口发送缓冲区大小；</li>
<li>进行MSS大小的 TCP 分段；</li>
<li>以太网帧的 payload 大于 MTU 进行 IP 分片。</li>
</ol>
<p><img src="/../assets/blogImg/Netty/4-2.png" alt="4-2"></p>
<h5 id="4-1-3、粘包问题的解决策略"><a href="#4-1-3、粘包问题的解决策略" class="headerlink" title="4.1.3、粘包问题的解决策略"></a>4.1.3、粘包问题的解决策略</h5><p>由于底层 TCP 无法理解上层的业务数据，所以在底层无法保证数据包不被拆分和重组，这个问题只能通过上层的应用协议栈设计来解决，主流协议的解决方案如下：</p>
<ol>
<li>消息定长，如每个报文的大小固定为200个字节，如果不够，空位补空格；</li>
<li>在包尾增加回车换行进行分割，如 FTP 协议；</li>
<li>将消息分为消息头和消息体，消息头包含表示消息总长度（或者消息体的长度）的字段，通常设计思路为消息头的第一个字段使用 int32 来表示消息的总长度；</li>
<li>更为复杂的应用层协议。</li>
</ol>
<h4 id="4-2、未考虑-TCP-粘包导致功能异常的案例"><a href="#4-2、未考虑-TCP-粘包导致功能异常的案例" class="headerlink" title="4.2、未考虑 TCP 粘包导致功能异常的案例"></a>4.2、未考虑 TCP 粘包导致功能异常的案例</h4><p>通过模拟故障场景，然后看看如何正确使用 Netty 半包解码器来解决 TCP 的粘包和拆包问题。</p>
<h5 id="4-2-1、NettyTimeServer改造"><a href="#4-2-1、NettyTimeServer改造" class="headerlink" title="4.2.1、NettyTimeServer改造"></a>4.2.1、NettyTimeServer改造</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitorTimeServerHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> counter;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[buf.readableBytes()];</span><br><span class="line">        buf.readBytes(bytes);</span><br><span class="line">        <span class="type">String</span> <span class="variable">reqBody</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="string">&quot;UTF-8&quot;</span>).substring(<span class="number">0</span>,bytes.length-System.getProperty(<span class="string">&quot;line.separator&quot;</span>).length());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;The time Server receive the reqesut is : &quot;</span>+reqBody+<span class="string">&quot;; the counter is: &quot;</span>+ ++counter);</span><br><span class="line">        <span class="type">String</span> <span class="variable">currentTime</span> <span class="operator">=</span> <span class="string">&quot;NETTY_SEVER_TIME&quot;</span>.equals(reqBody)? LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)):<span class="string">&quot;BAD REQUEST&quot;</span>;</span><br><span class="line">        currentTime = currentTime + System.getProperty(<span class="string">&quot;line.separator&quot;</span>);</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">resp</span> <span class="operator">=</span> Unpooled.copiedBuffer(currentTime.getBytes());</span><br><span class="line">        ctx.writeAndFlush(resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;channelReadComplete....&quot;</span>);</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对服务端的改造是，增加一个全局 int counter 变量，每接收到一次消息就计数一次，然后发送应答给客户端。按设计服务端收到的消息数与客户端发送的消息数应该保持一致。</p>
<h5 id="4-2-2、NettyTimeClient-改造"><a href="#4-2-2、NettyTimeClient-改造" class="headerlink" title="4.2.2、NettyTimeClient 改造"></a>4.2.2、NettyTimeClient 改造</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitorTimeClientHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> counter;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] req = (<span class="string">&quot;NETTY_SEVER_TIME&quot;</span>+System.getProperty(<span class="string">&quot;line.separator&quot;</span>)).getBytes();</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">            buf = Unpooled.buffer(req.length);</span><br><span class="line">            buf.writeBytes(req);</span><br><span class="line">            ctx.writeAndFlush(buf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">        <span class="type">byte</span>[] resp = <span class="keyword">new</span> <span class="title class_">byte</span>[buf.readableBytes()];</span><br><span class="line">        buf.readBytes(resp);</span><br><span class="line">        <span class="type">String</span> <span class="variable">respStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(resp,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;NettyTimeClient receive server response time is：&quot;</span>+respStr + <span class="string">&quot;; the counter is: &quot;</span>+ ++counter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 释放资源</span></span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对客户端的改造是，建立连接后，循环发送消息100次，每发送一条消息就刷新一次，保证每条消息都被写入到Channel 中，按设计服务端应该收到客户端的100条查询指令。同时增加一个全局的 countor，每收到一次服务端的应答消息就计数一次，同样地，应该是打印100 次服务端响应的时间消息。</p>
<h5 id="4-2-3、运行结果"><a href="#4-2-3、运行结果" class="headerlink" title="4.2.3、运行结果"></a>4.2.3、运行结果</h5><p><strong>服务端运行结果如下</strong></p>
<p><img src="/../assets/blogImg/Netty/4-2-3.png" alt="4-2-3"></p>
<p> 从服务端的运行结果可以看到，服务端总共只收到两条消息，第一条包含了57条 NETTY_SERVER_TIME 指令，第二条包含43 条指令，总数是100条指令。而与我们期待的结果，100条消息的结果有偏差，这说明 TCP 发生了粘包。</p>
<p><strong>客户端运行结果如下</strong></p>
<p><img src="/../assets/blogImg/Netty/4-2-3.1.png" alt="4-2-3.1"></p>
<p>在设计上，客户端应当收到服务端100条时间消息的响应，但是实际上只收到了1条消息响应。不难理解，结合上面的服务端运行结果可知，因为服务端只收到了两条消息请求指令，由于请求条件不满足指定的指令，所以服务端返回了2条 “ BAD REQUEST ”，而实际上客户端只收到了一条包含了2条 “BAD REQUEST” 的消息，说明 服务端响应的消息也发生了粘包。</p>
<h4 id="4-3、利用-LineBasedFrameDecoder-解决-TCP-粘包问题"><a href="#4-3、利用-LineBasedFrameDecoder-解决-TCP-粘包问题" class="headerlink" title="4.3、利用 LineBasedFrameDecoder 解决 TCP 粘包问题"></a>4.3、利用 LineBasedFrameDecoder 解决 TCP 粘包问题</h4><h5 id="4-3-1、支持TCP-粘包的TimeServer"><a href="#4-3-1、支持TCP-粘包的TimeServer" class="headerlink" title="4.3.1、支持TCP 粘包的TimeServer"></a>4.3.1、支持TCP 粘包的TimeServer</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoStickyNettyTimeServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LineBasedFrameDecoder</span>(<span class="number">1024</span>));</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">NoStickyServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">// 绑定端口，等待同步成功</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> serverBootstrap.bind(port).sync();</span><br><span class="line">            <span class="comment">// 等待服务端监听端口关闭</span></span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NoStickyServerHandler 负责网络 I/O 事件处理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoStickyServerHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> counter;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">req</span> <span class="operator">=</span> (String) msg;</span><br><span class="line">        System.out.println(<span class="string">&quot;The time Server receive the reqesut is : &quot;</span>+req+<span class="string">&quot;; the counter is: &quot;</span>+ ++counter);</span><br><span class="line">        <span class="type">String</span> <span class="variable">currentTime</span> <span class="operator">=</span> <span class="string">&quot;NETTY_SEVER_TIME&quot;</span>.equals(req)? LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)):<span class="string">&quot;BAD REQUEST&quot;</span>;</span><br><span class="line">        currentTime = currentTime + System.getProperty(<span class="string">&quot;line.separator&quot;</span>);</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">resp</span> <span class="operator">=</span> Unpooled.copiedBuffer(currentTime.getBytes());</span><br><span class="line">        ctx.writeAndFlush(resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;channelReadComplete....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在服务端的代码中 <code>ChannelInitializer</code> 的<code> initChannel</code> 方法，增加 <code>LineBasedFrameDecoder、StringDecoder </code> 两个解码器。而在 <code>NoStickyServerHandler</code> 中，可以直接接收 客户端的消息 msg，不需要处理半包读写，以及消息编码问题。</p>
<h5 id="4-3-2、支持TCP-粘包的TimeClient"><a href="#4-3-2、支持TCP-粘包的TimeClient" class="headerlink" title="4.3.2、支持TCP 粘包的TimeClient"></a>4.3.2、支持TCP 粘包的TimeClient</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoStickyNettyTimeClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(String address, <span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 配置客户端 NIO 线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">clientGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(clientGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY,<span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">LineBasedFrameDecoder</span>(<span class="number">1024</span>));</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">NoStickyClinetHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">// 发送异步连接操作</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(address,port).sync();</span><br><span class="line">            <span class="comment">// 等待客户端链路关闭</span></span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            clientGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NoStickyClinetHandler 负责客户端网络 I/O 事件处理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoStickyClinetHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> counter;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] req = (<span class="string">&quot;NETTY_SEVER_TIME&quot;</span>+System.getProperty(<span class="string">&quot;line.separator&quot;</span>)).getBytes();</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">            buf = Unpooled.buffer(req.length);</span><br><span class="line">            buf.writeBytes(req);</span><br><span class="line">            ctx.writeAndFlush(buf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">respStr</span> <span class="operator">=</span> (String) msg;</span><br><span class="line">        System.out.println(<span class="string">&quot;NettyTimeClient receive server response time is：&quot;</span>+respStr + <span class="string">&quot;; the counter is: &quot;</span>+ ++counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同样地，客户端也增加 <code>LineBasedFrameDecoder、StringDecoder </code> 两个解码器</p>
<p><strong>最终的运行结果：</strong></p>
<p>最终的运行结果是符合预期，服务端和客户端均分别收到了100请求消息和响应消息。</p>
<h5 id="4-3-3、LineBasedFrameDecoder-和-StringDecoder-的原理分析"><a href="#4-3-3、LineBasedFrameDecoder-和-StringDecoder-的原理分析" class="headerlink" title="4.3.3、LineBasedFrameDecoder 和 StringDecoder 的原理分析"></a>4.3.3、LineBasedFrameDecoder 和 StringDecoder 的原理分析</h5><p><code>LineBasedFrameDecoder</code> 的工作原理是依次变量 ByteBuf 的可读字节，判断是否存在 “\n”、“\r\n”，如果有，则以此位置结束，从可读索引到结束位置区间的字节就组成了一行。他是以换行符作为结束标志的解码器，支持携带结束符或不携带结束符两种解码方式，同时支持配置单行最大长度。如果连续读取到最大长度仍然没有发现换行符，则抛出异常，同时忽略之前读到的异常码流。</p>
<p><code>StringDecoder</code> 的功能很简单，就是将接收到的对象转换成字符，并调用后面的 handler。<code>LineBasedFrameDecoder</code>+ <code>StringDecoder</code> 组合就是按行切换文本解码器，它被设计用来支持 TCP 的粘包和拆包。</p>
<h3 id="五、分隔符和定长解码器的应用"><a href="#五、分隔符和定长解码器的应用" class="headerlink" title="五、分隔符和定长解码器的应用"></a>五、分隔符和定长解码器的应用</h3><p>TCP 以流的方式传输数据，上层应用协议为了方便对消息区分，采用如下4种方式：</p>
<ol>
<li>消息为固定长度，累计读取到的长度总和为定长 LEN 的报文后，就认为读取到一个完整的消息；将计数器复位，重新开始下一个数据报。</li>
<li>将回车换行符作为消息结束位置，如FTP 协议，这种方式在文本协议应用广泛</li>
<li>将特殊的分隔符作为消息的结束标志，回车换行就是一种特殊的结束分隔符。</li>
<li>通过在消息头定义长度字段来标识消息的总长度。</li>
</ol>
<p>在 Netty 中，对上面4种应用做了统一抽象，提供了 4 种解码器来解决对应的问题。</p>
<h4 id="5-1、DelimiterBasedFrameDecoder-应用开发"><a href="#5-1、DelimiterBasedFrameDecoder-应用开发" class="headerlink" title="5.1、DelimiterBasedFrameDecoder 应用开发"></a>5.1、DelimiterBasedFrameDecoder 应用开发</h4><p>使用 <code>DelimiterBasedFrameDecoder </code> 可以自动完成以分隔符作为码流结束标识的消息解码。</p>
<h5 id="5-1-1、DelimiterBasedFrameDecoder-服务端代码"><a href="#5-1-1、DelimiterBasedFrameDecoder-服务端代码" class="headerlink" title="5.1.1、DelimiterBasedFrameDecoder 服务端代码"></a>5.1.1、DelimiterBasedFrameDecoder 服务端代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 初始化服务端启动工具</span></span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.channel(NioServerSocketChannel.class)</span><br><span class="line">                    <span class="comment">// 临时存放已完成三次握手的请求的队列的最大长度。</span></span><br><span class="line">                    <span class="comment">// 如果未设置或所设置的值小于1，Java将使用默认值50。</span></span><br><span class="line">                    <span class="comment">// 如果大于队列的最大长度，请求会被拒绝</span></span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                    .group(bossGroup,workerGroup)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel serverChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">ByteBuf</span> <span class="variable">delimiter</span> <span class="operator">=</span> Unpooled.copiedBuffer(<span class="string">&quot;$_&quot;</span>.getBytes());</span><br><span class="line">                            serverChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">DelimiterBasedFrameDecoder</span>(<span class="number">1024</span>,delimiter));</span><br><span class="line">                            serverChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line">                            serverChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">EchoServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">// 绑定端口，同步等待</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> serverBootstrap.bind(port).sync();</span><br><span class="line">            <span class="comment">// 等待服务端监听绑定端口关闭</span></span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 退出线程组</span></span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// EchoServerHandler 处理服务端网络 I/O 事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoServerHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> counter;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">req</span> <span class="operator">=</span> (String) msg;</span><br><span class="line">        System.out.println(<span class="string">&quot;This is &quot;</span>+ ++counter+<span class="string">&quot; times The EchoServer receive msg is: [ &quot;</span>+req+<span class="string">&quot; ]&quot;</span>);</span><br><span class="line">        <span class="comment">// 因为 DelimiterBasedFrameDecoder 过滤了分隔符，所以返回给客户端时，需要在消息尾部拼接分隔符 $_</span></span><br><span class="line">        req = req+<span class="string">&quot; I&#x27;m Server!$_&quot;</span>;</span><br><span class="line">        ctx.writeAndFlush(Unpooled.copiedBuffer(req.getBytes()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>值服务端代码中，主要是创建 <code>DelimiterBasedFrameDecoder </code> 对象并增加到 <code>ChannelPipeline</code> 中。<code>DelimiterBasedFrameDecoder</code> 有多个构造方法，例程中，我们传递了两个参数，一个为 1024，表示单条消息最大长度，当达到最大长度仍然没有查找到分隔符，就会抛出 <code>TooLongFrameException</code> 异常，防止由于异常码流缺失分隔符导致内存溢出，这是 Netty 解码器可靠性保护；第二个参数为分隔符的缓冲对象。</p>
<h5 id="5-1-2、DelimiterBasedFrameDecoder-客户端代码"><a href="#5-1-2、DelimiterBasedFrameDecoder-客户端代码" class="headerlink" title="5.1.2、DelimiterBasedFrameDecoder 客户端代码"></a>5.1.2、DelimiterBasedFrameDecoder 客户端代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(String host, <span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化 NIO 线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">clientGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 初始化 NIO 客户端辅助工具类</span></span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(clientGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY,<span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">ByteBuf</span> <span class="variable">delimiter</span> <span class="operator">=</span> Unpooled.copiedBuffer(<span class="string">&quot;$_&quot;</span>.getBytes());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">DelimiterBasedFrameDecoder</span>(<span class="number">1024</span>*<span class="number">3</span>,delimiter));</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">EchoClientHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发起异步连接</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host,port)).sync();</span><br><span class="line">            <span class="comment">// 等待客户端关闭连接</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            clientGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 处理客户端网络 I/O 事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoClientHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> counter;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Hello,Sinin! welcome to netty world!$_&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</span><br><span class="line">            ctx.writeAndFlush(Unpooled.copiedBuffer(msg.getBytes()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;This is &quot;</span>+ ++counter+<span class="string">&quot; time client receive the message is: &quot;</span>+msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>与服务端一样，创建 <code>DelimiterBasedFrameDecoder </code> 对象并增加到 <code>ChannelPipeline</code> 中。然后循环发送消息到服务端。</p>
<p>最后运行结果如下：</p>
<p><img src="/../assets/blogImg/Netty%5C5-1.png" alt="5-1"></p>
<p><img src="/../assets/blogImg/Netty/5-2.png" alt="5-2"></p>
<h4 id="5-2、FixedLengthFrameDecoder-应用开发"><a href="#5-2、FixedLengthFrameDecoder-应用开发" class="headerlink" title="5.2、FixedLengthFrameDecoder 应用开发"></a>5.2、FixedLengthFrameDecoder 应用开发</h4><p>FixedLengthFrameDecoder 是固定长度的解码器，它能够按指定长度对消息进行解码，开发者不需要考虑 TCP 粘包&#x2F;拆包问题。</p>
<h5 id="5-2-1-、FixedLengthFrameDecoder-服务端"><a href="#5-2-1-、FixedLengthFrameDecoder-服务端" class="headerlink" title="5.2.1 、FixedLengthFrameDecoder 服务端"></a>5.2.1 、FixedLengthFrameDecoder 服务端</h5><p>在服务端的 ChannelPipeline 中增加 <code>FixedLengthFrameDecoder </code> 长度为 20 ，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FixedLenFrameServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 初始化服务端启动工具</span></span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.channel(NioServerSocketChannel.class)</span><br><span class="line">                    <span class="comment">// 临时存放已完成三次握手的请求的队列的最大长度。</span></span><br><span class="line">                    <span class="comment">// 如果未设置或所设置的值小于1，Java将使用默认值50。</span></span><br><span class="line">                    <span class="comment">// 如果大于队列的最大长度，请求会被拒绝</span></span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                    .group(bossGroup,workerGroup)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel serverChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">ByteBuf</span> <span class="variable">delimiter</span> <span class="operator">=</span> Unpooled.copiedBuffer(<span class="string">&quot;$_&quot;</span>.getBytes());</span><br><span class="line">                            serverChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">FixedLengthFrameDecoder</span>(<span class="number">20</span>));</span><br><span class="line">                            serverChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>());</span><br><span class="line">                            serverChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">EchoServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">// 绑定端口，同步等待</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> serverBootstrap.bind(port).sync();</span><br><span class="line">            <span class="comment">// 等待服务端监听绑定端口关闭</span></span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 退出线程组</span></span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用固定长度解码器 <code>FixedLengthFrameDecoder </code> ， 无论一次接收到多少数据报，都会按照构造函数中设置的固定长度进行解码，如果是半包消息，会缓存半包消息等待下一个包到达后再进行拼包，直到读取到一个完整的包。</p>
<h5 id="5-2-2、使用-telnet-命令测试-FixedLenFrameServer-服务"><a href="#5-2-2、使用-telnet-命令测试-FixedLenFrameServer-服务" class="headerlink" title="5.2.2、使用 telnet 命令测试 FixedLenFrameServer 服务"></a>5.2.2、使用 telnet 命令测试 FixedLenFrameServer 服务</h5><p>同 cmd 打开命令窗口，输入<code>telnet localhost 8082 </code> 命令，连接 FixedLenFrameServer 服务。</p>
<p><img src="/../assets/blogImg/Netty/5-3.png" alt="5-3"></p>
<p>telnet 连接成功后通过<code>CTRL + ]</code>打开 设置界面，通过 <code>set localecho</code> 命令开启本地回显。</p>
<p><img src="/../assets/blogImg/Netty/5-4.png" alt="5-4"></p>
<p>输入如下内容</p>
<p><img src="/../assets/blogImg/Netty/5-5.png" alt="5-5"></p>
<p>服务端收到的内容，发现完全符合<code>FixedLengthFrameDecoder</code> 定长解码器按照20 个字节长度对请求消息进行截取。</p>
<p><img src="/../assets/blogImg/Netty/5-6.png" alt="5-6"></p>
<h3 id="六、编解码技术"><a href="#六、编解码技术" class="headerlink" title="六、编解码技术"></a>六、编解码技术</h3><p>基于Java 提供的对象输入&#x2F;输出流 ObjectInpuStream、ObjectOutputStream，可以直接把 Java 对象作为可存储的字节数组写入到文件，也可以传输到网络上。基于 JDK 默认的序列化机制可以避免操作底层的字节数组，从而提升开发效率。</p>
<p>Java 序列化对象的目的：</p>
<ul>
<li>网络传输</li>
<li>持久化对象</li>
</ul>
<p>**Java 对象编解码技术：**当进行远程跨进程调用时，需要把被传输的 Java 对象编码为字节数组或者ByteBuffer 对象。而当远程服务读取到字节数组或者ByteBuffer 对象时，需要将其解码为发送时的Java 对象。这被称为Java 对象编解码技术。</p>
<p>Java 序列化仅仅是Java 编解码技术中的一种，由于它的种种缺陷，衍生出多种编解码技术和框架。接下来会结合Netty 介绍业界主流的编解码技术和框架。</p>
<h4 id="6-1、Java-序列化的缺点"><a href="#6-1、Java-序列化的缺点" class="headerlink" title="6.1、Java 序列化的缺点"></a>6.1、Java 序列化的缺点</h4><p>Java 序列化从 JDK 1.1 就已经提供，不需要添加额外的类库，只需要继承 java.io.Serializable 接口并生成序列 ID 即可。</p>
<p>缺点：</p>
<ul>
<li>无法跨语言</li>
<li>序列化后码流太大</li>
<li>序列化性能太低</li>
</ul>
<h4 id="6-2、业界主流的编解码框架"><a href="#6-2、业界主流的编解码框架" class="headerlink" title="6.2、业界主流的编解码框架"></a>6.2、业界主流的编解码框架</h4><h5 id="6-2-1、Google-Protobuf-介绍"><a href="#6-2-1、Google-Protobuf-介绍" class="headerlink" title="6.2.1、Google Protobuf 介绍"></a>6.2.1、Google Protobuf 介绍</h5><p>Protobuf 全称 Protocol Buffers，由 Google 开源而来，它将数据结构以 .proto 文件进行描述，通过代码生成工具生成对应的数据结构 POJO 对象和 Protocol 相关的方法和属性。</p>
<p>它的特点如下：</p>
<ul>
<li>结构化数据存储格式（XML，JSON 等）</li>
<li>高效的编解码性能</li>
<li>语言无关、平台无关、扩展性好</li>
<li>官方支持 Java、C++ 和 Python</li>
</ul>
<p>利用数据描述文件对数据结构进行说明的有点如下：</p>
<ul>
<li>文本化的数据结构描述语言，可以实现语言和平台无关，适合异构系统间的集成。</li>
<li>通过标识字段的顺序，可以实现协议的向前兼容。</li>
<li>自动代码生成，不需要手工编写同样数据结构的 Java 和 C++ 版本。</li>
<li>方便后续的管理和维护。相比代码，结构化的代码和文档更易于维护。</li>
</ul>
<h5 id="6-2-2、Facebook-的-Thrift-介绍"><a href="#6-2-2、Facebook-的-Thrift-介绍" class="headerlink" title="6.2.2、Facebook 的 Thrift 介绍"></a>6.2.2、Facebook 的 Thrift 介绍</h5><p>Thrift 源于 Facebook，创造 Thrift 主要是解决各系统间大数据量的传输通信以及系统之间语言环境不同需要跨平台的特性。</p>
<p>能在多种语言之间通信，Thrift 可以作为高性能的通信中间件使用，他支持数据（对象）序列化和多种类型的RPC 服务。</p>
<p>Thrift 主要有5 部分组成：</p>
<ul>
<li>语言系统以及IDL编译器：负责由用户给定的 IDL 文件生成相应语言的接口代码；</li>
<li>TProtocol : RPC 的协议层，可选择多种不同的对象序列化方式，如 JSON 和 Binary；</li>
<li>TTransport : RPC 的传输层，同样可以选择不同的传输层实现，如 socket、NIO、MemoryBuffer 等；</li>
<li>TProcessor： 作为协议层和用户提供的服务实现之间的纽带，负责调用服务实现的接口；</li>
<li>TServer：聚合 TProtoco、TTransport 和 TProcessor 等对象。</li>
</ul>
<p>Thrift 支持的编解码方式：</p>
<ul>
<li>通用的二进制编解码</li>
<li>压缩二进制编解码</li>
<li>优化的可选字段压缩编解码</li>
</ul>
<h5 id="6-2-3、JBoss-Marshalling-介绍"><a href="#6-2-3、JBoss-Marshalling-介绍" class="headerlink" title="6.2.3、JBoss Marshalling 介绍"></a>6.2.3、JBoss Marshalling 介绍</h5><p>JBoss Marshalling 是一个 Java 对象的序列化 API 包，修正了 JDK 自带的序列化包的很多问题，但又保持和<code>java.io.Seriablizable</code>  接口的兼容。同时增加可调参数和附加特性，并且这些参数和特性可通过工厂类进行配置。</p>
<p>相比传统 Java 序列化机制，其优点如下：</p>
<ul>
<li>可插拔的类解析器，提供更加便捷的类加载定制策略，通过一个接口即可定制；</li>
<li>可插拔的对象替换技术，不需要通过继承方式；</li>
<li>可插拔的预定义类缓存表，可以减小序列化的字节数组长度，提升常用类型的对象序列化性能；</li>
<li>无需实现 <code>java.io.Seriablizable</code> 接口，即可实现 Java 序列化；</li>
<li>通过缓存技术提升对象的序列化性能。</li>
</ul>
<p>相比前两种编解码框架，JBoss Marshalling  更多是在 JBoss 内部使用。</p>
<h3 id="七、MessagePack-编解码"><a href="#七、MessagePack-编解码" class="headerlink" title="七、MessagePack 编解码"></a>七、MessagePack 编解码</h3><p>MessagePack 是一个高效的二进制序列化框架，它像 JSON 一样支持不同语言间的数据交换，但是性能更快，序列化后的码流更小。</p>
<p>特点：</p>
<ul>
<li>编解码高效，性能高。</li>
<li>序列化后的码流小。</li>
<li>支持跨语言。</li>
</ul>
<h4 id="7-1-MessagePack-编解码器开发"><a href="#7-1-MessagePack-编解码器开发" class="headerlink" title="7.1 MessagePack 编解码器开发"></a>7.1 MessagePack 编解码器开发</h4><p>Netty 的编解码框架可以非常方便地集成第三方序列化框架，或者自定义。</p>
<h5 id="7-1-1-MessagePack-编码器开发"><a href="#7-1-1-MessagePack-编码器开发" class="headerlink" title="7.1.1 MessagePack 编码器开发"></a>7.1.1 MessagePack 编码器开发</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 继承  MessageToByteEncoder 负责将 Object 对象编码为byte 数组。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsgpackEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToByteEncoder</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext channelHandlerContext, Object o, ByteBuf byteBuf)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">MessagePack</span> <span class="variable">msgpack</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessagePack</span>();</span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">byte</span>[] raw = msgpack.write(o);</span><br><span class="line">        byteBuf.writeBytes(raw);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="7-1-2-MessagePack-解码器开发"><a href="#7-1-2-MessagePack-解码器开发" class="headerlink" title="7.1.2 MessagePack 解码器开发"></a>7.1.2 MessagePack 解码器开发</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从 ByteBuf 中获取需要解密的字节数组，通过 MessagePack 的 read 方法反序列化为相应的对象。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsgpackDecoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageDecoder</span>&lt;ByteBuf&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext channelHandlerContext, ByteBuf byteBuf, List&lt;Object&gt; list)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] raw = <span class="keyword">new</span> <span class="title class_">byte</span>[byteBuf.readableBytes()];</span><br><span class="line">        byteBuf.getBytes(byteBuf.readerIndex(),raw,<span class="number">0</span>,raw.length);</span><br><span class="line">        <span class="type">MessagePack</span> <span class="variable">msgpack</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessagePack</span>();</span><br><span class="line">        list.add(msgpack.read(raw));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="7-1-3-集成Netty-功能测试"><a href="#7-1-3-集成Netty-功能测试" class="headerlink" title="7.1.3 集成Netty 功能测试"></a>7.1.3 集成Netty 功能测试</h5><p>Netty 服务端 代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsgpackServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;mesgpack Decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">MsgpackDecoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;mesgpack Encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">MsgpackEncoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">MsgpackServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">// 绑定端口同步等待</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> serverBootstrap.bind(port).sync();</span><br><span class="line">            <span class="comment">// 等待服务监听绑定端口关闭</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 负责网络事件消息处理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsgpackServerHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MsgpackServerHandler receive the msg : &quot;</span>+msg);</span><br><span class="line">        ctx.writeAndFlush(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>客户端代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsgpackClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(String address, <span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">loopGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(loopGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY,<span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;MessagePack Decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">MsgpackDecoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;MessagePack Encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">MsgpackEncoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">MsgpackClientHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(address,port)).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            loopGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 客户端网络事件消息处理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsgpackClientHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++)&#123;</span><br><span class="line">            <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfo</span>();</span><br><span class="line">            userInfo.setName(<span class="string">&quot;client=&gt;&quot;</span>+i);</span><br><span class="line">            userInfo.setAge(<span class="number">18</span>);</span><br><span class="line">            userInfo.setAddress(<span class="string">&quot;China&quot;</span>);</span><br><span class="line">            userInfo.setContact(<span class="string">&quot;86&quot;</span>);</span><br><span class="line">            ctx.write(userInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Client receive the msg : &quot;</span>+msg);</span><br><span class="line">        ctx.write(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：消息传输对象UserInfo 应该添加@Message 注解否则会在 MessageToByteEncoder 的 writeBytes 方法中报错</strong></p>
<h4 id="7-2、粘包-半包支持"><a href="#7-2、粘包-半包支持" class="headerlink" title="7.2、粘包&#x2F;半包支持"></a>7.2、粘包&#x2F;半包支持</h4><p>利用 Netty 提供的 <code>LengthFieldPrepender</code> 和 <code>LengthFieldBasedFrameDecoder</code> 结合MessagePack 编解码框架，实现对 TCP 粘包&#x2F;半包支持。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 初始化线程组</span></span><br><span class="line">    <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">    <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">        serverBootstrap.group(bossGroup,workerGroup)</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="comment">// 增加 LengthFieldBasedFrameDecoder 解码器处理粘包/拆包问题</span></span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="string">&quot;frameDecoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">LengthFieldBasedFrameDecoder</span>(<span class="number">65535</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">2</span>));</span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="string">&quot;MessagePack Decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">MsgpackDecoder</span>());</span><br><span class="line">                        <span class="comment">// 增加 LengthFieldPrepender 编码器处理粘包/拆包问题</span></span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="string">&quot;frameEnder&quot;</span>,<span class="keyword">new</span> <span class="title class_">LengthFieldPrepender</span>(<span class="number">2</span>));</span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="string">&quot;MessagePack Encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">MsgpackEncoder</span>());</span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">MsgpackServerHandler</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="comment">// 绑定端口同步等待</span></span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> serverBootstrap.bind(port).sync();</span><br><span class="line">        <span class="comment">// 等待服务监听绑定端口关闭</span></span><br><span class="line">        f.channel().closeFuture().sync();</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        bossGroup.shutdownGracefully();</span><br><span class="line">        workerGroup.shutdownGracefully();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合 MessagePack 编解码框架支持TCP 粘包&#x2F;拆包问题比较简单，只需在 <code>ChannelInitializer</code> 的 <code>initChannel</code> 中添加 <code>LengthFieldPrepender</code> 和 <code>LengthFieldBasedFrameDecoder</code>即可。同样地，在客户端也应添加相应的编解码器。</p>
<p>在 MessagePack 编码器<strong>之前（主要编解码器的添加顺序）</strong> 增加 <code>LengthFieldPrepender</code> ，它将在 ByteBuf 之前增加 2个字节的消息长度，其原理如下：</p>
<p><img src="/../assets/blogImg/Netty/7-1.png" alt="7-1"></p>
<p>在 MessagePack 解码器之前增加 <code>LengthFieldBasedFrameDecoder</code> ，用于处理半包消息，这样后面 MessagePack 收到的永远是整包消息。</p>
<p><img src="/../assets/blogImg/Netty/7-2.png" alt="7-2"></p>
<h3 id="八、Google-Protobuf-编解码"><a href="#八、Google-Protobuf-编解码" class="headerlink" title="八、Google Protobuf 编解码"></a>八、Google Protobuf 编解码</h3><p>Google Protobuf 在业界非常流行，很多项目选择的Protobuf 作为编解码框架，<strong>其优点如下：</strong></p>
<ul>
<li>在谷歌内部长期使用，产品成熟度高</li>
<li>跨语言，支持多种语言，包括 C++ 、Java 和 Python</li>
<li>编码后的消息更小，更加有利于传输和存储</li>
<li>编解码性能非常高</li>
<li>支持不同协议版本的向前兼容</li>
<li>支持定义可以选和必选字段</li>
</ul>
<h4 id="8-1、Protobuf-入门"><a href="#8-1、Protobuf-入门" class="headerlink" title="8.1、Protobuf 入门"></a>8.1、Protobuf 入门</h4><p>1、首先下载 Protobuf 编译器，下载地址为：<a href="https://github.com/protocolbuffers/protobuf/releases%EF%BC%8C%E9%80%89%E6%8B%A9%E5%AF%B9%E5%BA%94%E5%B9%B3%E5%8F%B0%E4%BB%A5%E5%8F%8A%E7%89%88%E6%9C%AC%E4%B8%8B%E8%BD%BD%EF%BC%8C%E7%84%B6%E5%90%8E%E8%A7%A3%E5%8E%8B%E5%88%B0%E7%89%B9%E5%AE%9A%E7%9A%84%E7%9B%AE%E5%BD%95%E3%80%82%E6%8A%8A%E4%B8%8B%E8%BD%BD%E7%9A%84%E6%96%87%E4%BB%B6%60protoc.exe">https://github.com/protocolbuffers/protobuf/releases，选择对应平台以及版本下载，然后解压到特定的目录。把下载的文件`protoc.exe</a> <code>所在的文件夹添加到环境变量。打开cmd命令行输入</code>protoc –version &#96; ，如果输出版本号，说明配置成功。</p>
<p><code>protoc.exe</code> 工具主要根据 .proto 文件生成代码。</p>
<p>2、创建 .proto 文件，定义数据结构（message 关键字后面跟上消息名称）</p>
<blockquote>
<p>syntax &#x3D; “”</p>
<p>message xxx {</p>
<p>&#x2F;&#x2F; 字段规则：required -&gt; 字段只能也必须出现 1 次</p>
<p>&#x2F;&#x2F; 字段规则：optional -&gt; 字段可出现 0 次或1次</p>
<p>&#x2F;&#x2F; 字段规则：repeated -&gt; 字段可出现任意多次（包括 0）</p>
<p>&#x2F;&#x2F; 类型：int32、int64、sint32、sint64、string、32-bit ….</p>
<p>&#x2F;&#x2F; 字段编号：0 ~ 536870911（除去 19000 到 19999 之间的数字）</p>
<p>字段规则 类型 名称 &#x3D; 字段编号;<br>}</p>
</blockquote>
<p>分别新建<code>SubscribeReq</code>和<code>SubscribeResp</code> 两个 proto 文件，代码如下。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">&quot;com.study.netty.proto&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;SubscribeReq&quot;</span>;</span><br><span class="line"><span class="keyword">message </span><span class="title class_">ClientReq</span>&#123;</span><br><span class="line">    <span class="type">int32</span> subReqID = <span class="number">1</span>;</span><br><span class="line">    <span class="type">string</span> userName = <span class="number">2</span>;</span><br><span class="line">    <span class="type">string</span> productName = <span class="number">3</span>;</span><br><span class="line">    <span class="type">string</span> address = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">&quot;com.study.netty.proto&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;SubscribeRep&quot;</span>;</span><br><span class="line"><span class="keyword">message </span><span class="title class_">Respponse</span>&#123;</span><br><span class="line">    <span class="type">int32</span> subReqID = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int32</span> respCode = <span class="number">2</span>;</span><br><span class="line">    <span class="type">string</span> desc = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：1、protobuf2 和 protobuf3 语法不同， protobuf3 仅仅支持 repeated 字段，如果使用 optional 、required 编译会报错； 2、java_outer_classname 中的名字和 message中的名字不能重名，否则会报 protobuf matches the name of one of the types declared inside it 错误。</strong></p>
<p>最终通过 idea protobuf 插件或者直接运行 <code>protc</code>或者通过 protobuf maven 插件 compile 编译指令得到 编译结果如下：</p>
<p><img src="/../assets/blogImg/Netty/8-1.png" alt="8-1"></p>
<h4 id="8-2-、Netty-的-Protobuf-服务端开发"><a href="#8-2-、Netty-的-Protobuf-服务端开发" class="headerlink" title="8.2 、Netty 的 Protobuf 服务端开发"></a>8.2 、Netty 的 Protobuf 服务端开发</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubscribeServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup,workGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;Protobuf frame decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">ProtobufVarint32FrameDecoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;Protobuf decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">ProtobufDecoder</span>(SubscribeReq.ClientReq.getDefaultInstance()));</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;Protobuf frame encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">ProtobufVarint32LengthFieldPrepender</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;Protobuf encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">ProtobufEncoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">SubcribeServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">// 绑定端口，同步等待成功</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> serverBootstrap.bind(port).sync();</span><br><span class="line">            <span class="comment">// 等待服务端绑定监听端口关闭</span></span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// SubcribeServerHandler 处理网络 I/O 事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubcribeServerHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        SubscribeReq.<span class="type">ClientReq</span> <span class="variable">req</span> <span class="operator">=</span> (SubscribeReq.ClientReq) msg;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;hello&quot;</span>.equals(req.getUserName()))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Service accept client subscribe req is: [ &quot;</span>+req.toString() +<span class="string">&quot;]&quot;</span>);</span><br><span class="line">            SubscribeResp.<span class="type">Respponse</span> <span class="variable">resp</span> <span class="operator">=</span> createSubscribeResp(req.getSubReqID());</span><br><span class="line">            ctx.writeAndFlush(resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SubscribeResp.Respponse <span class="title function_">createSubscribeResp</span><span class="params">(<span class="type">int</span> subReqID)</span> &#123;</span><br><span class="line">        SubscribeResp.Respponse.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> SubscribeResp.Respponse.newBuilder();</span><br><span class="line">        builder.setSubReqID(subReqID);</span><br><span class="line">        builder.setRespCode(<span class="number">0</span>);</span><br><span class="line">        builder.addDesc(<span class="string">&quot;Netty book order succeed, 3 day later, send to the designated address.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ChannelPipeline 添加 <code>ProtobufVarint32FrameDecoder</code>，主要用于半包处理，添加<code>ProtobufDecoder</code> 是用于消息的自动解码。</p>
<h4 id="8-3、Netty-的-Protobuf-客户端开发"><a href="#8-3、Netty-的-Protobuf-客户端开发" class="headerlink" title="8.3、Netty 的 Protobuf 客户端开发"></a>8.3、Netty 的 Protobuf 客户端开发</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubscribeClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(String host, <span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">loopGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(loopGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY,<span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;Protobuf frame decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">ProtobufVarint32FrameDecoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;Protobuf decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">ProtobufDecoder</span>(SubscribeResp.Respponse.getDefaultInstance()));</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;Protobuf frame encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">ProtobufVarint32LengthFieldPrepender</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;Protobuf encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">ProtobufEncoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">SubcribeClientHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">// 发起异步连接</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host,port)).sync();</span><br><span class="line">            <span class="comment">// 同步等待客户端关闭连接</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            loopGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// SubcribeClientHandler 负责客户端网络 I/O 事件处理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubcribeClientHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">            SubscribeReq.<span class="type">ClientReq</span> <span class="variable">req</span> <span class="operator">=</span> createClientReq(i);</span><br><span class="line">            ctx.writeAndFlush(req);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SubscribeReq.ClientReq <span class="title function_">createClientReq</span><span class="params">(<span class="type">int</span> reqId)</span>&#123;</span><br><span class="line">        SubscribeReq.ClientReq.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> SubscribeReq.ClientReq.newBuilder();</span><br><span class="line">        builder.setSubReqID(reqId);</span><br><span class="line">        builder.setProductName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        builder.setUserName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        List&lt;String&gt; address = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        address.add(<span class="string">&quot;BeiJing&quot;</span>);</span><br><span class="line">        address.add(<span class="string">&quot;Guangdong&quot;</span>);</span><br><span class="line">        address.add(<span class="string">&quot;ShengZhen&quot;</span>);</span><br><span class="line">        builder.addAllAddress(address);</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        SubscribeResp.<span class="type">Respponse</span> <span class="variable">resp</span> <span class="operator">=</span> (SubscribeResp.Respponse) msg;</span><br><span class="line">        System.out.println(<span class="string">&quot;Client receive the order response : [ &quot;</span>+resp.toString()+<span class="string">&quot; ]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="九、JBoss-Marshalling-编解码"><a href="#九、JBoss-Marshalling-编解码" class="headerlink" title="九、JBoss Marshalling 编解码"></a>九、JBoss Marshalling 编解码</h3><p>JBoss Marshalling 是一个 Java 对象序列化包，对 JDK 默认的序列化框架进行了优化，但又保持了更 java.io.Serializable 接口的兼容，同时增加一些可调的参数和附加特性。</p>
<h4 id="9-1、开发准备"><a href="#9-1、开发准备" class="headerlink" title="9.1、开发准备"></a>9.1、开发准备</h4><p>maven 依赖 JBoss Marshalling </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.jboss.marshalling&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jboss-marshalling&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.0.12.Final&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.jboss.marshalling&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jboss-marshalling-serial&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.0.12.Final&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="9-2、Netty-的-Marshalling-服务端开发"><a href="#9-2、Netty-的-Marshalling-服务端开发" class="headerlink" title="9.2、Netty 的 Marshalling 服务端开发"></a>9.2、Netty 的 Marshalling 服务端开发</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarshallingServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                           <span class="comment">// 添加 MarshallingDecoder 解码器</span></span><br><span class="line">                           socketChannel.pipeline().addLast(MarshallingCodeFactory.buildMarshallingDecode());</span><br><span class="line">                            <span class="comment">// 添加 MarshallingEncoder 编码器  </span></span><br><span class="line">                            </span><br><span class="line">socketChannel.pipeline().addLast(MarshallingCodeFactory.buildMarshallingEncoder());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">SubcribeServerHandler</span>());</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> serverBootstrap.bind(port).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Marshalling 编解码器工厂类，用于创建MarshallingDecoder 和 MarshallingEncoder </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarshallingCodeFactory</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 JBoss Marshalling 解码器 MarshallingDecoder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MarshallingDecoder <span class="title function_">buildMarshallingDecode</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MarshallerFactory</span> <span class="variable">marshallerFactory</span> <span class="operator">=</span> Marshalling.getProvidedMarshallerFactory(<span class="string">&quot;serial&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MarshallingConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MarshallingConfiguration</span>();</span><br><span class="line">        configuration.setVersion(<span class="number">5</span>);</span><br><span class="line">        <span class="type">UnmarshallerProvider</span> <span class="variable">provider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultUnmarshallerProvider</span>(marshallerFactory,configuration);</span><br><span class="line">        <span class="type">MarshallingDecoder</span> <span class="variable">decoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MarshallingDecoder</span>(provider,<span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">return</span> decoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 JBoss Marshalling 编码器 MarshallingEncoder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MarshallingEncoder <span class="title function_">buildMarshallingEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MarshallerFactory</span> <span class="variable">marshallerFactory</span> <span class="operator">=</span> Marshalling.getProvidedMarshallerFactory(<span class="string">&quot;serial&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MarshallingConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MarshallingConfiguration</span>();</span><br><span class="line">        configuration.setVersion(<span class="number">5</span>);</span><br><span class="line">        <span class="type">MarshallerProvider</span> <span class="variable">provider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMarshallerProvider</span>(marshallerFactory,configuration);</span><br><span class="line">        <span class="type">MarshallingEncoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MarshallingEncoder</span>(provider);</span><br><span class="line">        <span class="keyword">return</span> encoder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 ChannelPipeline 中添加 Marshalling 的 解码器以及编码器，其中<code>SubcribeServerHandler</code> 网络 I&#x2F;O 事件处理和第8章的例程一样。</p>
<h4 id="9-3、Netty-的-Marshalling-客户端开发"><a href="#9-3、Netty-的-Marshalling-客户端开发" class="headerlink" title="9.3、Netty 的 Marshalling 客户端开发"></a>9.3、Netty 的 Marshalling 客户端开发</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarshallingClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(String host, <span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">loopGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(loopGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY,<span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(MarshallingCodeFactory.buildMarshallingDecode());</span><br><span class="line">                            socketChannel.pipeline().addLast(MarshallingCodeFactory.buildMarshallingEncoder());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">SubcribeClientHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host,port)).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            loopGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的在开户端的代码中在ChannelPipeline 中也通过添加 Marshalling 的编解码器</p>
<h3 id="十、HTTP-协议开发应用"><a href="#十、HTTP-协议开发应用" class="headerlink" title="十、HTTP 协议开发应用"></a>十、HTTP 协议开发应用</h3><h4 id="10-1、HTTP-协议介绍"><a href="#10-1、HTTP-协议介绍" class="headerlink" title="10.1、HTTP 协议介绍"></a>10.1、HTTP 协议介绍</h4><p>HTTP（超文本传输协议）是建立在TCP传输协议之上的属于应用层的面向对象的协议，其主要特点如下：</p>
<ul>
<li>支持 Client&#x2F;Server 模式；</li>
<li>简单—— 客户向服务器发送请求服务时，只需指定服务URL，携带必要的请求参数或者消息体；</li>
<li>灵活—— HTTP 允许传输任意类型的数据对象，传输内容类型由HTTP 消息头中的Content-Type 加以标记；</li>
<li>无状态—— HTTP协议是无状态协议，无状态是指对事务处理没有记忆能力。缺少状态意味着如果后续处理需要之前的信息，则它需要重传，这样导致每次连接传输的数据量变大。另一方面，在服务器不需要先前信息时它的应答就较快，负载较轻。</li>
</ul>
<h5 id="10-1-1、HTTP-协议的-URL"><a href="#10-1-1、HTTP-协议的-URL" class="headerlink" title="10.1.1、HTTP 协议的 URL"></a>10.1.1、HTTP 协议的 URL</h5><p>HTTP URL（URL 是一种特殊类型的 URI，包含了查询某个资源的足够信息）格式如下：</p>
<p><code>http://host[“:”port][abs_path]</code></p>
<p>http 表示要通过 HTTP 协议来定位网络资源；</p>
<p>host 表示合法的 Internet 主机域名或者 IP 地址；</p>
<p>port 表示一个指定的端口号，空则默认为 80；</p>
<p>asb_path 表示指定请求资源的 URI ；</p>
<h5 id="10-1-2、HTTP-请求消息（HttpRequest"><a href="#10-1-2、HTTP-请求消息（HttpRequest" class="headerlink" title="10.1.2、HTTP 请求消息（HttpRequest)"></a>10.1.2、HTTP 请求消息（HttpRequest)</h5><p>HTTP 请求的三部分组成如下：</p>
<ul>
<li>HTTP 请求行；</li>
<li>HTTP 请求头；</li>
<li>HTTP 请求正文；</li>
</ul>
<p>请求行以一个方法符开头，以空格分开，后面跟着请求的URI 和协议版本，格式为： Method  Request-URI  HTTP-Version CRLF。如：<code>GET /netty5.0 HTTP/1.1</code></p>
<p>Method 请求方法有多种，各方法作用如下：</p>
<ul>
<li><p>GET：请求获取 Request-URI 所标识的资源；</p>
</li>
<li><p>POST：在 Request-URI 所标识的资源后附件新的提交数据；</p>
</li>
<li><p>HEAD：请求获取由 Request-URI 所标识的资源的响应消息报头；</p>
</li>
<li><p>PUT：请求服务器存储一个资源，并用 Request-URI 作为其标识；</p>
</li>
<li><p>DELETE：请求服务器删除 Request-URI 所标识的资源；</p>
</li>
<li><p>TRACE：请求服务器返回所接收到的信息，主要用于诊断或测试；</p>
</li>
<li><p>CONNECT：保留将来使用；</p>
</li>
<li><p>OPTION：请求查询服务器性能，或查询与资源相关的选项和需求。</p>
</li>
</ul>
<h4 id="10-2、Netty-HTTP-服务端入门开发"><a href="#10-2、Netty-HTTP-服务端入门开发" class="headerlink" title="10.2、Netty HTTP 服务端入门开发"></a>10.2、Netty HTTP 服务端入门开发</h4><p>由于Netty 天生是异步事件驱动框架，因此基于NIO TCP 协议栈开发的Http 协议栈也是异步非阻塞的。</p>
<p>Netty 的 HTTP 协议栈无论是在性能还是可靠性上，都表现优异，非常适合在非Web 容器的场景下使用，相比传统的 Tomcat、Jetty 等 Web 容器，它更加轻量和小巧，灵活性和定制性也更好。</p>
<p><strong>例程场景描述：</strong></p>
<p>以文件服务器为例学习Netty 的 Http 服务端开发入门，场景如下：</p>
<p>文件服务器使用Http 协议对外提供服务，当客户端通过浏览器访问文件服务器时，对访问路径进行检查，检查失败时返回 403；</p>
<p>校验通过，以链接的方式打开文件目录，每个目录或者文件都是一个超链接，可以递归访问；</p>
<p>如果是目录，可以递归访问他的子目录或者文件，如果文件可读，则可以在浏览器端直接打开，或通过【目标另存为】下载文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpFileServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_URL</span> <span class="operator">=</span> <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span>&#123;</span><br><span class="line">        <span class="type">HttpFileServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpFileServer</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            server.start(DEFAULT_URL,<span class="number">8080</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(String url, <span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;http-decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;http-aggregator&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65536</span>));</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;http-encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpResponseEncoder</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;http-Chunked&quot;</span>,<span class="keyword">new</span> <span class="title class_">ChunkedWriteHandler</span>());</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="string">&quot;fileserverHandler&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpFileServerHandler</span>(url));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> serverBootstrap.bind(<span class="string">&quot;127.0.0.1&quot;</span>,port).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;Http 文件目录服务器启动，网址为：http://127.0.0.1:&quot;</span>+port+url);</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">HttpFileServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;FullHttpRequest&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> String url;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">HttpFileServerHandler</span><span class="params">(String url)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.url = url;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">// 对请求消息进行解码判断，如果解码失败，构造响应返回 400 错误</span></span><br><span class="line">            <span class="keyword">if</span> (!request.decoderResult().isSuccess())&#123;</span><br><span class="line">                sendError(ctx, BAD_REQUEST);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 对请求方法判断，如果不是GET请求，则响应 405 错误</span></span><br><span class="line">            <span class="keyword">if</span> (request.method()!=HttpMethod.GET)&#123;</span><br><span class="line">                sendError(ctx,METHOD_NOT_ALLOWED);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 对 url 进行分析判断</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.uri();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> sanitizeUri(uri);</span><br><span class="line">            <span class="keyword">if</span> (path == <span class="literal">null</span>)&#123;</span><br><span class="line">                sendError(ctx,FORBIDDEN);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path);</span><br><span class="line">            <span class="comment">// 如果文件隐藏或者不存在，响应 404</span></span><br><span class="line">            <span class="keyword">if</span> (file.isHidden() || !file.exists())&#123;</span><br><span class="line">                sendError(ctx,NOT_FOUND);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (file.isDirectory())&#123;</span><br><span class="line">                <span class="keyword">if</span> (uri.endsWith(<span class="string">&quot;/&quot;</span>))&#123;</span><br><span class="line">                    <span class="comment">// 如果文件是目录则发送文件目录连接给浏览器客户端</span></span><br><span class="line">                    sendList(ctx,file);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    sendRedirect(ctx,uri+<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!file.isFile())&#123;</span><br><span class="line">                sendError(ctx,FORBIDDEN);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 通过随机文件读写类RandomAccessFile类打开文件，并构造响应。</span></span><br><span class="line">            <span class="type">RandomAccessFile</span> <span class="variable">randomAccessFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                randomAccessFile = <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (FileNotFoundException fnfd)&#123;</span><br><span class="line">                sendError(ctx,NOT_FOUND);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">long</span> <span class="variable">fileLength</span> <span class="operator">=</span> randomAccessFile.length();</span><br><span class="line">            <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultHttpResponse</span>(HttpVersion.HTTP_1_1,OK);</span><br><span class="line">            <span class="comment">// 设置 content-length</span></span><br><span class="line">            HttpUtil.setContentLength(response,fileLength);</span><br><span class="line">            setContentTypeHeader(response,file);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断是否为 keep-alive 如果是则在请求头设置 connection 为 keep-alive</span></span><br><span class="line">            <span class="keyword">if</span> (HttpUtil.isKeepAlive(request))&#123;</span><br><span class="line">                response.headers().set(HttpHeaderNames.CONNECTION,HttpHeaderValues.KEEP_ALIVE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 发送响应消息</span></span><br><span class="line">            ctx.write(response);</span><br><span class="line">            ChannelFuture sendFuture;</span><br><span class="line">            <span class="comment">// 通过Netty的ChunkedFile对象直接将文件写入发送到缓冲区中</span></span><br><span class="line">            sendFuture = ctx.write(<span class="keyword">new</span> <span class="title class_">ChunkedFile</span>(randomAccessFile,<span class="number">0</span>,fileLength,<span class="number">8192</span>),ctx.newProgressivePromise());</span><br><span class="line">            sendFuture.addListener(<span class="keyword">new</span> <span class="title class_">ChannelProgressiveFutureListener</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationProgressed</span><span class="params">(ChannelProgressiveFuture future, <span class="type">long</span> progress, <span class="type">long</span> total)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    <span class="keyword">if</span> (total&lt;<span class="number">0</span>)</span><br><span class="line">                        System.out.println(<span class="string">&quot;Transfer progress : &quot;</span>+progress);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        System.out.println(<span class="string">&quot;Transfer progress : &quot;</span>+progress+<span class="string">&quot;/&quot;</span>+total);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelProgressiveFuture future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Transfer complete.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 如果使用 chunked 编码，需要发送一个编码结束的空消息体，标识所有消息体已经发送完成</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">lastfuture</span> <span class="operator">=</span> ctx.writeAndFlush(LastHttpContent.EMPTY_LAST_CONTENT);</span><br><span class="line">            <span class="keyword">if</span> (!HttpUtil.isKeepAlive(request))&#123;</span><br><span class="line">                lastfuture.addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (ctx.channel().isActive())&#123;</span><br><span class="line">                sendError(ctx,INTERNAL_SERVER_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">INSECURE_URI</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;.*[&lt;&gt;&amp;\&quot;].*&quot;</span>);</span><br><span class="line">        <span class="comment">// 对 uri 进行解码并判断其合法性，</span></span><br><span class="line">        <span class="keyword">private</span> String <span class="title function_">sanitizeUri</span><span class="params">(String uri)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                uri = URLDecoder.decode(uri,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    uri = URLDecoder.decode(uri,<span class="string">&quot;ISO-8859-1&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e1) &#123;</span><br><span class="line">                    e1.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!uri.startsWith(url))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!uri.startsWith(<span class="string">&quot;/&quot;</span>))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// 将硬编码的文件路径分隔符替换为本地操作系统的文件路径分隔符</span></span><br><span class="line">            uri = uri.replace(<span class="string">&#x27;/&#x27;</span>, File.separatorChar);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (uri.contains(File.separator + <span class="string">&#x27;.&#x27;</span>) || uri.contains(<span class="string">&#x27;.&#x27;</span>+File.separator)</span><br><span class="line">                    || uri.startsWith(<span class="string">&quot;.&quot;</span>) || uri.endsWith(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">                    || INSECURE_URI.matcher(uri).matches())</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> System.getProperty(<span class="string">&quot;user.dir&quot;</span>)+File.separator + uri;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">ALLOWED_FILE_NAME</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;[A-Za-z0-9][-_A-Za-z0-9\\.]*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造文件目录 HTML 响应消息体发送给客户端</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendList</span><span class="params">(ChannelHandlerContext ctx, File file)</span> &#123;</span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1,OK);</span><br><span class="line">            response.headers().set(HttpHeaderNames.CONTENT_TYPE,<span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">dirPath</span> <span class="operator">=</span> file.getPath();</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            builder.append(<span class="string">&quot;&lt;!DOCTYPE html&gt;\r\n&quot;</span>);</span><br><span class="line">            builder.append(<span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;\r\n&quot;</span>);</span><br><span class="line">            builder.append(dirPath);</span><br><span class="line">            builder.append(<span class="string">&quot;目录：&quot;</span>);</span><br><span class="line">            builder.append(<span class="string">&quot;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;\r\n&quot;</span>);</span><br><span class="line">            builder.append(<span class="string">&quot;&lt;h3&gt;&quot;</span>);</span><br><span class="line">            builder.append(dirPath+<span class="string">&quot;目录：&quot;</span>);</span><br><span class="line">            builder.append(<span class="string">&quot;&lt;/h3&gt;\r\n&quot;</span>);</span><br><span class="line">            builder.append(<span class="string">&quot;&lt;ul&gt;&quot;</span>);</span><br><span class="line">            builder.append(<span class="string">&quot;&lt;li&gt;链接：&lt;a href=\&quot; ../\&quot;&gt;..&lt;/a&gt;&lt;/li&gt;\r\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (File f: file.listFiles())&#123;</span><br><span class="line">                <span class="keyword">if</span> (f.isHidden() || !f.canRead())&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> f.getName();</span><br><span class="line">                <span class="keyword">if</span> (!ALLOWED_FILE_NAME.matcher(name).matches())&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                builder.append(<span class="string">&quot;&lt;li&gt;链接：&lt;a href=\&quot;&quot;</span>);</span><br><span class="line">                builder.append(name);</span><br><span class="line">                builder.append(<span class="string">&quot;\&quot;&gt;&quot;</span>);</span><br><span class="line">                builder.append(name);</span><br><span class="line">                builder.append(<span class="string">&quot;&lt;/a&gt;&lt;/li&gt;\r\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            builder.append(<span class="string">&quot;&lt;/ul&gt;&lt;/body&gt;&lt;/html&gt;\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">buffer</span> <span class="operator">=</span> Unpooled.copiedBuffer(builder,CharsetUtil.UTF_8);</span><br><span class="line">            response.content().writeBytes(buffer);</span><br><span class="line">            buffer.release();</span><br><span class="line">            ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendRedirect</span><span class="params">(ChannelHandlerContext ctx, String newUri)</span> &#123;</span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1,FOUND);</span><br><span class="line">            response.headers().set(HttpHeaderNames.LOCATION,newUri);</span><br><span class="line">            ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendError</span><span class="params">(ChannelHandlerContext ctx, HttpResponseStatus status)</span> &#123;</span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1,status,</span><br><span class="line">                    Unpooled.copiedBuffer(<span class="string">&quot;Failure:&quot;</span>+status.toString()+<span class="string">&quot;\r\n&quot;</span>,CharsetUtil.UTF_8));</span><br><span class="line">            response.headers().set(HttpHeaderNames.CONTENT_TYPE,<span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">            ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setContentTypeHeader</span><span class="params">(HttpResponse response, File file)</span>&#123;</span><br><span class="line">            <span class="type">MimetypesFileTypeMap</span> <span class="variable">mimetypesFileTypeMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimetypesFileTypeMap</span>();</span><br><span class="line">            response.headers().set(HttpHeaderNames.CONTENT_TYPE,mimetypesFileTypeMap.getContentType(file.getPath()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="/../assets/blogImg/Netty%5C10-1.png" alt="10-1"></p>
<p>重点：</p>
<ul>
<li>添加编码器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 负责把字节解码成Http请求</span></span><br><span class="line">socketChannel.pipeline().addLast(<span class="string">&quot;http-decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>());</span><br><span class="line"><span class="comment">// 负责把多个HttpMessage组装成一个完整的Http请求或者响应把响应编码成字节。到底是组装成请求还是响应，则取决于它所处理的内容是请求的内容，还是响应的内容。这其实可以通过Inbound和Outbound来判断，对于Server端而言，在Inbound 端接收请求，在Outbound端返回响应。</span></span><br><span class="line">socketChannel.pipeline().addLast(<span class="string">&quot;http-aggregator&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65536</span>));</span><br><span class="line"><span class="comment">// 把响应编码成字节</span></span><br><span class="line">socketChannel.pipeline().addLast(<span class="string">&quot;http-encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpResponseEncoder</span>());</span><br><span class="line"><span class="comment">// 该通道处理器主要是为了处理大文件传输的情形。大文件传输时，需要复杂的状态管理，而ChunkedWriteHandler实现这个功能。</span></span><br><span class="line">socketChannel.pipeline().addLast(<span class="string">&quot;http-Chunked&quot;</span>,<span class="keyword">new</span> <span class="title class_">ChunkedWriteHandler</span>());</span><br><span class="line"><span class="comment">// 自定义的通道处理器，其目的是实现文件服务器的业务逻辑。</span></span><br><span class="line">socketChannel.pipeline().addLast(<span class="string">&quot;fileserverHandler&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpFileServerHandler</span>(url));</span><br></pre></td></tr></table></figure>

<ul>
<li><p>自定义通道处理器继承<code>SimpleChannelInboundHandler&lt;FullHttpRequest&gt;</code> 实现 <code>channelRead0</code> 方法</p>
</li>
<li><p>通过 <code>ChunkedFile </code>将文件写入发送到缓冲区中</p>
</li>
</ul>
<h4 id="10-3、Netty-HTTP-XML-协议栈开发"><a href="#10-3、Netty-HTTP-XML-协议栈开发" class="headerlink" title="10.3、Netty HTTP+XML 协议栈开发"></a>10.3、Netty HTTP+XML 协议栈开发</h4><p>由于 HTTP 协议的通用性，很多异构系统间的通信交互采用 HTTP 协议，通过 HTTP 协议承载业务数据进行消息交互。</p>
<p><strong>模拟客户订购系统示例场景：</strong></p>
<p>客户填写订单，通过 HTTP 客户端向服务端发送订购请求，请求消息以XML承载放在 HTTP 消息体中。</p>
<p>HTTP服务端接收到客户端的订购请求后，对订单进行修改，然后通过 HTTP+XML 的方式返回响应内容。</p>
<p>双方采用 HTTP 协议版本 为 HTTP1.1，连接类型为CLOSE，即双方交互完成后，由服务端主动关闭链路。</p>
<h5 id="10-3-1、XML绑定框架-JiBx-入门"><a href="#10-3-1、XML绑定框架-JiBx-入门" class="headerlink" title="10.3.1、XML绑定框架 JiBx 入门"></a>10.3.1、XML绑定框架 JiBx 入门</h5><p>JiBx 是一款优秀的 XML 数据绑定框架，它提供了灵活的绑定映射文件，实现数据对象与XML 文件之间的转换，不需要修改现有的Java 类。</p>
<p>使用 JiBx 绑定 XML 文档与 Java 对象需要分两边走： </p>
<ol>
<li>生成绑定绑定 XML 文件（binding.xml) 和 数据映射文件（pojo.xml)，也就是映射 XML 文件与 Java 对象之间的对应关系；</li>
<li>实现 XML 文件与 Java 实例之间的相互转换，即根据 binding.xml 生成 Marshal 或者 Unmarshal 所需的 class 文件。</li>
</ol>
<p>首先maven 依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jibx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span> &gt;</span>jibx-run<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> &gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jibx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jibx-extras<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后编写响应的 pojo 文件，Order、Address、Customer、Shipping 等，此次不展开细说。</p>
<p><strong>产生binding以及增强字节</strong></p>
<p>一、产生binding.xml 文件，通过cmd 或者在idea 的Terminal  切换到项目的 <code>target\classes</code> 目录下，使用 <code>jibx-tools.jar</code> 来生成。其中jibx-tools.jar包生成xml的时候，必须这个jar包所在文件夹中包含所有的jibx其他jar包 因为在生成binging.xml时候会用到其他jar包。（如果使用maven 的包会报错）</p>
<blockquote>
<p>java -cp bin;D:\jar\lib\jibx-tools.jar org.jibx.binding.generator.BindGen -b binding.xml com.study.netty.poj<br>o.Order</p>
</blockquote>
<p><img src="/../assets/blogImg/Netty/10-2.png" alt="10-2"></p>
<p>二、通过生成的binding.xml 增强字节码，生成 Marshal 或者 Unmarshal 所需的 class，如下图</p>
<p>此方式需要maven 依赖  jibx-tools 和 jibx-bind</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jibx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jibx-tools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jibx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jibx-bind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenBindFileTool</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JiBXException, IOException &#123;</span><br><span class="line">        <span class="comment">// 根据 java 对象产生 binding 文件</span></span><br><span class="line">        <span class="comment">//genBindFiles();</span></span><br><span class="line">        <span class="comment">// 增强字节码</span></span><br><span class="line">        compile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增强字节码</span></span><br><span class="line"><span class="comment">     * 等效于 mvn jibx:bind（需要依赖maven 的 jibx 插件）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">compile</span><span class="params">()</span> &#123;</span><br><span class="line">        String[] args = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印生成过程的详细信息。可选</span></span><br><span class="line">        args[<span class="number">0</span>] = <span class="string">&quot;-v&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定 binding 和 schema 文件的路径。必须</span></span><br><span class="line">        <span class="comment">//args[1] = &quot;./src/main/java/com/study/netty/jibxgen/binding.xml&quot;;</span></span><br><span class="line">        args[<span class="number">1</span>] = <span class="string">&quot;./target/classes/com/study/netty/jibx/binding.xml&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Compile.main(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 java 对象产生 binding 文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> JiBXException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">genBindFiles</span><span class="params">()</span> <span class="keyword">throws</span> JiBXException, IOException &#123;</span><br><span class="line">        String[] args = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定pojo源码路径（指定父包也是可以的）。必须</span></span><br><span class="line">        args[<span class="number">0</span>] = <span class="string">&quot;-s&quot;</span>;</span><br><span class="line">        args[<span class="number">1</span>] = <span class="string">&quot;src&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自定义生成的binding文件名，默认文件名binding.xml。可选</span></span><br><span class="line">        args[<span class="number">2</span>] = <span class="string">&quot;-b&quot;</span>;</span><br><span class="line">        args[<span class="number">3</span>] = <span class="string">&quot;binding.xml&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印生成过程的一些信息。可选</span></span><br><span class="line">        args[<span class="number">4</span>] = <span class="string">&quot;-v&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果目录已经存在，就删除目录。可选</span></span><br><span class="line">        args[<span class="number">5</span>] = <span class="string">&quot;-w&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定输出路径。默认路径 .（当前目录,即根目录）。可选</span></span><br><span class="line">        args[<span class="number">6</span>] = <span class="string">&quot;-t&quot;</span>;</span><br><span class="line">        <span class="comment">//args[7] = &quot;./src/main/java/com/study/netty/jibxgen&quot;;</span></span><br><span class="line">        args[<span class="number">7</span>] = <span class="string">&quot;./target/classes/com/study/netty/jibx&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 告诉 BindGen 使用下面的类作为 root 生成 binding 和 schema。必须</span></span><br><span class="line">        args[<span class="number">8</span>] = <span class="string">&quot;com.study.netty.pojo.Order&quot;</span>;</span><br><span class="line"></span><br><span class="line">        BindGen.main(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../assets/blogImg/Netty/10-3.png" alt="10-3"></p>
<p>最后编写测试程序TestXmlOrder，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestXmlOrder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">IBindingFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">StringWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">StringReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CHARSET_NAME</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">encode2Xml</span><span class="params">(Order order)</span> <span class="keyword">throws</span> JiBXException, IOException &#123;</span><br><span class="line">        <span class="comment">// 根据 Order的 class 实例构建 IBindingFactory 对象</span></span><br><span class="line">        factory = BindingDirectory.getFactory(Order.class);</span><br><span class="line">        writer = <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        <span class="comment">// 获取 Marshalling 上下文</span></span><br><span class="line">        <span class="type">IMarshallingContext</span> <span class="variable">mctx</span> <span class="operator">=</span> factory.createMarshallingContext();</span><br><span class="line">        mctx.setIndent(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 把 order 实例 序列化到 StringWriter中</span></span><br><span class="line">        mctx.marshalDocument(order, CHARSET_NAME, <span class="literal">null</span>, writer);</span><br><span class="line">        <span class="type">String</span> <span class="variable">xmlStr</span> <span class="operator">=</span> writer.toString();</span><br><span class="line">        writer.close();</span><br><span class="line">        System.out.println(xmlStr.toString());</span><br><span class="line">        <span class="keyword">return</span> xmlStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Order <span class="title function_">decode2Order</span><span class="params">(String xmlBody)</span> <span class="keyword">throws</span> JiBXException &#123;</span><br><span class="line">        reader = <span class="keyword">new</span> <span class="title class_">StringReader</span>(xmlBody);</span><br><span class="line">        <span class="comment">// 获取 Unmarshallling 上下文</span></span><br><span class="line">        <span class="type">IUnmarshallingContext</span> <span class="variable">uctx</span> <span class="operator">=</span> factory.createUnmarshallingContext();</span><br><span class="line">        <span class="comment">// 把 XML 数据反序列化为 order 实例对象</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> (Order) uctx.unmarshalDocument(reader);</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> JiBXException, IOException &#123;</span><br><span class="line">        <span class="type">TestXmlOrder</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestXmlOrder</span>();</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> OrderFactory.createOrder(<span class="number">123</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> test.encode2Xml(order);</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order2</span> <span class="operator">=</span> test.decode2Order(body);</span><br><span class="line">        System.out.println(order2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="/../assets/blogImg/Netty/10-4.png" alt="10-4"></p>
<h5 id="10-3-2、HTTP-XML-编解码框架开发"><a href="#10-3-2、HTTP-XML-编解码框架开发" class="headerlink" title="10.3.2、HTTP+XML 编解码框架开发"></a>10.3.2、HTTP+XML 编解码框架开发</h5><p>下面将会通过商品订购流程来实现 HTTP+XML 协议栈的开发，其中流程图如下：</p>
<p><img src="/../assets/blogImg/Netty/10-9.png" alt="10-9"></p>
<p>步骤大概有：</p>
<ol>
<li>在客户端构造订购消息，并将消息编码为 HTTP+XML 格式，通过 HTTP 协议栈发送HTTP请求消息</li>
<li>服务端接收 HTTP+XML请求消息进行解码，解码成请求POJO</li>
<li>服务端构造应答消息并编码，通过 HTTP+XML 方式返回个客户端</li>
<li>客户端对 HTTP + XML 响应消息进行解码，解码成响应的POJO</li>
</ol>
<p>由上可知，共应该需要 4 个编解码器，分别是客户端 请求时对消息的编码器和接受响应消息时的解码器；服务端接收请求消息的解码器和响应消息时的编码器。</p>
<p><strong>1、HTTP + XML 请求消息编解码码类</strong></p>
<p>因为请求消息编码和响应消息编码都需要用到编码器，需要抽象一个编码器供具体的类来实现。同样的解码器也需要封装抽象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// XML 编码器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractHttpXmlEncoder</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">MessageToMessageEncoder</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">IBindingFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">StringWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CHARSET_NAME</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Charset</span> <span class="variable">UTF_8</span> <span class="operator">=</span> Charset.forName(CHARSET_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> ByteBuf <span class="title function_">encode0</span><span class="params">(ChannelHandlerContext ctx, Object body)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 根据 请求体 class 实例构建 IBindingFactory 对象</span></span><br><span class="line">        factory = BindingDirectory.getFactory(body.getClass());</span><br><span class="line">        writer = <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">        <span class="type">IMarshallingContext</span> <span class="variable">mctx</span> <span class="operator">=</span> factory.createMarshallingContext();</span><br><span class="line">        mctx.setIndent(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 通过 Marshalling 把数据对象转换为 XML 格式数据</span></span><br><span class="line">        mctx.marshalDocument(body, CHARSET_NAME, <span class="literal">null</span>, writer);</span><br><span class="line">        <span class="type">String</span> <span class="variable">xmlStr</span> <span class="operator">=</span> writer.toString();</span><br><span class="line">        writer.close();</span><br><span class="line">        writer = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.copiedBuffer(xmlStr,UTF_8);</span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>.exceptionCaught(ctx, cause);</span><br><span class="line">        <span class="keyword">if</span> (writer!=<span class="literal">null</span>)&#123;</span><br><span class="line">            writer.close();</span><br><span class="line">            writer=<span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XML 解码器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractHttpXmlDecoder</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">MessageToMessageDecoder</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;AbstractHttpXmlDecoder&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">IBindingFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">StringReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; aClass;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isPrint;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CHARSET_NAME</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Charset</span> <span class="variable">UTF_8</span> <span class="operator">=</span> Charset.forName(CHARSET_NAME);</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">AbstractHttpXmlDecoder</span><span class="params">(Class&lt;?&gt; aClass)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.aClass = aClass;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">AbstractHttpXmlDecoder</span><span class="params">(Class&lt;?&gt; aClass, <span class="type">boolean</span> isPrint)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.aClass = aClass;</span><br><span class="line">        <span class="built_in">this</span>.isPrint = isPrint;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">decode0</span><span class="params">(ChannelHandlerContext ctx, ByteBuf msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 根据 需要的响应体 class 实例构建 IBindingFactory 对象</span></span><br><span class="line">        factory = BindingDirectory.getFactory(aClass);</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> msg.toString(UTF_8);</span><br><span class="line">        <span class="keyword">if</span> (isPrint)</span><br><span class="line">            System.out.println(<span class="string">&quot;decoder &quot;</span>+TAG+<span class="string">&quot; receive contant is :\r\n&quot;</span>+content);</span><br><span class="line">        reader = <span class="keyword">new</span> <span class="title class_">StringReader</span>(content);</span><br><span class="line">        <span class="comment">// 通过 Unmarshalling 把XML 数据转换为响应数据对象实体</span></span><br><span class="line">        <span class="type">IUnmarshallingContext</span> <span class="variable">uctx</span> <span class="operator">=</span> factory.createUnmarshallingContext();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> uctx.unmarshalDocument(reader);</span><br><span class="line">        reader.close();</span><br><span class="line">        reader = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (reader!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 释放资源</span></span><br><span class="line">            reader.close();</span><br><span class="line">            reader = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> <strong>2、服务端 HTTP+XML 编解码器开发</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求消息编码器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpXmlRequestEncoder</span> <span class="keyword">extends</span> <span class="title class_">AbstractHttpXmlEncoder</span>&lt;HttpXmlRequest&gt;  &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, HttpXmlRequest msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">body</span> <span class="operator">=</span> encode0(ctx,msg.getBody());</span><br><span class="line">        <span class="type">FullHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> msg.getRequest();</span><br><span class="line">        <span class="keyword">if</span> (request==<span class="literal">null</span>)&#123;</span><br><span class="line">            request = <span class="keyword">new</span> <span class="title class_">DefaultFullHttpRequest</span>(HttpVersion.HTTP_1_1, HttpMethod.GET,<span class="string">&quot;/do&quot;</span>,body);</span><br><span class="line">            <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> request.headers();</span><br><span class="line">            headers.set(HttpHeaderNames.HOST, InetAddress.getLocalHost().getHostAddress());</span><br><span class="line">            headers.set(HttpHeaderNames.CONNECTION, HttpHeaderValues.CLOSE);</span><br><span class="line">            headers.set(HttpHeaderNames.ACCEPT_ENCODING,HttpHeaderValues.GZIP.toString()+<span class="string">&#x27;,&#x27;</span>+HttpHeaderValues.DEFLATE.toString());</span><br><span class="line">            headers.set(HttpHeaderNames.ACCEPT_CHARSET,<span class="string">&quot;ISO-8859-1,utf-8;q=0.7,*;q=0.7&quot;</span>);</span><br><span class="line">            headers.set(HttpHeaderNames.ACCEPT_LANGUAGE,<span class="string">&quot;zh&quot;</span>);</span><br><span class="line">            headers.set(HttpHeaderNames.USER_AGENT,<span class="string">&quot;Netty xml http client side&quot;</span>);</span><br><span class="line">            headers.set(HttpHeaderNames.ACCEPT,<span class="string">&quot;text/html,application/xhtml+xml,application/xml,q=0.9,*/*;q=0.8&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        HttpUtil.setContentLength(request,body.readableBytes());</span><br><span class="line">        out.add(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端响应消息编码器，吧响应消息数据对象编码为XML</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpXmlResponseEncoder</span> <span class="keyword">extends</span> <span class="title class_">AbstractHttpXmlEncoder</span>&lt;HttpXmlResponse&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, HttpXmlResponse msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> encode0(ctx,msg.getBody());</span><br><span class="line">        <span class="type">FullHttpResponse</span> <span class="variable">fullHttpResponse</span> <span class="operator">=</span> msg.getHttpResponse();</span><br><span class="line">        <span class="keyword">if</span> (fullHttpResponse == <span class="literal">null</span>) &#123;</span><br><span class="line">            fullHttpResponse = <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, HttpResponseStatus.OK,buf);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            fullHttpResponse  = <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(fullHttpResponse.protocolVersion(),fullHttpResponse.status(),</span><br><span class="line">                    fullHttpResponse.content());</span><br><span class="line">        &#125;</span><br><span class="line">        fullHttpResponse.headers().set(HttpHeaderNames.CONTENT_TYPE,<span class="string">&quot;text/xml&quot;</span>);</span><br><span class="line">        HttpUtil.setContentLength(fullHttpResponse,buf.readableBytes());</span><br><span class="line">        out.add(fullHttpResponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpXmlServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">HttpXmlServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpXmlServer</span>();</span><br><span class="line">        server.start(<span class="number">8081</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-aggregator&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65535</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-response-xml-decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpXmlRequestDecoder</span>(Order.class,<span class="literal">true</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpResponseEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-response-xml-encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpXmlResponseEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;XML-server-handler&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpXmlServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> serverBootstrap.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port)).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpXmlServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;HttpXmlRequest&gt;&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, HttpXmlRequest msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">HttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> msg.getRequest();</span><br><span class="line">            <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> (Order) msg.getBody();</span><br><span class="line">            System.out.println(<span class="string">&quot;http XML Server receive order is :\r\n&quot;</span>+order.toString());</span><br><span class="line">            dobussiness(order);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">HttpXmlResponse</span>(<span class="literal">null</span>,order));</span><br><span class="line">            <span class="keyword">if</span> (!HttpUtil.isKeepAlive(request))&#123;</span><br><span class="line">                f.addListener(<span class="keyword">new</span> <span class="title class_">GenericFutureListener</span>&lt;Future&lt;? <span class="built_in">super</span> Void&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(Future&lt;? <span class="built_in">super</span> Void&gt; future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        ctx.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (ctx.channel().isActive())&#123;</span><br><span class="line">                sendError(ctx,HttpResponseStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dobussiness</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">            order.setTotal(<span class="number">10f</span>);</span><br><span class="line">            order.setCustomer(OrderFactory.createCustomer(<span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendError</span><span class="params">(ChannelHandlerContext ctx, HttpResponseStatus status)</span> &#123;</span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1,status,</span><br><span class="line">                    Unpooled.copiedBuffer(<span class="string">&quot;Failure:&quot;</span>+status.toString()+<span class="string">&quot;\r\n&quot;</span>, CharsetUtil.UTF_8));</span><br><span class="line">            response.headers().set(HttpHeaderNames.CONTENT_TYPE,<span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">            ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在服务端的代码中，实现HTTP+XML 自动编解码，其核心主要是请求消息的解码器和响应消息编码器的实现，并且把边编解码器添加到 pipeline 中。</p>
<p><strong>3、客户端 HTTP+XML 编解码器开发</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务端接收请求解码器，把XML 消息通过Jibx 解码为指定的消息体实例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpXmlRequestDecoder</span> <span class="keyword">extends</span> <span class="title class_">AbstractHttpXmlDecoder</span>&lt;FullHttpRequest&gt; &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">HttpXmlRequestDecoder</span><span class="params">(Class&lt;?&gt; aClass)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(aClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpXmlRequestDecoder</span><span class="params">(Class&lt;?&gt; aClass, <span class="type">boolean</span> isPrint)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(aClass, isPrint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (!msg.decoderResult().isSuccess())&#123;</span><br><span class="line">            sendError(ctx,HttpResponseStatus.BAD_REQUEST);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">HttpXmlRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpXmlRequest</span>(msg,decode0(ctx,msg.content()));</span><br><span class="line">        out.add(request);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendError</span><span class="params">(ChannelHandlerContext ctx, HttpResponseStatus status)</span> &#123;</span><br><span class="line">        <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1,status,</span><br><span class="line">                Unpooled.copiedBuffer(<span class="string">&quot;Failure:&quot;</span>+status.toString()+<span class="string">&quot;\r\n&quot;</span>, CharsetUtil.UTF_8));</span><br><span class="line">        response.headers().set(HttpHeaderNames.CONTENT_TYPE,<span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">        ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应消息解码器，接收到服务端消息时自动解码，解码为指定的Class 实例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpXmlResponseDecoder</span> <span class="keyword">extends</span> <span class="title class_">AbstractHttpXmlDecoder</span>&lt;FullHttpResponse&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpXmlResponseDecoder</span><span class="params">(Class&lt;?&gt; aClass)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(aClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpXmlResponseDecoder</span><span class="params">(Class&lt;?&gt; aClass, <span class="type">boolean</span> isPrint)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(aClass, isPrint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, FullHttpResponse msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpXmlResponse</span> <span class="variable">httpXmlResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpXmlResponse</span>(msg,decode0(ctx,msg.content()));</span><br><span class="line">        out.add(httpXmlResponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpXmlClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">HttpXmlClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpXmlClient</span>();</span><br><span class="line">        client.connect(<span class="number">8081</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">loopGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(loopGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY,<span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpResponseDecoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-aggregator&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65535</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-response-xml-decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpXmlResponseDecoder</span>(Order.class,<span class="literal">true</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpRequestEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-request-xml-encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpXmlRequestEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-xml-handler&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpXmlClientHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port)).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            loopGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">HttpXmlClientHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;HttpXmlResponse&gt;&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">HttpXmlRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpXmlRequest</span>(<span class="literal">null</span>, OrderFactory.createOrder(<span class="number">123</span>));</span><br><span class="line">            ctx.writeAndFlush(request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, HttpXmlResponse msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;http xml client receive msg header is : &quot;</span>+msg.getHttpResponse().headers().names());</span><br><span class="line">            System.out.println(<span class="string">&quot;http xml client receive msg is : &quot;</span>+msg.getBody());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (ctx.channel().isActive())&#123;</span><br><span class="line">                ctx.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>与服务端代码类似，需要实现编解码器并且添加到 pipeline 中，最终的运行效果如下：</p>
<p><img src="/../assets/blogImg/Netty/10-5.png" alt="10-5"></p>
<p><img src="/../assets/blogImg/Netty/10-6.png" alt="10-6"></p>
<h4 id="10-4、Netty-HTTP-JSON-协议开发"><a href="#10-4、Netty-HTTP-JSON-协议开发" class="headerlink" title="10.4、Netty HTTP+JSON 协议开发"></a>10.4、Netty HTTP+JSON 协议开发</h4><p> 在接下来的例程中，使用了 fastjson 框架来实现 json 的序列化以及反序列化</p>
<p>与 HTTP+XML 类似的，客户端和服务端同样需要实现自定义的编解码器，在编解码器中需要用fastjson 来实现序列化和反序列化，其中代码实现如下：</p>
<h5 id="10-4-1、HTTP-JSON-协议栈服务端以及编码器的实现"><a href="#10-4-1、HTTP-JSON-协议栈服务端以及编码器的实现" class="headerlink" title="10.4.1、HTTP+JSON 协议栈服务端以及编码器的实现"></a>10.4.1、HTTP+JSON 协议栈服务端以及编码器的实现</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务端请求消息解码器实现，把json 数据反序列化。</span></span><br><span class="line"><span class="comment"> * 为了方便实现，没有将数据反序列化为具体数据，仍按String 来传递，将数据交给下一级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpJsonRequestDecoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageDecoder</span>&lt;FullHttpRequest&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CHARSET_NAME</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Charset</span> <span class="variable">UTF_8</span> <span class="operator">=</span> Charset.forName(CHARSET_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (!msg.decoderResult().isSuccess())&#123;</span><br><span class="line">            sendError(ctx, HttpResponseStatus.BAD_REQUEST);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> msg.content().toString(UTF_8);</span><br><span class="line">        <span class="keyword">if</span> (!JSON.isValidObject(content))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求内容非JSON数据格式&quot;</span>);</span><br><span class="line">            sendError(ctx,HttpResponseStatus.BAD_REQUEST);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">HttpTextRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpTextRequest</span>(msg,content);</span><br><span class="line">        out.add(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendError</span><span class="params">(ChannelHandlerContext ctx, HttpResponseStatus status)</span> &#123;</span><br><span class="line">        <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1,status,</span><br><span class="line">                Unpooled.copiedBuffer(<span class="string">&quot;Failure:&quot;</span>+status.toString()+<span class="string">&quot;\r\n&quot;</span>, CharsetUtil.UTF_8));</span><br><span class="line">        response.headers().set(HttpHeaderNames.CONTENT_TYPE,<span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">        ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务端编码器实现，把具体响应数据对象序列化为 json 数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpJsonResponseEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageEncoder</span>&lt;HttpTextResponse&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CHARSET_NAME</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Charset</span> <span class="variable">UTF_8</span> <span class="operator">=</span> Charset.forName(CHARSET_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, HttpTextResponse msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> msg.getFullHttpResponse();</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.copiedBuffer(JSON.toJSONString(msg.getBody()),UTF_8);</span><br><span class="line">        <span class="keyword">if</span> (response==<span class="literal">null</span>)&#123;</span><br><span class="line">            response = <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1,HttpResponseStatus.OK,buf);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            response  = <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(response.protocolVersion(),response.status(),</span><br><span class="line">                    response.content());</span><br><span class="line">        &#125;</span><br><span class="line">        response.headers().set(HttpHeaderNames.CONTENT_TYPE,<span class="string">&quot;text/json&quot;</span>);</span><br><span class="line">        HttpUtil.setContentLength(response,buf.readableBytes());</span><br><span class="line">        out.add(response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// json 消息服务端实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpJsonServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">HttpJsonServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpJsonServer</span>();</span><br><span class="line">        server.start(<span class="number">8081</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-aggregator&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65535</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-response-json-decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpJsonRequestDecoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpResponseEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-response-json-encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpJsonResponseEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;json-server-handler&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpJsonServerHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> serverBootstrap.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port)).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 经过上层各种处理器出后，处理最终的数据，负责网络 IO 事件的具体处理</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpJsonServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;HttpTextRequest&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, HttpTextRequest msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">HttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> msg.getRequest();</span><br><span class="line">            <span class="type">String</span> <span class="variable">orderStr</span> <span class="operator">=</span> (String) msg.getBody();</span><br><span class="line">            System.out.println(<span class="string">&quot;http json Server receive order is :\r\n&quot;</span>+ orderStr);</span><br><span class="line">            <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> JSON.parseObject(orderStr,Order.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;deserializable order is :\r\n&quot;</span>+ order.toString());</span><br><span class="line">            dobussiness(order);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">HttpTextResponse</span>(<span class="literal">null</span>,order));</span><br><span class="line">            <span class="keyword">if</span> (!HttpUtil.isKeepAlive(request))&#123;</span><br><span class="line">                f.addListener(<span class="keyword">new</span> <span class="title class_">GenericFutureListener</span>&lt;Future&lt;? <span class="built_in">super</span> Void&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(Future&lt;? <span class="built_in">super</span> Void&gt; future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        ctx.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dobussiness</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">            order.setTotal(<span class="number">112f</span>);</span><br><span class="line">            order.setCustomer(OrderFactory.createCustomer(<span class="number">11</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (ctx.channel().isActive())&#123;</span><br><span class="line">                sendError(ctx, HttpResponseStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendError</span><span class="params">(ChannelHandlerContext ctx, HttpResponseStatus status)</span> &#123;</span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1,status,</span><br><span class="line">                    Unpooled.copiedBuffer(<span class="string">&quot;Failure:&quot;</span>+status.toString()+<span class="string">&quot;\r\n&quot;</span>, CharsetUtil.UTF_8));</span><br><span class="line">            response.headers().set(HttpHeaderNames.CONTENT_TYPE,<span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">            ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="10-4-2、HTTP-JSON协议栈客户端和编解码器开发"><a href="#10-4-2、HTTP-JSON协议栈客户端和编解码器开发" class="headerlink" title="10.4.2、HTTP+JSON协议栈客户端和编解码器开发"></a>10.4.2、HTTP+JSON协议栈客户端和编解码器开发</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求消息编码器，把请求数据对象序列化为json 数据，以及添加自定义请求头数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpJsonRequestEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageEncoder</span>&lt;HttpTextRequest&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CHARSET_NAME</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Charset</span> <span class="variable">UTF_8</span> <span class="operator">=</span> Charset.forName(CHARSET_NAME);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, HttpTextRequest msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FullHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> msg.getRequest();</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">body</span> <span class="operator">=</span> Unpooled.copiedBuffer(JSON.toJSONString(msg.getBody()),UTF_8);</span><br><span class="line">        <span class="keyword">if</span> (request==<span class="literal">null</span>)&#123;</span><br><span class="line">            request = <span class="keyword">new</span> <span class="title class_">DefaultFullHttpRequest</span>(HttpVersion.HTTP_1_1, HttpMethod.POST,<span class="string">&quot;/do&quot;</span>,body);</span><br><span class="line">            <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> request.headers();</span><br><span class="line">            headers.set(HttpHeaderNames.HOST, InetAddress.getLocalHost().getHostAddress());</span><br><span class="line">            headers.set(HttpHeaderNames.CONNECTION, HttpHeaderValues.CLOSE);</span><br><span class="line">            headers.set(HttpHeaderNames.ACCEPT_ENCODING,HttpHeaderValues.GZIP.toString()+<span class="string">&#x27;,&#x27;</span>+HttpHeaderValues.DEFLATE.toString());</span><br><span class="line">            headers.set(HttpHeaderNames.ACCEPT_CHARSET,<span class="string">&quot;ISO-8859-1,utf-8;q=0.7,*;q=0.7&quot;</span>);</span><br><span class="line">            headers.set(HttpHeaderNames.ACCEPT_LANGUAGE,<span class="string">&quot;zh&quot;</span>);</span><br><span class="line">            headers.set(HttpHeaderNames.USER_AGENT,<span class="string">&quot;Netty json http client side&quot;</span>);</span><br><span class="line">            headers.set(HttpHeaderNames.ACCEPT,<span class="string">&quot;text/html,application/json,q=0.9,*/*;q=0.8&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        HttpUtil.setContentLength(request,body.readableBytes());</span><br><span class="line">        out.add(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 客户端响应消息解码器，用于处理服务端响应的消息数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpJsonResponseDecoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageDecoder</span>&lt;FullHttpResponse&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CHARSET_NAME</span> <span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Charset</span> <span class="variable">UTF_8</span> <span class="operator">=</span> Charset.forName(CHARSET_NAME);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, FullHttpResponse msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpTextResponse</span> <span class="variable">httpTextResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpTextResponse</span>(msg,msg.content().toString(UTF_8));</span><br><span class="line">        out.add(httpTextResponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码的实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpJsonClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">HttpJsonClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpJsonClient</span>();</span><br><span class="line">        client.connect(<span class="number">8081</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">loopGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(loopGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY,<span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpResponseDecoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-aggregator&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65535</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-response-json-decoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpJsonResponseDecoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpRequestEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-request-json-encoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpJsonRequestEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-json-handler&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpJsonClientHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port)).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            loopGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpJsonClientHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;HttpTextResponse&gt;&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, HttpTextResponse msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;http json client receive msg header is : &quot;</span>+msg.getFullHttpResponse().headers().names());</span><br><span class="line">            System.out.println(<span class="string">&quot;http json client receive msg is :\r\n &quot;</span>+msg.getBody());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> OrderFactory.createOrder(<span class="number">10</span>);</span><br><span class="line">            <span class="type">HttpTextRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpTextRequest</span>(<span class="literal">null</span>, order);</span><br><span class="line">            ctx.writeAndFlush(request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (ctx.channel().isActive())&#123;</span><br><span class="line">                ctx.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="10-4-3、运行效果"><a href="#10-4-3、运行效果" class="headerlink" title="10.4.3、运行效果"></a>10.4.3、运行效果</h5><p><img src="/../assets/blogImg/Netty/10-7.png" alt="10-7"></p>
<p><img src="/../assets/blogImg/Netty/10-8.png" alt="10-8"></p>
<h3 id="十一、WebSocket-协议开发应用"><a href="#十一、WebSocket-协议开发应用" class="headerlink" title="十一、WebSocket 协议开发应用"></a>十一、WebSocket 协议开发应用</h3><h4 id="11-1、HTTP-协议的弊端"><a href="#11-1、HTTP-协议的弊端" class="headerlink" title="11.1、HTTP 协议的弊端"></a>11.1、HTTP 协议的弊端</h4><p>HTTP 协议的弊端主要如下：</p>
<ol>
<li>HTTP协议为半双工协议。半双工协议是指数据可以在客户端和服务端两个方向上传输，但是不能同时传输。意味着在同一时刻，只有一个方向的数据在传输。</li>
<li>HTTP消息冗长而繁琐。HTTP 消息包含消息头、消息体和换行符等，通常情况下采用文本传输，相比其他二进制通信协议，冗长而繁琐。</li>
<li>针对服务器推送的黑客攻击，比如长轮询。</li>
</ol>
<h4 id="11-2、WebSocket-入门"><a href="#11-2、WebSocket-入门" class="headerlink" title="11.2、WebSocket 入门"></a>11.2、WebSocket 入门</h4><p>WebSocket 是 HTML5 开始提供的一种浏览器和服务器间进行全双工通信的网络技术，WebSocket 设计出来的目的就是要取代轮询和 Comet 技术，使得客户端浏览器具备像C&#x2F;S 架构下桌面系统一样的实时通信能力。其于2011年被 IEFE 定为标准 RFC6455，WebSocket API 被 W3C  定位标准。在WebSocket API 中，浏览器和服务端只需做一个握手动作，然后就可以快速建立通信通道，接着互相传递数据。</p>
<p>特点：</p>
<ul>
<li>单一的TCP 链接，采用全双工模式通信</li>
<li>对代理、防火墙和路由透明</li>
<li>无头部信息、Cookie 和身份验证</li>
<li>无安全开销</li>
<li>通过<code>Ping/Pong</code> 帧保持链路激活</li>
<li>服务器可以主动传递消息给客户端，无需轮询。</li>
</ul>
<h5 id="11-2-1、WebSocket-链接建立"><a href="#11-2-1、WebSocket-链接建立" class="headerlink" title="11.2.1、WebSocket 链接建立"></a>11.2.1、WebSocket 链接建立</h5><p>建立 WebSocket 链接时，需要客户端浏览器向服务器发起握手请求，其中该请求为一个HTTP 请求。该请求与一般的HTTP 请求不同，包含了一些附加头部信息。其中附件头<code>Upgrade:websocket</code> 表明这是一个申请协议升级的HTTP 请求。同时请求头消息中还包含了<code>Sec-WebSocket-Key</code> ，这是随机字符串信息，服务端会根据这些信息构造一个 SHA-1 的信息摘要，把 <code>Sec-WebSocket-Key</code> 加上一个魔幻字符串，使用 SHA-1 加密，然后进行 BASE-64 编码，将结果作为<code>Sec-WebSocket-Accept</code> 头的值，返回给客户端。</p>
<p>请求头响应头如下图</p>
<p><img src="/../assets/blogImg/Netty/11-1.png" alt="11-1"></p>
<p><img src="/../assets/blogImg/Netty/11-2.png" alt="11-2"></p>
<h5 id="11-2-2、WebSocket-生命周期"><a href="#11-2-2、WebSocket-生命周期" class="headerlink" title="11.2.2、WebSocket 生命周期"></a>11.2.2、WebSocket 生命周期</h5><p>握手成功后，服务端和客户端就可以通过<code>message</code> 的方式进行通信，一个消息可以由一个或多个帧组成，WebSocket 并不一定特定对应一个网络层的帧，他可以被分割成多个帧或被合并。</p>
<p>帧都有自己对应的消息类型，属于同一个消息的多个帧具有相同类型的数据。</p>
<p><img src="/../assets/blogImg/Netty/11-3.png" alt="11-3"></p>
<h5 id="11-2-3、WebSocket-链接关闭"><a href="#11-2-3、WebSocket-链接关闭" class="headerlink" title="11.2.3、WebSocket 链接关闭"></a>11.2.3、WebSocket 链接关闭</h5><p>为关闭 WebSocket 连接，客户端和服务端需要一个安全的方法关闭底层TCP 连接和 TLS回话。如果合适，丢弃任何可能已经接收的字节，必要时（受到攻击）可以通过任何手段关闭连接。</p>
<p>底层 TCP 连接，在正常情况下，应首先由服务器关闭。异常情况下，可由客户端发起 TCP Close，因此，当服务器被指示关闭 WebSocket 连接时，它应立即发起一个TCP Close 操作，客户端应该等待服务器的 TCP Close 。</p>
<h4 id="11-3、Netty-WebSocket-协议开发"><a href="#11-3、Netty-WebSocket-协议开发" class="headerlink" title="11.3、Netty WebSocket 协议开发"></a>11.3、Netty WebSocket 协议开发</h4><p>Netty 基于 HTTP 协议栈开发了 WebSocket 协议栈，利用 Netty 的 WebSocket 的协议栈可以非常方便的开发出 WebSocket 的服务端和客户端。</p>
<p>下面将通过一个小例程来实现 Netty WebSocket 的客户端和服务端的开发，其主要功能为：客户端发送消息到服务端，服务端对请求消息进行判断，如果是合法的 WebSocket 消息，则响应返回 Netty WebSocket 服务端消息以及时间。</p>
<h5 id="11-3-1、WebSocket-服务端开发"><a href="#11-3-1、WebSocket-服务端开发" class="headerlink" title="11.3.1、WebSocket 服务端开发"></a>11.3.1、WebSocket 服务端开发</h5><p>利用Netty 开发WebSocket 服务端的关键是网络 I&#x2F;O 事件处理器handler，其中在 handler 处理的事件有:</p>
<ul>
<li>判断区分 HTTP请求和 WebSocke 请求，因为第一次请求握手消息是由HTTP 协议承载；</li>
<li>如果是 HTTP 握手请求，则根据通过握手工厂类<code>WebSocketServerHandshakerFactory</code> 创建握手处理类<code>WebSocketServerHandshaker</code> 实例；其中握手处理了中的<code>handshake</code> 方法会将 websocket的编辑码类动态的添加到 ChannelPipeline</li>
<li>链路建立成功后，客户端提交文本到服务端，服务端分别判断，是否是关闭连接、是否为 ping 指令消息，是否是支持的文本消息，然后做出响应，返回给客户端。</li>
</ul>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>();</span><br><span class="line">        webSocketServer.bind(<span class="number">8082</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup,workGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-codec&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-aggregator&quot;</span>,<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65535</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;http-chuncked&quot;</span>,<span class="keyword">new</span> <span class="title class_">ChunkedWriteHandler</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;websocket-handler&quot;</span>,<span class="keyword">new</span> <span class="title class_">WebSocketHandler</span>(port));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> serverBootstrap.bind(port).sync().channel();</span><br><span class="line">            System.out.println(<span class="string">&quot;websocket sart at prot:&quot;</span>+port);</span><br><span class="line">            System.out.println(<span class="string">&quot;please open your web browser and navigate to : http://localhost:&quot;</span>+port+<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            channel.closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;Object&gt;&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">        <span class="comment">// 处理 websocket 握手请求</span></span><br><span class="line">        <span class="keyword">private</span> WebSocketServerHandshaker handshaker;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">WebSocketHandler</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.port = port;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;server receive msg:&quot;</span>+msg);</span><br><span class="line">            <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> FullHttpRequest)&#123;</span><br><span class="line">                <span class="comment">// 传统 Http 请求接入</span></span><br><span class="line">                handlerHttpRequest(ctx,(FullHttpRequest)msg);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> WebSocketFrame)&#123;</span><br><span class="line">                <span class="comment">// websocket 接入</span></span><br><span class="line">                handlerWebSocketFrame(ctx,(WebSocketFrame)msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlerHttpRequest</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest msg)</span> &#123;</span><br><span class="line">            <span class="comment">// Http 解码失败或者不是请求建立 websocket 连接的http 请求，返回请求失败</span></span><br><span class="line">            <span class="keyword">if</span> (!msg.decoderResult().isSuccess() || !<span class="string">&quot;websocket&quot;</span>.equals(msg.headers().get(<span class="string">&quot;Upgrade&quot;</span>)))&#123;</span><br><span class="line">                sendHttpResponse(ctx,msg,<span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1,HttpResponseStatus.BAD_REQUEST));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 构造握手请求响应</span></span><br><span class="line">            <span class="type">WebSocketServerHandshakerFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketServerHandshakerFactory</span>(<span class="string">&quot;ws://localhost:&quot;</span>+port+<span class="string">&quot;/websocket&quot;</span>,</span><br><span class="line">                    <span class="literal">null</span>,<span class="literal">false</span>);</span><br><span class="line">            handshaker = factory.newHandshaker(msg);</span><br><span class="line">            <span class="keyword">if</span> (handshaker==<span class="literal">null</span>)&#123;</span><br><span class="line">                WebSocketServerHandshakerFactory.sendUnsupportedVersionResponse(ctx.channel());</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                handshaker.handshake(ctx.channel(),msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理 websocket 帧</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlerWebSocketFrame</span><span class="params">(ChannelHandlerContext ctx, WebSocketFrame msg)</span> &#123;</span><br><span class="line">            <span class="comment">// 判断是否为关闭 websocket 链路指令</span></span><br><span class="line">            <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> CloseWebSocketFrame)&#123;</span><br><span class="line">                handshaker.close(ctx.channel(),((CloseWebSocketFrame) msg).retain());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 判断是否为 ping 指令消息</span></span><br><span class="line">            <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> PingWebSocketFrame)&#123;</span><br><span class="line">                ctx.channel().write(<span class="keyword">new</span> <span class="title class_">PongWebSocketFrame</span>(msg.content().retain()));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 本例程仅支持文本消息，不支持二进制消息</span></span><br><span class="line">            <span class="keyword">if</span> (!(msg <span class="keyword">instanceof</span> TextWebSocketFrame))&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(String.format(<span class="string">&quot;%s frame types ne supported.&quot;</span>,msg.getClass().getName()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 返回应答消息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> ((TextWebSocketFrame) msg).text();</span><br><span class="line">            System.out.println(ctx.channel()+<span class="string">&quot; recived client message: \r\n&quot;</span>+text);</span><br><span class="line">            ctx.channel().writeAndFlush(<span class="keyword">new</span> <span class="title class_">TextWebSocketFrame</span>(text+<span class="string">&quot;,欢迎使用 Netty WebSocket 服务，现在时间：&quot;</span></span><br><span class="line">                    + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>))));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendHttpResponse</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest req, FullHttpResponse resp)</span>&#123;</span><br><span class="line">            <span class="comment">// 返回应答给客户端</span></span><br><span class="line">            <span class="keyword">if</span> (resp.status().code()==<span class="number">200</span>)&#123;</span><br><span class="line">                <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.copiedBuffer(resp.status().code()+<span class="string">&quot;&quot;</span>, CharsetUtil.UTF_8);</span><br><span class="line">                resp.content().writeBytes(buf);</span><br><span class="line">                buf.release();</span><br><span class="line">                HttpUtil.setContentLength(resp,resp.content().readableBytes());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> ctx.writeAndFlush(resp);</span><br><span class="line">            <span class="comment">// 如果非 keep-alive, 关闭连接</span></span><br><span class="line">            <span class="keyword">if</span> (!HttpUtil.isKeepAlive(req) || resp.status().code()!=<span class="number">200</span>)&#123;</span><br><span class="line">                f.addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (ctx.channel().isActive())&#123;</span><br><span class="line">                ctx.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行效果如下</p>
<p><img src="/../assets/blogImg/Netty/11-4.png" alt="11-4"></p>
<p><img src="/../assets/blogImg/Netty/11-5.png" alt="11-5"></p>
<h4 id="11-4、Netty-UDP-协议开发"><a href="#11-4、Netty-UDP-协议开发" class="headerlink" title="11.4、Netty UDP 协议开发"></a>11.4、Netty UDP 协议开发</h4><p>用户数据报协议（User Datagram Protocol，UDP）是一种传输层协议。在 TCP&#x2F;IP 网络中，它与 TCP 协议一样用于处理数据包，是一种无连接的协议。</p>
<p>TCP 协议在进行数据传输时，需要建立连接，并且每次传输的数据都需要进行确认。当不再进行传输数据时，还需要断开连接。这样做虽然安全，但是效率较低。而 UDP 协议正好避免了这些过程，它是一种没有复杂控制，提供面向无连接的通信服务协议。</p>
<p>UDP 协议具备以下特点：</p>
<ul>
<li>没有各种连接：在传输数据前不需要建立连接，也避免了后续的断开连接。</li>
<li>不重新排序：对到达顺序混乱的数据包不进行重新排序。</li>
<li>没有确认：发送数据包无须等待对方确认。因此，使用 UDP 协议可以随时发送数据，但无法保证数据能否成功被目标主机接收。</li>
</ul>
<h5 id="11-4-1、UDP-服务端开发"><a href="#11-4-1、UDP-服务端开发" class="headerlink" title="11.4.1、UDP 服务端开发"></a>11.4.1、UDP 服务端开发</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyUdpServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">NettyUdpServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyUdpServer</span>();</span><br><span class="line">        server.bind(<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup)</span><br><span class="line">                    <span class="comment">// 指定通道类型为 NioDatagramChannel</span></span><br><span class="line">                    .channel(NioDatagramChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BROADCAST,<span class="literal">true</span>)</span><br><span class="line">                    <span class="comment">//UDP相对于TCP不需要在客户端和服务端建立实际的连接，因此不需要为连接（ChannelPipeline）设置handler</span></span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">NettyUdpServerHandler</span>());</span><br><span class="line">            serverBootstrap.bind(port).sync().channel().closeFuture().await();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyUdpServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;DatagramPacket&gt;&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, DatagramPacket msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> msg.content().toString(CharsetUtil.UTF_8);</span><br><span class="line">            System.out.println(<span class="string">&quot;收到客户端消息为：&quot;</span>+content);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;udp-req&quot;</span>.equals(content))&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">respStr</span> <span class="operator">=</span> <span class="string">&quot;欢迎使用UDP服务，盲盒开奖成功！&quot;</span>;</span><br><span class="line">                <span class="type">DatagramPacket</span> <span class="variable">respPacket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(Unpooled.copiedBuffer(respStr,CharsetUtil.UTF_8),msg.sender());</span><br><span class="line">                ctx.writeAndFlush(respPacket);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            ctx.close();</span><br><span class="line">            cause.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="11-4-2、UDP-客户端开发"><a href="#11-4-2、UDP-客户端开发" class="headerlink" title="11.4.2、UDP 客户端开发"></a>11.4.2、UDP 客户端开发</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyUdpClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">NettyUdpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyUdpClient</span>();</span><br><span class="line">        client.connect(<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">loopGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(loopGroup)</span><br><span class="line">                    .option(ChannelOption.SO_BROADCAST,<span class="literal">true</span>)</span><br><span class="line">                    .channel(NioDatagramChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ClientUdpHandler</span>());</span><br><span class="line"></span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> bootstrap.bind(<span class="number">8081</span>).sync().channel();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//向网段内的所有机器广播</span></span><br><span class="line">            channel.writeAndFlush(<span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(Unpooled.copiedBuffer(<span class="string">&quot;udp-req&quot;</span>,CharsetUtil.UTF_8),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;255.255.255.255&quot;</span>,port)));</span><br><span class="line">            <span class="comment">//客户端等待15s用于接收服务端的应答消息，然后退出并释放资源</span></span><br><span class="line">            <span class="keyword">if</span>(!channel.closeFuture().await(<span class="number">15000</span>))&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;请求超时！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            loopGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ClientUdpHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;DatagramPacket&gt;&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, DatagramPacket msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> msg.content().toString(CharsetUtil.UTF_8);</span><br><span class="line">            System.out.println(<span class="string">&quot;client receive msg is : &quot;</span>+content);</span><br><span class="line">            ctx.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            ctx.close();</span><br><span class="line">            cause.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="十二、私有协议栈开发"><a href="#十二、私有协议栈开发" class="headerlink" title="十二、私有协议栈开发"></a>十二、私有协议栈开发</h3><p>广义上区分，通信协议可以分为共有协议和私有协议。由于私有协议的灵活性，和时候在公司或者组织内部使用，按需定制，升级方便，灵活性好。绝大多数私有协议传输层基于TCP&#x2F;IP，利用 Netty 的 NIO TCP 协议栈可以非常方便地进行私有协议的定制和开发。</p>
<h4 id="12-1、私有协议介绍"><a href="#12-1、私有协议介绍" class="headerlink" title="12.1、私有协议介绍"></a>12.1、私有协议介绍</h4><p>私有协议本质上是厂商内部发展和才有的标准，除非授权，其他厂商一般无权限使用该协议。私有协议具有封闭性、垄断性、排他性等特点。其设计初衷并非是为了垄断，而主要是为了解决企业软件系统各个模块之间的跨节点通信问题。</p>
<p>在 Java 传统应用中，通常使用以下4中方式进行跨节点通信。</p>
<ul>
<li>通过 RMI 进行远程服务调用</li>
<li>通过 Java 的 Socket+Java 序列化方式进行跨节点调用</li>
<li>利用一些开源的 RPC 框架进行远程服务调用，如 Facebook 的 Thrift 、Apache 的 Avro 等</li>
<li>利用标准的公有协议进行跨节点服务调用，如：HTTP+XML、RESTful + JSON、WebService 等。</li>
</ul>
<p>跨节点的远程服务调用，除了链路层的物理连接外，还需要对请求和响应消息的编解码。在请求和应答消息之外，还需要携带一些其他控制和管理指令。如链路的握手请求和响应消息、链路检测的心跳消息等。这些功能组合到一起，就形成了私有协议。</p>
<p>事实上，私有协议并没有标准的定义，只要能拥有跨进程、跨主机数据交换的非标准协议，都可以被称为私有协议。</p>
<h4 id="12-2、Netty-协议栈功能设计"><a href="#12-2、Netty-协议栈功能设计" class="headerlink" title="12.2、Netty 协议栈功能设计"></a>12.2、Netty 协议栈功能设计</h4><p>Netty 协议栈用于内部各模块之间的通信，它基于TCP&#x2F;IP 协议栈，是一个类HTTP协议的应用层协议，相比传统的标准协议栈，它更加轻巧、灵活和实用。</p>
<h5 id="12-2-1、网络拓扑图"><a href="#12-2-1、网络拓扑图" class="headerlink" title="12.2.1、网络拓扑图"></a>12.2.1、网络拓扑图</h5><p><img src="/../assets/blogImg/Netty/12-1.png" alt="12-1"></p>
<ul>
<li>每个Netty 节点（Netty 进程）之间建立长连接， 使用 Netty 协议进行通信。</li>
<li>一个Netty 节点既可以作为客户端连接另外的Netty节点，也可以作为Netty服务端被其他Netty 节点连接。</li>
</ul>
<h5 id="12-2-2、协议栈功能描述"><a href="#12-2-2、协议栈功能描述" class="headerlink" title="12.2.2、协议栈功能描述"></a>12.2.2、协议栈功能描述</h5><p>Netty 协议栈承载了业务内部各模块之间的消息交互和服务调用，它的主要功能如下：</p>
<ul>
<li>基于Netty 的 NIO 通信，提供高性能异步通信能力</li>
<li>提供消息编解码框架，实现 POJO 的序列化和反序列化</li>
<li>提供基于IP地址的白名单接入认证机制</li>
<li>链路的有效性验证机制</li>
<li>链路断连重试机制</li>
</ul>
<h5 id="12-2-3、通讯模型"><a href="#12-2-3、通讯模型" class="headerlink" title="12.2.3、通讯模型"></a>12.2.3、通讯模型</h5><p><img src="/../assets/blogImg/Netty/12-2.png" alt="12-2"></p>
<ol>
<li>Netty 协议栈客户端发送握手请求消息，携带节点 ID 的有效身份验证信息；</li>
<li>Netty 协议栈服务端对握手请求消息进行合法性校验，包括节点 ID 有效性校验、节点重复登录校验和 IP地址合法性校验；</li>
<li>链路建立成功后，客户端发送业务消息</li>
<li>链路建立成功后，服务端发送心跳消息</li>
<li>链路建立成功后，客户端发送心跳消息</li>
<li>链路建立成功后，服务端发送业务消息</li>
<li>服务端退出关闭连接，客户端感知对方关闭连接，客户端被动关闭连接</li>
</ol>
<p>注意：双方的心跳采用 Ping-Pong 机制</p>
<h5 id="12-2-4、消息定义"><a href="#12-2-4、消息定义" class="headerlink" title="12.2.4、消息定义"></a>12.2.4、消息定义</h5><p>Netty 协议栈的消息主要有两部分</p>
<ul>
<li>消息头</li>
<li>消息体</li>
</ul>
<p>消息结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * netty 协议栈消息头</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> NettyMsgHeader headers;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * netty 协议栈消息体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Object body;</span><br></pre></td></tr></table></figure>

<p>消息头定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Netty消息校验码</span></span><br><span class="line"><span class="comment"> * 固定值 0xABEF 表名是 Netty 协议消息 2个字节</span></span><br><span class="line"><span class="comment"> * 主版本号：1-255  1个字节</span></span><br><span class="line"><span class="comment"> * 此版本好：1-255  1个字节</span></span><br><span class="line"><span class="comment"> * crc = 0xABEF + 主版本号 + 次版本号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> crcCode;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息长度，整个消息包括消息头和消息体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> length;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 会话id，集群内全局唯一</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> sessionID;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息类型</span></span><br><span class="line"><span class="comment"> * 0：业务请求</span></span><br><span class="line"><span class="comment"> * 1：业务响应</span></span><br><span class="line"><span class="comment"> * 2：业务 ONE WAY 消息(既是请求又是响应)</span></span><br><span class="line"><span class="comment"> * 3：握手请求消息</span></span><br><span class="line"><span class="comment"> * 4：握手应答消息</span></span><br><span class="line"><span class="comment"> * 5：心跳请求消息</span></span><br><span class="line"><span class="comment"> * 6：心跳应答消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">byte</span> type;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息优先级 1-255</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">byte</span> priority;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 可选字段，拓展请求头</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String,Object&gt; attachment;</span><br></pre></td></tr></table></figure>

<h5 id="12-2-5、Netty-消息字段支持的类型"><a href="#12-2-5、Netty-消息字段支持的类型" class="headerlink" title="12.2.5、Netty 消息字段支持的类型"></a>12.2.5、Netty 消息字段支持的类型</h5><p><img src="/../assets/blogImg/Netty/12-3.png" alt="12-3"></p>
<h5 id="12-2-6、Netty-协议的编码规范"><a href="#12-2-6、Netty-协议的编码规范" class="headerlink" title="12.2.6、Netty 协议的编码规范"></a>12.2.6、Netty 协议的编码规范</h5><p>对于NettyMessage 的编码，根据具体的数据类型调用 ByteBuffer 的方法来编码，如果请求头 header 的 int类型数据 crcCode 可以分别通过 <code>ByteBuffer.putInt</code> 和<code>ByteBuffer.getInt</code>来编解码，byte 类型数据 如 type 可以分别通过<code>ByteBuffer.put</code>和 <code>ByteBuffer.get</code>来实现编解码。</p>
<p>对于请求头中的 <code>attachment</code> 拓展属性字段数据的编解码的操作步骤相对多一些。它的编码规则首先判断是否有数据，如果不存在数据则写入编码长度 0，<code>ByteBuffer.putInt(0)</code>，如果有数据则写编码长度 <code>ByteBuffer.putInt(attachment.size())</code>。然后再对 key 编码，先编码长度，再编码 key 值数据。具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// attachment 编码过程</span></span><br><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">byte</span>[] value = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span>(Map.Entry&lt;String,Object&gt; entry : attachment.entrySet())&#123;</span><br><span class="line">    key = entry.getKey();</span><br><span class="line">    buffer.writeString(key);</span><br><span class="line">    value = marshaller.writeObject(entry.getValue());</span><br><span class="line">    buffer.writeBinary(value);</span><br><span class="line">&#125;</span><br><span class="line">key = <span class="literal">null</span>;</span><br><span class="line">value = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// attachment 解码过程</span></span><br><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">objVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++)&#123;</span><br><span class="line">    key = buffer.readString();</span><br><span class="line">    objVal = unmarshaller.readObject(buffer.readBinary());</span><br><span class="line">    <span class="built_in">this</span>.attachment.put(key,objVal);</span><br><span class="line">&#125;</span><br><span class="line">key = <span class="literal">null</span>;</span><br><span class="line">objVal = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h5 id="12-2-7、链路的建立"><a href="#12-2-7、链路的建立" class="headerlink" title="12.2.7、链路的建立"></a>12.2.7、链路的建立</h5><p>不区分客户端和服务端，一个节点既可以作为服务端也可以作为客户端，根据具体情况而定，先发起请求调用的一方节点作为客户端，被调用的作为服务端。</p>
<p>为了安全，使用基于 IP 地址黑白名单校验机制，如果有多个IP，通过逗号分割。实际商用环境可以通过密钥对用户名和密码加密以增加安全性。</p>
<h5 id="12-2-8、链路的关闭"><a href="#12-2-8、链路的关闭" class="headerlink" title="12.2.8、链路的关闭"></a>12.2.8、链路的关闭</h5><p>由于采用长链通信，在正常的业务运行期间，双方通过心跳和业务信息维持链路，任何一方都不需要主动关闭连接。</p>
<p>但是，以下情况，客户端和服务端需要关闭连接。</p>
<ol>
<li>当对方宕机或者重启时，会主动关闭链路，另一方读取到操作系统的通知信号，得知对方 RESET 链路，需要关闭连接，释放自身的句柄等资源。由于采用 TCP 全双工通信，通信双方都需要关闭连接，释放资源。</li>
<li>消息读写过程，发送 I&#x2F;O 异常，需要主动关闭连接</li>
<li>心跳消息读写过程发生 I&#x2F;O 异常，需要主动关闭连接</li>
<li>心跳超时，需要主动关闭连接</li>
<li>发送编码异常等不可恢复错误是，需要主动关闭连接。</li>
</ol>
<h5 id="12-2-9、可靠性设计"><a href="#12-2-9、可靠性设计" class="headerlink" title="12.2.9、可靠性设计"></a>12.2.9、可靠性设计</h5><p>可能会遇到恶劣的网络环境，如网络超时、闪断、或对方进程僵死等，为保证能在这种极端的网络环境下正常运行和自动恢复，我们需要对协议的可靠性进行设计和规划。</p>
<h6 id="心跳机制"><a href="#心跳机制" class="headerlink" title="心跳机制"></a>心跳机制</h6><p>在业务低谷时段，如果发生网络闪断、连接被Hang 住等网络问题时，由于没有业务消息，应用进程很难发现。到业务高峰期，会发送大量的网络通信失败，严重会导致一段时间内进程无法处理业务信息。</p>
<p>为解决这个问题，在网络空闲时采用心跳机制来检测链路的互通性，一旦发现网络故障，立即关闭网络，主动重连。</p>
<p>设计思路：</p>
<ol>
<li>当网络处于空闲状态持续时间达到 <em>T</em> 时，客户端主动发送 Ping 心跳消息给服务端。</li>
<li>如果下一个周期 <em>T</em> 到来时客户端没有收到对方发送的 Pong 心跳应答消息或者读取到服务端发送的其他业务消息，则心跳失败计数器加1。</li>
<li>每当客户端接收到服务的业务消息或者 Pong 应答消息是，将心跳失败计算器清零； 连续 <em>N</em> 次没有接收到服务器端的 Pong 消息或者业务消息，则关闭链路，间隔 INTERVAL 时间后发起重连操作。</li>
<li>服务端网络空闲状态时间达到 <em>T</em> 后，服务端将心跳失败计数器加1,；只要接收到客户端发送的 Ping 消息或者其他业务消息，计数器清零。</li>
<li>服务端连续 <em>N</em> 次没有接收到客户端的 Ping 消息或者其他业务消息，则关闭链路释放资源，等待客户端重连。</li>
</ol>
<h6 id="重连机制"><a href="#重连机制" class="headerlink" title="重连机制"></a>重连机制</h6><p>如果链路中断，等待 INTERVAL 时间后，客户端发起重连操作，如果重连失败，间隔周期 INTERVAL 后再次发起重连，直到重连成功。间隔 INTERVAL 时间再发起重连主要是保证句柄资源能够及时释放。</p>
<h6 id="重复登录保护"><a href="#重复登录保护" class="headerlink" title="重复登录保护"></a>重复登录保护</h6><p>当客户端握手成功之后，在链路正常状态下，不允许客户端重复登录，防止客户端在异常状态下反复重连导致句柄资源被耗尽。</p>
<p>服务端接收到客户端的握手请求消息后，首先对 IP 地址进行合法性校验，如果校验成功，在缓存地址表查看客户端是否已经登录，如果已经登录，则拒绝重复登录。</p>
<p>为了防止有服务端和客户端对链路状态理解不一致导致客户端无法握手成功的问题，当服务端连续 <em>N</em> 次心跳超时之后需要主动关闭链路，清空改客户端的地址缓存信息，保证后续该客户端可以重连成功，防止被重复登录保护机制拒绝掉。</p>
<h6 id="消息缓存重发"><a href="#消息缓存重发" class="headerlink" title="消息缓存重发"></a>消息缓存重发</h6><p>无论客户端还是服务端，当链路发生中断之后，在链路恢复之前，缓存在消息队列中待发送的消息不能丢失，等链路恢复之后，重新发送这些消息，保证链路中断期间消息不丢失。</p>
<h4 id="12-3、Netty-协议栈开发"><a href="#12-3、Netty-协议栈开发" class="headerlink" title="12.3、Netty 协议栈开发"></a>12.3、Netty 协议栈开发</h4><h5 id="12-3-1、数据结构定义"><a href="#12-3-1、数据结构定义" class="headerlink" title="12.3.1、数据结构定义"></a>12.3.1、数据结构定义</h5><p>自定义消息体数据结构定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyMessage</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * netty 协议栈消息头</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> NettyMsgHeader headers;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * netty 协议栈消息体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object body;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> NettyMsgHeader <span class="title function_">getHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> headers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHeaders</span><span class="params">(NettyMsgHeader headers)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.headers = headers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getBody</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBody</span><span class="params">(Object body)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.body = body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;NettyMessage&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;headers=&quot;</span> + headers +</span><br><span class="line">                <span class="string">&quot;, body=&quot;</span> + body +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 消息头</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyMsgHeader</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Netty消息校验码</span></span><br><span class="line"><span class="comment">     * 固定值 0xABEF 表名是 Netty 协议消息 2个字节</span></span><br><span class="line"><span class="comment">     * 主版本号：1-255  1个字节</span></span><br><span class="line"><span class="comment">     * 此版本好：1-255  1个字节</span></span><br><span class="line"><span class="comment">     * crc = 0xABEF + 主版本号 + 次版本号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">crcCode</span> <span class="operator">=</span> <span class="number">0xabef0101</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息长度，整个消息包括消息头和消息体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> length;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 会话id，集群内全局唯一</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> sessionID;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息类型</span></span><br><span class="line"><span class="comment">     * 0：业务请求</span></span><br><span class="line"><span class="comment">     * 1：业务响应</span></span><br><span class="line"><span class="comment">     * 2：业务 ONE WAY 消息(既是请求又是响应)</span></span><br><span class="line"><span class="comment">     * 3：握手请求消息</span></span><br><span class="line"><span class="comment">     * 4：握手应答消息</span></span><br><span class="line"><span class="comment">     * 5：心跳请求消息</span></span><br><span class="line"><span class="comment">     * 6：心跳应答消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> type;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息优先级 1-255</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> priority;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 可选字段，拓展请求头</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Object&gt; attachment = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCrcCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> crcCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCrcCode</span><span class="params">(<span class="type">int</span> crcCode)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.crcCode = crcCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLength</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLength</span><span class="params">(<span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.length = length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getSessionID</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sessionID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSessionID</span><span class="params">(<span class="type">long</span> sessionID)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sessionID = sessionID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(<span class="type">byte</span> type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getPriority</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> priority;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPriority</span><span class="params">(<span class="type">byte</span> priority)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.priority = priority;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getAttachment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> attachment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAttachment</span><span class="params">(Map&lt;String, Object&gt; attachment)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.attachment = attachment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;NettyMsgHeader&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;crcCode=&quot;</span> + crcCode +</span><br><span class="line">                <span class="string">&quot;, length=&quot;</span> + length +</span><br><span class="line">                <span class="string">&quot;, sessionID=&quot;</span> + sessionID +</span><br><span class="line">                <span class="string">&quot;, type=&quot;</span> + type +</span><br><span class="line">                <span class="string">&quot;, priority=&quot;</span> + priority +</span><br><span class="line">                <span class="string">&quot;, attachment=&quot;</span> + attachment +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>握手请求、握手应答、心跳检测消息都可以通过该消息结构来承载，所以不需要单独定义独立的数据结构。</p>
<h5 id="12-3-2、消息编解码"><a href="#12-3-2、消息编解码" class="headerlink" title="12.3.2、消息编解码"></a>12.3.2、消息编解码</h5><p>在例程中，消息的编解码分别使用 NettyMessageEncoder和NettyMessageDecoder 来处理，其实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义编码器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyMessageEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToByteEncoder</span>&lt;NettyMessage&gt; &#123;</span><br><span class="line"></span><br><span class="line">    MarshallingEncoder marshallingEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyMessageEncoder</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        marshallingEncoder = <span class="keyword">new</span> <span class="title class_">MarshallingEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, NettyMessage msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg==<span class="literal">null</span> || msg.getHeaders()==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;The encode message is null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        out.writeInt(msg.getHeaders().getCrcCode());</span><br><span class="line">        out.writeInt(msg.getHeaders().getLength());</span><br><span class="line">        out.writeLong(msg.getHeaders().getSessionID());</span><br><span class="line">        out.writeByte(msg.getHeaders().getType());</span><br><span class="line">        out.writeByte(msg.getHeaders().getPriority());</span><br><span class="line">        Map&lt;String,Object&gt; attachmentMap = msg.getHeaders().getAttachment();</span><br><span class="line">        out.writeInt(attachmentMap.size());</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String,Object&gt; entry : attachmentMap.entrySet())&#123;</span><br><span class="line">            <span class="type">byte</span>[] key_arr = entry.getKey().getBytes(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            out.writeInt(key_arr.length);</span><br><span class="line">            out.writeBytes(key_arr);</span><br><span class="line">            marshallingEncoder.encode(entry.getValue(),out);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.getBody()==<span class="literal">null</span>)&#123;</span><br><span class="line">            out.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            marshallingEncoder.encode(msg.getBody(),out);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置 header.length 的值，重新设置整个消息的长度，包括消息头和消息体。</span></span><br><span class="line"><span class="comment">         * 因为解码器 &#123;<span class="doctag">@link</span> NettyMessageDecoder&#125; 是通过继承 &#123;<span class="doctag">@link</span> io.netty.handler.codec.LengthFieldBasedFrameDecoder&#125;</span></span><br><span class="line"><span class="comment">         * 自定义长度解码器来解决TCP粘包问题。</span></span><br><span class="line"><span class="comment">         * &lt;pre/&gt;</span></span><br><span class="line"><span class="comment">         * 此处减去 8 是因为：</span></span><br><span class="line"><span class="comment">         * 长度字段的位移位置为 4，长度字段本身所占的长度也为 4，帧长度的调整字段=0</span></span><br><span class="line"><span class="comment">         * 即：</span></span><br><span class="line"><span class="comment">         * lengthFieldOffset = 4</span></span><br><span class="line"><span class="comment">         * lengthFieldLength = 4</span></span><br><span class="line"><span class="comment">         * lengthAdjustment = 0</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 由 LengthFieldBasedFrameDecoder 源码可知 lengthFieldEndOffset = lengthFieldOffset + lengthFieldLength = 8</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 调节帧长度</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;frameLength += lengthAdjustment + lengthFieldEndOffset;&lt;p/&gt;</span></span><br><span class="line"><span class="comment">         * frameLength = 整个消息的长度，即从长度字段中读取出来的长度数据</span></span><br><span class="line"><span class="comment">         * 所以 -8 其作用相当于 lengthAdjustment=-8， 因为消息头部包含消息的长度，需要作出修正调整，避免读取消息不完整。</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        out.setInt(<span class="number">4</span>,out.readableBytes()-<span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义解码器</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> NettyMessageDecoder</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> netty message 解码器开发</span></span><br><span class="line"><span class="comment"> * 继承 &#123;<span class="doctag">@link</span> LengthFieldBasedFrameDecoder&#125;</span></span><br><span class="line"><span class="comment"> * 因为 LengthFieldBaseFrameDecoder 自动支持TCP 粘包和半包处理。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/9/23 14:09</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyMessageDecoder</span> <span class="keyword">extends</span> <span class="title class_">LengthFieldBasedFrameDecoder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MarshallingDecoder marshallingDecoder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyMessageDecoder</span><span class="params">(<span class="type">int</span> maxFrameLength, <span class="type">int</span> lengthFieldOffset, <span class="type">int</span> lengthFieldLength)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>(maxFrameLength, lengthFieldOffset, lengthFieldLength);</span><br><span class="line">        marshallingDecoder = <span class="keyword">new</span> <span class="title class_">MarshallingDecoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 调用父类解码方法，返回整包或者半空，为空的话，说明是个半包消息，直接返回由 IO线程 读取后续码流。</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">frame</span> <span class="operator">=</span> (ByteBuf) <span class="built_in">super</span>.decode(ctx, in);</span><br><span class="line">        <span class="keyword">if</span> (frame==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">NettyMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyMessage</span>();</span><br><span class="line">        <span class="type">NettyMsgHeader</span> <span class="variable">header</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyMsgHeader</span>();</span><br><span class="line">        header.setCrcCode(frame.readInt());</span><br><span class="line">        header.setLength(frame.readInt());</span><br><span class="line">        header.setSessionID(frame.readLong());</span><br><span class="line">        header.setType(frame.readByte());</span><br><span class="line">        header.setPriority(frame.readByte());</span><br><span class="line">        <span class="type">int</span> <span class="variable">attachmentMapSize</span> <span class="operator">=</span> frame.readInt();</span><br><span class="line">        <span class="keyword">if</span> (attachmentMapSize&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            Map&lt;String,Object&gt; attachmentMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="type">byte</span>[] key_arr = <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;attachmentMapSize; i++)&#123;</span><br><span class="line">                key_arr = <span class="keyword">new</span> <span class="title class_">byte</span>[frame.readInt()];</span><br><span class="line">                frame.readBytes(key_arr);</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(key_arr,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                value = marshallingDecoder.decode(in);</span><br><span class="line">                attachmentMap.put(key,value);</span><br><span class="line">            &#125;</span><br><span class="line">            key_arr=<span class="literal">null</span>;</span><br><span class="line">            value=<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        message.setHeaders(header);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (frame.readableBytes()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">body</span> <span class="operator">=</span> marshallingDecoder.decode(frame);</span><br><span class="line">            <span class="keyword">if</span> (body!=<span class="literal">null</span>)&#123;</span><br><span class="line">                message.setBody(body);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中使用了 Marshalling 来处理对象序列化和反序列化，其代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义的 Marshalling 编码器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarshallingEncoder</span>  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] LENGTH_PLACEHOLDER = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];</span><br><span class="line">    <span class="type">Marshaller</span> <span class="variable">marshaller</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MarshallingEncoder</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.marshaller = MarshallingCodeFactory.buildMarshaller();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(Object obj, ByteBuf out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">lengthPos</span> <span class="operator">=</span> out.writerIndex();</span><br><span class="line">        out.writeBytes(LENGTH_PLACEHOLDER);</span><br><span class="line">        <span class="type">ChannelBufferByteOutput</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChannelBufferByteOutput</span>(out);</span><br><span class="line">        marshaller.start(output);</span><br><span class="line">        marshaller.writeObject(obj);</span><br><span class="line">        marshaller.finish();</span><br><span class="line">        marshaller.close();</span><br><span class="line"></span><br><span class="line">        out.setInt(lengthPos, out.writerIndex() - lengthPos - <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 自定义 Unmarshalling 解码器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarshallingDecoder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Unmarshaller unmarshaller;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MarshallingDecoder</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        unmarshaller = MarshallingCodeFactory.buildUnmarshaller();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">decode</span><span class="params">(ByteBuf in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">objectSize</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">        <span class="keyword">if</span> (objectSize&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> in.slice(in.readerIndex(),objectSize);</span><br><span class="line">            <span class="type">ByteInput</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChannelBufferByteInput</span>(buf);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                unmarshaller.start(input);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> unmarshaller.readObject();</span><br><span class="line">                unmarshaller.finish();</span><br><span class="line">                in.readerIndex(in.readerIndex()+objectSize);</span><br><span class="line">                <span class="keyword">return</span> obj;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// Call close in a finally block as the ReplayingDecoder will throw an Error if not enough bytes are</span></span><br><span class="line">                <span class="comment">// readable. This helps to be sure that we do not leak resource</span></span><br><span class="line">                unmarshaller.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="12-3-3、握手和安全认证"><a href="#12-3-3、握手和安全认证" class="headerlink" title="12.3.3、握手和安全认证"></a>12.3.3、握手和安全认证</h5><p><strong>客户端握手认证</strong></p>
<p>握手认证是在客户端和服务端成功建立TCP通信激活时，发送握手请求给服务端，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientMsgHeaderHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.writeAndFlush(buildNettyMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">NettyMessage</span> <span class="variable">message</span> <span class="operator">=</span> (NettyMessage) msg;</span><br><span class="line">        <span class="comment">// 判断如果是握手应答消息，判断是否成功</span></span><br><span class="line">        <span class="keyword">if</span> (message!=<span class="literal">null</span> &amp;&amp; message.getHeaders()!=<span class="literal">null</span></span><br><span class="line">                &amp;&amp; message.getHeaders().getType()==MessageType.SHARKHAND_RESP.val)&#123;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">loginResult</span> <span class="operator">=</span> (<span class="type">byte</span>) message.getBody();</span><br><span class="line">            <span class="keyword">if</span> (loginResult != (<span class="type">byte</span>) <span class="number">0</span>)&#123;</span><br><span class="line">                ctx.close();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;login is ok:&quot;</span>+message);</span><br><span class="line">                ctx.fireChannelRead(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.fireChannelRead(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireExceptionCaught(cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建请求消息</span></span><br><span class="line">    <span class="keyword">public</span> NettyMessage <span class="title function_">buildNettyMessage</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">NettyMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyMessage</span>();</span><br><span class="line">        <span class="type">NettyMsgHeader</span> <span class="variable">header</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyMsgHeader</span>();</span><br><span class="line">        header.setType(MessageType.SHARKHAND_REQ.val);</span><br><span class="line">        message.setHeaders(header);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>服务端代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginAuthRespHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Boolean&gt; nodeCheck = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> String[] whiteIps = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;192.168.2.190&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">NettyMessage</span> <span class="variable">message</span> <span class="operator">=</span> (NettyMessage) msg;</span><br><span class="line">        <span class="keyword">if</span> (message.getHeaders()!=<span class="literal">null</span> &amp;&amp; message.getHeaders().getType()== MessageType.SHARKHAND_REQ.val)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">nodeIndex</span> <span class="operator">=</span> ctx.channel().remoteAddress().toString();</span><br><span class="line">            <span class="type">NettyMessage</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// 已登录节点校验检查，避免重复登录</span></span><br><span class="line">            <span class="keyword">if</span> (nodeCheck.containsKey(nodeIndex))&#123;</span><br><span class="line">                <span class="comment">// 重复登录</span></span><br><span class="line">                resp = buildResponse((<span class="type">byte</span>) -<span class="number">1</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 白名单登录校验</span></span><br><span class="line">                <span class="type">InetSocketAddress</span> <span class="variable">socketAddress</span> <span class="operator">=</span> (InetSocketAddress) ctx.channel().remoteAddress();</span><br><span class="line">                <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> socketAddress.getAddress().getHostAddress();</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isOk</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">for</span> (String wip : whiteIps)&#123;</span><br><span class="line">                    <span class="keyword">if</span> (wip.equals(ip))&#123;</span><br><span class="line">                        isOk = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (isOk)&#123;</span><br><span class="line">                    resp = buildResponse((<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">                    nodeCheck.put(ip,<span class="literal">true</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    resp = buildResponse((<span class="type">byte</span>) -<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;The login response is : &quot;</span>+resp+<span class="string">&quot;, body is [&quot;</span>+resp.getBody()+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">            ctx.writeAndFlush(resp);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.fireChannelRead(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        nodeCheck.remove(ctx.channel().remoteAddress().toString());</span><br><span class="line">        ctx.close();</span><br><span class="line">        ctx.fireExceptionCaught(cause);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建握手请求消息返回</span></span><br><span class="line">    <span class="keyword">private</span> NettyMessage <span class="title function_">buildResponse</span><span class="params">(<span class="type">byte</span> result)</span>&#123;</span><br><span class="line">        <span class="type">NettyMessage</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyMessage</span>();</span><br><span class="line">        <span class="type">NettyMsgHeader</span> <span class="variable">header</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyMsgHeader</span>();</span><br><span class="line">        header.setType(MessageType.SHARKHAND_RESP.val);</span><br><span class="line">        response.setHeaders(header);</span><br><span class="line">        response.setBody(result);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过与客户端TCP三次握手成功后，客户端发送握手认证消息给服务端，服务端根据消息类型判断，如果是握手认证消息，则判断是否已经登录并且是否在白名单配置中，如果通过则构造握手响应消息返回给客户端。</p>
<h5 id="12-3-4、心跳检测"><a href="#12-3-4、心跳检测" class="headerlink" title="12.3.4、心跳检测"></a>12.3.4、心跳检测</h5><p>握手成功后，在客户端接收到服务端响应的握手成功消息后。客户端主动发起心跳消息，服务端收到客户端心跳消息后，返回心跳应答，在此过程中，心跳消息主要是检测链路的可用性，不需要携带消息体。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 客户端心跳请求代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeartBeatReqHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ScheduledFuture&lt;?&gt; heartBeat;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">NettyMessage</span> <span class="variable">message</span> <span class="operator">=</span> (NettyMessage) msg;</span><br><span class="line">        <span class="comment">// 客户端握手成功主动发心跳消息</span></span><br><span class="line">        <span class="keyword">if</span> (message.getHeaders()!=<span class="literal">null</span> &amp;&amp; message.getHeaders().getType()== MessageType.SHARKHAND_RESP.val)&#123;</span><br><span class="line">            heartBeat = ctx.executor().scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">HeartBeatTask</span>(ctx),<span class="number">0</span>,<span class="number">5000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (message.getHeaders()!=<span class="literal">null</span> &amp;&amp; message.getHeaders().getType()==MessageType.HEARTBEAT_RESP.val)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;client received hear tbeat message : &lt;---- &quot;</span>+message);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.fireChannelRead(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span>(heartBeat!=<span class="literal">null</span>)&#123;</span><br><span class="line">            heartBeat.cancel(<span class="literal">true</span>);</span><br><span class="line">            heartBeat=<span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.fireExceptionCaught(cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeartBeatTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> ChannelHandlerContext ctx;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">HeartBeatTask</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.ctx = ctx;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">NettyMessage</span> <span class="variable">message</span> <span class="operator">=</span> buildHeartBeat();</span><br><span class="line">            System.out.println(<span class="string">&quot;client send heart beat to server : ----&gt; &quot;</span>+message);</span><br><span class="line">            ctx.writeAndFlush(message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> NettyMessage <span class="title function_">buildHeartBeat</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="type">NettyMessage</span> <span class="variable">nettyMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyMessage</span>();</span><br><span class="line">            <span class="type">NettyMsgHeader</span> <span class="variable">nettyMsgHeader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyMsgHeader</span>();</span><br><span class="line"></span><br><span class="line">            nettyMsgHeader.setType(MessageType.HEARTBEAT_REQ.val);</span><br><span class="line">            nettyMessage.setHeaders(nettyMsgHeader);</span><br><span class="line">            <span class="keyword">return</span> nettyMessage;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 服务端心跳应答代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeartBeatRespHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">NettyMessage</span> <span class="variable">message</span> <span class="operator">=</span> (NettyMessage) msg;</span><br><span class="line">        <span class="keyword">if</span> (message.getHeaders()!=<span class="literal">null</span> &amp;&amp; message.getHeaders().getType()== MessageType.HEARTBEAT_REQ.val)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Server received heart beat : &lt;---- &quot;</span>+message);</span><br><span class="line">            <span class="type">NettyMessage</span> <span class="variable">respHeartBeat</span> <span class="operator">=</span> buildRespHeartBeat();</span><br><span class="line">            System.out.println(<span class="string">&quot;Server send heart beat to client : ----&gt; &quot;</span>+respHeartBeat);</span><br><span class="line">            ctx.writeAndFlush(respHeartBeat);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.fireChannelRead(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> NettyMessage <span class="title function_">buildRespHeartBeat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NettyMessage</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyMessage</span>();</span><br><span class="line">        <span class="type">NettyMsgHeader</span> <span class="variable">header</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyMsgHeader</span>();</span><br><span class="line">        header.setType(MessageType.HEARTBEAT_RESP.val);</span><br><span class="line">        resp.setHeaders(header);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireExceptionCaught(cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在客户端接收到握手成功的响应消息后，响应信息通过 Handler 继续向下传递，HeartBeatReqHandler 接收到消息，判断如果是握手成功，则启动无限循环定时器发送心跳消息。NioEventLoop 是一个 Schdule，因此支持定时器的执行。心跳第定时器很简单，通过构造参数获取 <code>ChannelHandlerContext</code> 发送消息。</p>
<p>在服务端接收到心跳消息则返回心跳应答即可。</p>
<p>心跳超时很简单，利用 Netty 的 <code>ReadTimeOutHandler</code> 机制，一定周期内没有读取到对方消息时，需要主动关闭客户端连接。如果是客户端，重新发起连接；如果是服务端，释放资源，清除客户端登录缓存，等待客户端重连。</p>
<h5 id="12-3-5、断连重试"><a href="#12-3-5、断连重试" class="headerlink" title="12.3.5、断连重试"></a>12.3.5、断连重试</h5><p>在客户端中，感知到断连后，释放资源，重新发起连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host,port)</span><br><span class="line">            ,<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(NettyConstant.LOCALIP,NettyConstant.LOCALPORT)).sync();</span><br><span class="line">    future.channel().closeFuture().sync();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 释放所有资源再重新发起连接</span></span><br><span class="line">    executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5</span>);</span><br><span class="line">                connect(NettyConstant.REMOTEIP,NettyConstant.PORT);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>监听网络断连事件，如果 <code>Channel</code> 关闭，则自行后续重连任务，通过 Bootstrap 重新发起连接。客户端挂在<code>closeFuture</code> 上监听链路关闭信号，一旦关闭，则创建重连定时器，5s 重新发起连接，直到连接成功。</p>
<h5 id="12-3-6、客户端代码"><a href="#12-3-6、客户端代码" class="headerlink" title="12.3.6、客户端代码"></a>12.3.6、客户端代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">EventLoopGroup</span> <span class="variable">loopGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(String host, <span class="type">int</span> port)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(loopGroup)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.TCP_NODELAY,<span class="literal">true</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">NettyMessageDecoder</span>(<span class="number">1024</span>*<span class="number">1024</span>,<span class="number">4</span>,<span class="number">4</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;MessageEncoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">NettyMessageEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;redadTimeOutHandler&quot;</span>,<span class="keyword">new</span> <span class="title class_">ReadTimeoutHandler</span>(<span class="number">50</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;loginHandler&quot;</span>,<span class="keyword">new</span> <span class="title class_">ClientMsgHeaderHandler</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;HeartBeatHandler&quot;</span>,<span class="keyword">new</span> <span class="title class_">HeartBeatReqHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host,port)</span><br><span class="line">                    ,<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(NettyConstant.LOCALIP,NettyConstant.LOCALPORT)).sync();</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 释放所有资源再重新发起连接</span></span><br><span class="line">            executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">5</span>);</span><br><span class="line">                        connect(NettyConstant.REMOTEIP,NettyConstant.PORT);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span>&#123;</span><br><span class="line">        <span class="type">NettyClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyClient</span>();</span><br><span class="line">        client.connect(NettyConstant.REMOTEIP,NettyConstant.PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="12-3-7、服务端代码"><a href="#12-3-7、服务端代码" class="headerlink" title="12.3.7、服务端代码"></a>12.3.7、服务端代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 初始化线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            serverBootstrap.group(bossGroup,workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">NettyMessageDecoder</span>(<span class="number">1024</span>*<span class="number">1024</span>,<span class="number">4</span>,<span class="number">4</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;MessageEncoder&quot;</span>,<span class="keyword">new</span> <span class="title class_">NettyMessageEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;LoginAuthRespHandler&quot;</span>,<span class="keyword">new</span> <span class="title class_">LoginAuthRespHandler</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="string">&quot;HeartBeatRespHandler&quot;</span>,<span class="keyword">new</span> <span class="title class_">HeartBeatRespHandler</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> serverBootstrap.bind(port).sync();</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">NettyServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyServer</span>();</span><br><span class="line">        server.bind(NettyConstant.PORT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="12-4、运行协议栈结果"><a href="#12-4、运行协议栈结果" class="headerlink" title="12.4、运行协议栈结果"></a>12.4、运行协议栈结果</h4><p><img src="/../assets/blogImg/Netty/12-4-1.png" alt="12-4-1"></p>
<p><img src="/../assets/blogImg/Netty/12-4-2.png" alt="12-4-2"></p>
<h3 id="十三、服务端创建"><a href="#十三、服务端创建" class="headerlink" title="十三、服务端创建"></a>十三、服务端创建</h3><h4 id="13-1、服务端创建流程"><a href="#13-1、服务端创建流程" class="headerlink" title="13.1、服务端创建流程"></a>13.1、服务端创建流程</h4><p><img src="/../assets/blogImg/Netty/13-1.png" alt="13-1"></p>

      

      
        <div class="page-reward">
          <a href="javascript:;" class="page-reward-btn tooltip-top">
            <div class="tooltip tooltip-east">
            <span class="tooltip-item">
              赏
            </span>
            <span class="tooltip-content">
              <span class="tooltip-text">
                <span class="tooltip-inner">
                  <p class="reward-p"><i class="icon icon-quo-left"></i>谢谢你请我吃糖果<i class="icon icon-quo-right"></i></p>
                  <div class="reward-box">
                    
                    
                  </div>
                </span>
              </span>
            </span>
          </div>
          </a>
        </div>
      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">Java</a>
        		</li>
      		
		</ul>
	</div>

      

      

      
        
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//pan.baidu.com/share/qrcode?url=http://cxinxian.github.io/2021/09/06/Netty/Netty%20%E7%AC%94%E8%AE%B0/" alt="微信分享二维码">
    </div>
</div>

<div class="mask js-mask"></div>
      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2021/09/14/Netty/Netty2/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          Netty 笔记2
        
      </div>
    </a>
  
  
    <a href="/2021/05/24/java-ast-2/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">抽象语法树的应用样例</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>


<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>



  
  
  

  

  

  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2025 Allen
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: true
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(195),t.exports=r(191)},function(t,n,r){var e=r(3),i=r(52),o=r(27),u=r(28),c=r(53),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,b=t&a.B,m=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),w=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&m&&void 0!==m[s],h=(l?m:r)[s],v=b&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,m&&u(m,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&w[s]!=h&&(w[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(6);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n,r){var e=r(126)("wks"),i=r(76),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(94),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(167),o=r(50),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(58),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(5).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(67),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){var e=r(46);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,r){var e=r(63),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(11),i=r(66);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(27),o=r(24),u=r(76)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(52).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(46),u=function(t,n,r,e){var i=String(o(t)),u="<"+n;return""!==r&&(u+=" "+r+'="'+String(e).replace(/"/g,"&quot;")+'"'),u+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(u),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(115),i=r(46);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(116),i=r(66),o=r(30),u=r(50),c=r(24),f=r(167),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(24),i=r(17),o=r(145)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(15)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(5),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(15)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(53),i=r(115),o=r(17),u=r(16),c=r(203);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),b=i(g),m=e(c,p,3),x=u(b.length),w=0,S=r?v(n,x):f?v(n,0):void 0;x>w;w++)if((h||w in b)&&(d=b[w],y=m(d,w,g),t))if(r)S[w]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return w;case 2:S.push(d)}else if(s)return!1;return l?-1:a||s?s:S}}},function(t,n,r){var e=r(1),i=r(52),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n,r){var e=r(6);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(91),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,b=v?i:i[n]||(i[n]={}),m=b[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in b||(l=s?x[a]:r[a],b[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((b.virtual||(b.virtual={}))[a]=l,t&f.R&&m&&!m[a]&&u(m,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n,r){var e=r(26);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(183),i=r(1),o=r(126)("metadata"),u=o.store||(o.store=new(r(186))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o},f=function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},a=function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},s=function(t,n,r,e){c(r,e,!0).set(t,n)},l=function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},h=function(t){return void 0===t||"symbol"==typeof t?t:String(t)},v=function(t){i(i.S,"Reflect",t)};t.exports={store:u,map:c,has:f,get:a,set:s,keys:l,key:h,exp:v}},function(t,n,r){"use strict";if(r(10)){var e=r(69),i=r(3),o=r(4),u=r(1),c=r(127),f=r(152),a=r(53),s=r(68),l=r(66),h=r(27),v=r(73),p=r(67),d=r(16),y=r(75),g=r(50),b=r(24),m=r(180),x=r(114),w=r(6),S=r(17),_=r(137),O=r(70),E=r(32),P=r(71).f,j=r(154),F=r(76),M=r(7),A=r(48),N=r(117),T=r(146),I=r(155),k=r(80),L=r(123),R=r(74),C=r(130),D=r(160),U=r(11),W=r(31),G=U.f,B=W.f,V=i.RangeError,z=i.TypeError,q=i.Uint8Array,K="ArrayBuffer",J="Shared"+K,Y="BYTES_PER_ELEMENT",H="prototype",$=Array[H],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=N(!0),ut=N(!1),ct=I.values,ft=I.keys,at=I.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,bt=M("iterator"),mt=M("toStringTag"),xt=F("typed_constructor"),wt=F("def_constructor"),St=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Pt=A(1,function(t,n){return Tt(T(t,t[wt]),n)}),jt=o(function(){return 1===new q(new Uint16Array([1]).buffer)[0]}),Ft=!!q&&!!q[H].set&&o(function(){new q(1).set({})}),Mt=function(t,n){if(void 0===t)throw z(Et);var r=+t,e=d(t);if(n&&!m(r,e))throw V(Et);return e},At=function(t,n){var r=p(t);if(r<0||r%n)throw V("Wrong offset!");return r},Nt=function(t){if(w(t)&&_t in t)return t;throw z(t+" is not a typed array!")},Tt=function(t,n){if(!(w(t)&&xt in t))throw z("It is not a typed array constructor!");return new t(n)},It=function(t,n){return kt(T(t,t[wt]),n)},kt=function(t,n){for(var r=0,e=n.length,i=Tt(t,e);e>r;)i[r]=n[r++];return i},Lt=function(t,n,r){G(t,n,{get:function(){return this._d[r]}})},Rt=function(t){var n,r,e,i,o,u,c=S(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=j(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Tt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Ct=function(){for(var t=0,n=arguments.length,r=Tt(this,n);n>t;)r[t]=arguments[t++];return r},Dt=!!q&&o(function(){gt.call(new q(1))}),Ut=function(){return gt.apply(Dt?dt.call(Nt(this)):Nt(this),arguments)},Wt={copyWithin:function(t,n){return D.call(Nt(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(Nt(this),arguments)},filter:function(t){return It(this,tt(Nt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(Nt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(Nt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(Nt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(Nt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(Nt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(Nt(this),arguments)},lastIndexOf:function(t){return st.apply(Nt(this),arguments)},map:function(t){return Pt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(Nt(this),arguments)},reduceRight:function(t){return ht.apply(Nt(this),arguments)},reverse:function(){for(var t,n=this,r=Nt(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(Nt(this),t)},subarray:function(t,n){var r=Nt(this),e=r.length,i=y(t,e);return new(T(r,r[wt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:y(n,e))-i))}},Gt=function(t,n){return It(this,dt.call(Nt(this),t,n))},Bt=function(t){Nt(this);var n=At(arguments[1],1),r=this.length,e=S(t),i=d(e.length),o=0;if(i+n>r)throw V(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(Nt(this))},keys:function(){return ft.call(Nt(this))},values:function(){return ct.call(Nt(this))}},zt=function(t,n){return w(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return zt(t,n=g(n,!0))?l(2,t[n]):B(t,n)},Kt=function(t,n,r){return!(zt(t,n=g(n,!0))&&w(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?G(t,n,r):(t[n]=r.value,t)};St||(W.f=qt,U.f=Kt),u(u.S+u.F*!St,"Object",{getOwnPropertyDescriptor:qt,defineProperty:Kt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Jt=v({},Wt);v(Jt,Vt),h(Jt,bt,Vt.values),v(Jt,{slice:Gt,set:Bt,constructor:function(){},toString:yt,toLocaleString:Ut}),Lt(Jt,"buffer","b"),Lt(Jt,"byteOffset","o"),Lt(Jt,"byteLength","l"),Lt(Jt,"length","e"),G(Jt,mt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){f=!!f;var a=t+(f?"Clamped":"")+"Array",l="Uint8Array"!=a,v="get"+t,p="set"+t,y=i[a],g=y||{},b=y&&E(y),m=!y||!c.ABV,S={},_=y&&y[H],j=function(t,r){var e=t._d;return e.v[v](r*n+e.o,jt)},F=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[p](r*n+i.o,e,jt)},M=function(t,n){G(t,n,{get:function(){return j(this,n)},set:function(t){return F(this,n,t)},enumerable:!0})};m?(y=r(function(t,r,e,i){s(t,y,a,"_d");var o,u,c,f,l=0,v=0;if(w(r)){if(!(r instanceof X||(f=x(r))==K||f==J))return _t in r?kt(y,r):Rt.call(y,r);o=r,v=At(e,n);var p=r.byteLength;if(void 0===i){if(p%n)throw V(Et);if((u=p-v)<0)throw V(Et)}else if((u=d(i)*n)+v>p)throw V(Et);c=u/n}else c=Mt(r,!0),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)M(t,l++)}),_=y[H]=O(Jt),h(_,"constructor",y)):L(function(t){new y(null),new y(t)},!0)||(y=r(function(t,r,e,i){s(t,y,a);var o;return w(r)?r instanceof X||(o=x(r))==K||o==J?void 0!==i?new g(r,At(e,n),i):void 0!==e?new g(r,At(e,n)):new g(r):_t in r?kt(y,r):Rt.call(y,r):new g(Mt(r,l))}),Z(b!==Function.prototype?P(g).concat(P(b)):P(g),function(t){t in y||h(y,t,g[t])}),y[H]=_,e||(_.constructor=y));var A=_[bt],N=!!A&&("values"==A.name||void 0==A.name),T=Vt.values;h(y,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,wt,y),(f?new y(1)[mt]==a:mt in _)||G(_,mt,{get:function(){return a}}),S[a]=y,u(u.G+u.W+u.F*(y!=g),S),u(u.S,a,{BYTES_PER_ELEMENT:n,from:Rt,of:Ct}),Y in _||h(_,Y,n),u(u.P,a,Wt),R(a),u(u.P+u.F*Ft,a,{set:Bt}),u(u.P+u.F*!N,a,Vt),u(u.P+u.F*(_.toString!=yt),a,{toString:yt}),u(u.P+u.F*o(function(){new y(1).slice()}),a,{slice:Gt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new y([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Ut}),k[a]=N?A:T,e||N||h(_,bt,T)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(5).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(57)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(51),o=r(64),u=r(13),c=r(8),f=r(35),a=r(96),s=r(38),l=r(103),h=r(15)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(57)("iframe"),e=o.length;for(n.style.display="none",r(93).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(63),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(9),o=r(90)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(76)("meta"),i=r(6),o=r(24),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(173),o=r(133),u=r(145)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(132)("iframe"),e=o.length;for(n.style.display="none",r(135).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(175),i=r(133).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(175),i=r(133);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(28);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(67),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(27)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(53),i=r(169),o=r(137),u=r(2),c=r(16),f=r(154),a={},s={},n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),b=e(r,l,n?2:1),m=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>m;m++)if((y=n?b(u(p=t[m])[0],p[1]):b(t[m]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,b,p.value,n))===a||y===s)return y};n.BREAK=a,n.RETURN=s},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(24),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(46),o=r(4),u=r(150),c="["+u+"]",f="​",a=RegExp("^"+c+c+"*"),s=RegExp(c+c+"*$"),l=function(t,n,r){var i={},c=o(function(){return!!u[t]()||f[t]()!=f}),a=i[t]=c?n(h):u[t];r&&(i[r]=a),e(e.P+e.F*c,"String",i)},h=l.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(a,"")),2&n&&(t=t.replace(s,"")),t};t.exports=l},function(t,n,r){t.exports={default:r(86),__esModule:!0}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=r(84),o=e(i),u=r(83),c=e(u),f="function"==typeof c.default&&"symbol"==typeof o.default?function(t){return typeof t}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":typeof t};n.default="function"==typeof c.default&&"symbol"===f(o.default)?function(t){return void 0===t?"undefined":f(t)}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":void 0===t?"undefined":f(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(25).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(9),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(88);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(19),i=r(62),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){t.exports=r(5).document&&document.documentElement},function(t,n,r){var e=r(56);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(56);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(60),i=r(22),o=r(38),u={};r(13)(u,r(15)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(19),i=r(9);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n,r){var e=r(14),i=r(20),o=r(19);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(9),u=r(42),c=r(8),f=r(58),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(9),i=r(61).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(77),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(89),i=r(97),o=r(35),u=r(9);t.exports=r(59)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(59)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(5),i=r(8),o=r(12),u=r(51),c=r(64),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(15),p=r(44),d=r(43),y=r(98),g=r(92),b=r(95),m=r(20),x=r(9),w=r(42),S=r(22),_=r(60),O=r(102),E=r(101),P=r(14),j=r(19),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(61).f=O.f=Z,r(37).f=X,r(62).f=tt,o&&!r(36)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(13)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(5),i=r(13),o=r(35),u=r(15)("toStringTag"),c=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(30),i=r(16),o=r(75);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(28),u=r(73),c=r(65),f=r(79),a=r(68),s=r(6),l=r(4),h=r(123),v=r(81),p=r(136);t.exports=function(t,n,r,d,y,g){var b=e[t],m=b,x=y?"set":"add",w=m&&m.prototype,S={},_=function(t){var n=w[t];o(w,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof m&&(g||w.forEach&&!l(function(){(new m).entries().next()}))){var O=new m,E=O[x](g?{}:-0,1)!=O,P=l(function(){O.has(1)}),j=h(function(t){new m(t)}),F=!g&&l(function(){for(var t=new m,n=5;n--;)t[x](n,n);return!t.has(-0)});j||(m=n(function(n,r){a(n,m,t);var e=p(new b,n,m);return void 0!=r&&f(r,y,e[x],e),e}),m.prototype=w,w.constructor=m),(P||F)&&(_("delete"),_("has"),y&&_("get")),(F||E)&&_(x),g&&w.clear&&delete w.clear}else m=d.getConstructor(n,t,y,x),u(m.prototype,r),c.NEED=!0;return v(m,t),S[t]=m,i(i.G+i.W+i.F*(m!=b),S),g||d.setStrong(m,t,y),m}},function(t,n,r){"use strict";var e=r(27),i=r(28),o=r(4),u=r(46),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}
},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(6),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){t.exports=r(69)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){for(var e,i=r(3),o=r(27),u=r(76),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=r(85),i=function(t){return t&&t.__esModule?t:{default:t}}(e),o=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):r[t]||t}function n(t){return e[t]}var r={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},e={};for(var u in r)e[r[u]]=u;return r["&apos;"]="'",e["'"]="&#39;",{encode:function(t){return t?(""+t).replace(/['<> "&]/g,n).replace(/\r?\n/g,"<br/>").replace(/\s/g,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(/<br\s*\/?>/gi,"\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,t).replace(/\u00a0/g," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=o.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,i.default)(t)))for(var e in t)t[e]=o.encodeObject(t[e]);else if("string"==typeof t)return o.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=o},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){"use strict";var e=r(11),i=r(66);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(6),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){t.exports=r(3).document&&document.documentElement},function(t,n,r){var e=r(6),i=r(144).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(70),i=r(66),o=r(81),u={};r(27)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(69),i=r(1),o=r(28),u=r(27),c=r(24),f=r(80),a=r(139),s=r(81),l=r(32),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(151).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){var e=r(6),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{e=r(53)(Function.call,r(31).f(Object.prototype,"__proto__").set,2),e(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(126)("keys"),i=r(76);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(2),i=r(26),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){var e=r(67),i=r(46);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(122),i=r(46);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(67),i=r(46);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(53),c=r(121),f=r(135),a=r(132),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=0,y={},g="onreadystatechange",b=function(){var t=+this;if(y.hasOwnProperty(t)){var n=y[t];delete y[t],n()}},m=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return y[++d]=function(){c("function"==typeof t?t:Function(t),n)},e(d),d},v=function(t){delete y[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=g in a("script")?function(t){f.appendChild(a("script"))[g]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(69),u=r(127),c=r(27),f=r(73),a=r(4),s=r(68),l=r(67),h=r(16),v=r(71).f,p=r(11).f,d=r(130),y=r(81),g="ArrayBuffer",b="DataView",m="prototype",x="Wrong length!",w="Wrong index!",S=e[g],_=e[b],O=e.Math,E=e.RangeError,P=e.Infinity,j=S,F=O.abs,M=O.pow,A=O.floor,N=O.log,T=O.LN2,I="buffer",k="byteLength",L="byteOffset",R=i?"_b":I,C=i?"_l":k,D=i?"_o":L,U=function(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?M(2,-24)-M(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for(t=F(t),t!=t||t===P?(i=t!=t?1:0,e=f):(e=A(N(t)/T),t*(o=M(2,-e))<1&&(e--,o*=2),t+=e+a>=1?s/o:s*M(2,1-a),t*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*M(2,n),e+=a):(i=t*M(2,a-1)*M(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u},W=function(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-P:P;e+=M(2,n),s-=u}return(a?-1:1)*e*M(2,s-n)},G=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},B=function(t){return[255&t]},V=function(t){return[255&t,t>>8&255]},z=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},q=function(t){return U(t,52,8)},K=function(t){return U(t,23,4)},J=function(t,n,r){p(t[m],n,{get:function(){return this[r]}})},Y=function(t,n,r,e){var i=+r,o=l(i);if(i!=o||o<0||o+n>t[C])throw E(w);var u=t[R]._b,c=o+t[D],f=u.slice(c,c+n);return e?f:f.reverse()},H=function(t,n,r,e,i,o){var u=+r,c=l(u);if(u!=c||c<0||c+n>t[C])throw E(w);for(var f=t[R]._b,a=c+t[D],s=e(+i),h=0;h<n;h++)f[a+h]=s[o?h:n-h-1]},$=function(t,n){s(t,S,g);var r=+n,e=h(r);if(r!=e)throw E(x);return e};if(u.ABV){if(!a(function(){new S})||!a(function(){new S(.5)})){S=function(t){return new j($(this,t))};for(var X,Q=S[m]=j[m],Z=v(j),tt=0;Z.length>tt;)(X=Z[tt++])in S||c(S,X,j[X]);o||(Q.constructor=S)}var nt=new _(new S(2)),rt=_[m].setInt8;nt.setInt8(0,2147483648),nt.setInt8(1,2147483649),!nt.getInt8(0)&&nt.getInt8(1)||f(_[m],{setInt8:function(t,n){rt.call(this,t,n<<24>>24)},setUint8:function(t,n){rt.call(this,t,n<<24>>24)}},!0)}else S=function(t){var n=$(this,t);this._b=d.call(Array(n),0),this[C]=n},_=function(t,n,r){s(this,_,b),s(t,S,b);var e=t[C],i=l(n);if(i<0||i>e)throw E("Wrong offset!");if(r=void 0===r?e-i:h(r),i+r>e)throw E(x);this[R]=t,this[D]=i,this[C]=r},i&&(J(S,k,"_l"),J(_,I,"_b"),J(_,k,"_l"),J(_,L,"_o")),f(_[m],{getInt8:function(t){return Y(this,1,t)[0]<<24>>24},getUint8:function(t){return Y(this,1,t)[0]},getInt16:function(t){var n=Y(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=Y(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return G(Y(this,4,t,arguments[1]))},getUint32:function(t){return G(Y(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return W(Y(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return W(Y(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){H(this,1,t,B,n)},setUint8:function(t,n){H(this,1,t,B,n)},setInt16:function(t,n){H(this,2,t,V,n,arguments[2])},setUint16:function(t,n){H(this,2,t,V,n,arguments[2])},setInt32:function(t,n){H(this,4,t,z,n,arguments[2])},setUint32:function(t,n){H(this,4,t,z,n,arguments[2])},setFloat32:function(t,n){H(this,4,t,K,n,arguments[2])},setFloat64:function(t,n){H(this,8,t,q,n,arguments[2])}});y(S,g),y(_,b),c(_[m],u.VIEW,!0),n[g]=S,n[b]=_},function(t,n,r){var e=r(3),i=r(52),o=r(69),u=r(182),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(52).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(78),i=r(170),o=r(80),u=r(30);t.exports=r(140)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){function r(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=r},function(t,n){function r(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}t.exports=r},function(t,n){function r(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function i(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(n){try{return s.call(null,t,0)}catch(n){return s.call(this,t,0)}}}function o(t){if(l===clearTimeout)return clearTimeout(t);if((l===e||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(t);try{return l(t)}catch(n){try{return l.call(null,t)}catch(n){return l.call(this,t)}}}function u(){d&&v&&(d=!1,v.length?p=v.concat(p):y=-1,p.length&&c())}function c(){if(!d){var t=i(u);d=!0;for(var n=p.length;n;){for(v=p,p=[];++y<n;)v&&v[y].run();y=-1,n=p.length}v=null,d=!1,o(t)}}function f(t,n){this.fun=t,this.array=n}function a(){}var s,l,h=t.exports={};!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{l="function"==typeof clearTimeout?clearTimeout:e}catch(t){l=e}}();var v,p=[],d=!1,y=-1;h.nextTick=function(t){var n=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];p.push(new f(t,n)),1!==p.length||d||i(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=a,h.addListener=a,h.once=a,h.off=a,h.removeListener=a,h.removeAllListeners=a,h.emit=a,h.prependListener=a,h.prependOnceListener=a,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(79);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(26),i=r(17),o=r(115),u=r(16);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(26),i=r(6),o=r(121),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(11).f,i=r(70),o=r(73),u=r(53),c=r(68),f=r(46),a=r(79),s=r(140),l=r(170),h=r(74),v=r(10),p=r(65).fastKey,d=v?"_s":"size",y=function(t,n){var r,e=p(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,s){var l=t(function(t,e){c(t,l,n,"_i"),t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&a(e,r,t[s],t)});return o(l.prototype,{clear:function(){for(var t=this,n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=this,r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){c(this,l,"forEach");for(var n,r=u(t,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(this,t)}}),v&&e(l.prototype,"size",{get:function(){return f(this[d])}}),l},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=p(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){s(t,n,function(t,n){this._t=t,this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?l(0,r.k):"values"==n?l(0,r.v):l(0,[r.k,r.v]):(t._t=void 0,l(1))},r?"entries":"values",!r,!0),h(n)}}},function(t,n,r){var e=r(114),i=r(161);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(73),i=r(65).getWeak,o=r(2),u=r(6),c=r(68),f=r(79),a=r(48),s=r(24),l=a(5),h=a(6),v=0,p=function(t){return t._l||(t._l=new d)},d=function(){this.a=[]},y=function(t,n){return l(t.a,function(t){return t[0]===n})};d.prototype={get:function(t){var n=y(this,t);if(n)return n[1]},has:function(t){return!!y(this,t)},set:function(t,n){var r=y(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=h(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._i=v++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).delete(t):n&&s(n,this._i)&&delete n[this._i]},has:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).has(t):n&&s(n,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?p(t).set(n,r):e[t._i]=r,t},ufstore:p}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(132)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(6),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n,r){"use strict";var e=r(72),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(11),i=r(2),o=r(72);t.exports=r(10)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(30),i=r(71).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(24),i=r(30),o=r(117)(!1),u=r(145)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(72),i=r(30),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(71),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(150)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(150),u=/^[\-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(16),i=r(149),o=r(46);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(this,t);return n&&n.v},set:function(t,n){return e.def(this,0===t?0:t,n)}},e,!0)},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(28),u=r(65),c=r(172),f=r(166),a=r(6),s=u.getWeak,l=Object.isExtensible,h=f.ufstore,v={},p=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},d={get:function(t){if(a(t)){var n=s(t);return!0===n?h(this).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(this,t,n)}},y=t.exports=r(118)("WeakMap",p,d,f,!0,!0);7!=(new y).set((Object.freeze||Object)(v),7).get(v)&&(e=f.getConstructor(p),c(e.prototype,d),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=y.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!l(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";function r(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}if(yiliaConfig&&yiliaConfig.toc_hide_index){document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}t.exports={init:r}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,h.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,d.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=r(156),h=e(l),v=r(157),p=(e(v),r(382)),d=e(p),y=r(128),g=e(y),b=r(190),m=e(b),x=r(129);(function(){g.default.versions.mobile&&window.screen.width<800&&(o(),s())})(),(0,x.addLoadEvent)(function(){m.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(381),r(391),r(198),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},,,function(t,n,r){r(210),t.exports=r(52).RegExp.escape},,,,function(t,n,r){var e=r(6),i=r(138),o=r(7)("species");t.exports=function(t){var n;return i(t)&&(n=t.constructor,"function"!=typeof n||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){var e=r(202);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(2),i=r(50),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(72),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(72),i=r(30);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){"use strict";var e=r(208),i=r(121),o=r(26);t.exports=function(){for(var t=o(this),n=arguments.length,r=Array(n),u=0,c=e._,f=!1;n>u;)(r[u]=arguments[u++])===c&&(f=!0);return function(){var e,o=this,u=arguments.length,a=0,s=0;if(!f&&!u)return i(t,r,o);if(e=r.slice(),f)for(;n>a;a++)e[a]===c&&(e[a]=arguments[s++]);for(;u>s;)e.push(arguments[s++]);return i(t,e,o)}}},function(t,n,r){t.exports=r(3)},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n,r){var e=r(1),i=r(209)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(160)}),r(78)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(130)}),r(78)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(53),i=r(1),o=r(17),u=r(169),c=r(137),f=r(16),a=r(131),s=r(154);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,b=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==b||v==Array&&c(b))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=b.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(138)})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=r(67),u=r(16),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(131);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(135),o=r(45),u=r(75),c=r(16),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(26),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(74)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=Date.prototype.getTime,u=function(t){return t>9?t:"0"+t};e(e.P+e.F*(i(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!i(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){
if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(27)(i,e,r(204))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(28)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(163)})},function(t,n,r){"use strict";var e=r(6),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=r(66),o=r(24),u=Function.prototype,c="name",f=Object.isExtensible||function(){return!0};c in u||r(10)&&e(u,c,{configurable:!0,get:function(){try{var t=this,n=(""+t).match(/^\s*function ([^ (]*)/)[1];return o(t,c)||!f(t)||e(t,c,i(5,n)),n}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(171),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(142);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(141);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1),i=r(142),o=Math.pow,u=o(2,-52),c=o(2,-23),f=o(2,127)*(2-c),a=o(2,-126),s=function(t){return t+1/u-1/u};e(e.S,"Math",{fround:function(t){var n,r,e=Math.abs(t),o=i(t);return e<a?o*s(e/a/c)*a*c:(n=(1+c/u)*e,r=n-(n-e),r>f||r!=r?o*(1/0):o*r)}})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)/Math.LN10}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(171)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(142)})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(45),u=r(136),c=r(50),f=r(4),a=r(71).f,s=r(31).f,l=r(11).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(70)(y))==v,b="trim"in String.prototype,m=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){n=b?n.trim():h(n,3);var r,e,i,o=n.charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(m(n)),r,p):m(n)};for(var x,w=r(10)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),S=0;w.length>S;S++)i(d,x=w[S])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(28)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(168)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(168),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(178);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(67),o=r(159),u=r(149),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",b=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),b=p()}else h(0,r),h(1<<-n,0),b=p()+u.call(l,a);return a>0?(c=b.length,b=g+(c<=a?"0."+u.call(l,a-c)+b:b.slice(0,c-a)+"."+b.slice(c-a))):b=g+b,b}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(159),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(70)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(173)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(30),i=r(31).f;r(49)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(49)("getOwnPropertyNames",function(){return r(174).f})},function(t,n,r){var e=r(17),i=r(32);r(49)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6);r(49)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(6);r(49)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(6);r(49)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(180)})},function(t,n,r){var e=r(17),i=r(72);r(49)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(144).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(28)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(178);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u=r(69),c=r(3),f=r(53),a=r(114),s=r(1),l=r(6),h=r(26),v=r(68),p=r(79),d=r(146),y=r(151).set,g=r(143)(),b="Promise",m=c.TypeError,x=c.process,w=c[b],x=c.process,S="process"==a(x),_=function(){},O=!!function(){try{var t=w.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(_,_)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(_)instanceof n}catch(t){}}(),E=function(t,n){return t===n||t===w&&n===o},P=function(t){var n;return!(!l(t)||"function"!=typeof(n=t.then))&&n},j=function(t){return E(w,t)?new F(t):new i(t)},F=i=function(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw m("Bad Promise constructor");n=t,r=e}),this.resolve=h(n),this.reject=h(r)},M=function(t){try{t()}catch(t){return{error:t}}},A=function(t,n){if(!t._n){t._n=!0;var r=t._c;g(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(m("Promise-chain cycle")):(o=P(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){y.call(c,function(){var n,r,e,i=t._v;if(T(t)&&(n=M(function(){S?x.emit("unhandledRejection",i,t):(r=c.onunhandledrejection)?r({promise:t,reason:i}):(e=c.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=S||T(t)?2:1),t._a=void 0,n)throw n.error})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if(n=r[e++],n.fail||!T(n.promise))return!1;return!0},I=function(t){y.call(c,function(){var n;S?x.emit("rejectionHandled",t):(n=c.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),A(n,!0))},L=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw m("Promise can't be resolved itself");(n=P(t))?g(function(){var e={_w:r,_d:!1};try{n.call(t,f(L,e,1),f(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,A(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};O||(w=function(t){v(this,w,b,"_h"),h(t),e.call(this);try{t(f(L,this,1),f(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(73)(w.prototype,{then:function(t,n){var r=j(d(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=S?x.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),F=function(){var t=new e;this.promise=t,this.resolve=f(L,t,1),this.reject=f(k,t,1)}),s(s.G+s.W+s.F*!O,{Promise:w}),r(81)(w,b),r(74)(b),o=r(52)[b],s(s.S+s.F*!O,b,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),s(s.S+s.F*(u||!O),b,{resolve:function(t){if(t instanceof w&&E(t.constructor,this))return t;var n=j(this);return(0,n.resolve)(t),n.promise}}),s(s.S+s.F*!(O&&r(123)(function(t){w.all(t).catch(_)})),b,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=M(function(){var r=[],o=0,u=1;p(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o&&i(o.error),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=M(function(){p(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i&&e(i.error),r.promise}})},function(t,n,r){var e=r(1),i=r(26),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(70),o=r(26),u=r(2),c=r(6),f=r(4),a=r(163),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(50);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(139)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(31),o=r(32),u=r(24),c=r(1),f=r(6),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(177)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(144);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(11),o=r(31),u=r(32),c=r(24),f=r(1),a=r(66),s=r(2),l=r(6);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(136),o=r(11).f,u=r(71).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(28)(e,"RegExp",a)}r(74)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,b=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+b.source+"$(?!\\s)",d));(c=b.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)b[a]===c.index&&b[a]++;return y===r[f]?!h&&b.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(184);var e=r(2),i=r(120),o=r(10),u="toString",c=/./[u],f=function(t){r(28)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(29)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(29)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(29)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(29)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="endsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(29)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(29)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(29)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(75),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(148),o="includes";e(e.P+e.F*r(134)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(29)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(147)(!0);r(140)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(29)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(30),o=r(16);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(149)})},function(t,n,r){"use strict";r(29)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="startsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(29)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(29)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(29)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(10),u=r(1),c=r(28),f=r(65).KEY,a=r(4),s=r(126),l=r(81),h=r(76),v=r(7),p=r(182),d=r(153),y=r(206),g=r(205),b=r(138),m=r(2),x=r(30),w=r(50),S=r(66),_=r(70),O=r(174),E=r(31),P=r(11),j=r(72),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(71).f=O.f=Z,r(116).f=X,r(125).f=tt,o&&!r(69)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(27)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(127),o=r(152),u=r(2),c=r(75),f=r(16),a=r(6),s=r(3).ArrayBuffer,l=r(146),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(74)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(127).ABV,{DataView:r(152).DataView})},function(t,n,r){r(55)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(166);r(118)("WeakSet",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)("includes")},function(t,n,r){var e=r(1),i=r(143)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(165)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o+(e>>>0)+((i&u|(i|u)&~(i+u>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o-(e>>>0)-((~i&u|~(i^u)&i-u>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(176)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(177),o=r(30),u=r(31),c=r(131);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r=o(t),e=u.f,f=i(r),a={},s=0;f.length>s;)c(a,n=f[s++],e(r,n));return a}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(176)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(52),u=r(143)(),c=r(7)("observable"),f=r(26),a=r(2),s=r(68),l=r(73),h=r(27),v=r(79),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},m=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};m.prototype=l({},{unsubscribe:function(){b(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var w=function(t){s(this,w,"Observable","_f")._f=f(t)};l(w.prototype,{subscribe:function(t){return new m(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(w,{from:function(t){var n="function"==typeof this?this:w,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:w)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(w.prototype,c,function(){return this}),e(e.G,{Observable:w}),r(74)("Observable")},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(185),i=r(161),o=r(54),u=r(2),c=r(32),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){
return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(26),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(165)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(16),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(139)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(153)("asyncIterator")},function(t,n,r){r(153)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){for(var e=r(155),i=r(28),o=r(3),u=r(27),c=r(80),f=r(7),a=f("iterator"),s=f("toStringTag"),l=c.Array,h=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],v=0;v<5;v++){var p,d=h[v],y=o[d],g=y&&y.prototype;if(g){g[a]||u(g,a,l),g[s]||u(g,s,d),c[d]=l;for(p in e)g[p]||i(g,p,e[p],!0)}}},function(t,n,r){var e=r(1),i=r(151);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(121),u=r(207),c=e.navigator,f=!!c&&/MSIE .\./.test(c.userAgent),a=function(t){return f?function(n,r){return t(o(u,[].slice.call(arguments,2),"function"==typeof n?n:Function(n)),r)}:t};i(i.G+i.B+i.F*f,{setTimeout:a(e.setTimeout),setInterval:a(e.setInterval)})},function(t,n,r){r(330),r(269),r(271),r(270),r(273),r(275),r(280),r(274),r(272),r(282),r(281),r(277),r(278),r(276),r(268),r(279),r(283),r(284),r(236),r(238),r(237),r(286),r(285),r(256),r(266),r(267),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(239),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(317),r(322),r(329),r(320),r(312),r(313),r(318),r(323),r(325),r(308),r(309),r(310),r(311),r(314),r(315),r(316),r(319),r(321),r(324),r(326),r(327),r(328),r(231),r(233),r(232),r(235),r(234),r(220),r(218),r(224),r(221),r(227),r(229),r(217),r(223),r(214),r(228),r(212),r(226),r(225),r(219),r(222),r(211),r(213),r(216),r(215),r(230),r(155),r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports=r(52)},function(t,n){function r(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}t.exports=r},,,,,,,,,function(t,n,r){(function(n,r){!function(n){"use strict";function e(t,n,r,e){var i=n&&n.prototype instanceof o?n:o,u=Object.create(i.prototype),c=new p(e||[]);return u._invoke=s(t,r,c),u}function i(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function o(){}function u(){}function c(){}function f(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function a(t){function n(r,e,o,u){var c=i(t[r],t,e);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){n("next",t,o,u)},function(t){n("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}function e(t,r){function e(){return new Promise(function(e,i){n(t,r,e,i)})}return o=o?o.then(e,e):e()}"object"==typeof r&&r.domain&&(n=r.domain.bind(n));var o;this._invoke=e}function s(t,n,r){var e=P;return function(o,u){if(e===F)throw new Error("Generator is already running");if(e===M){if("throw"===o)throw u;return y()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=l(c,r);if(f){if(f===A)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(e===P)throw e=M,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);e=F;var a=i(t,n,r);if("normal"===a.type){if(e=r.done?M:j,a.arg===A)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(e=M,r.method="throw",r.arg=a.arg)}}}function l(t,n){var r=t.iterator[n.method];if(r===g){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=g,l(t,n),"throw"===n.method))return A;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var e=i(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,A;var o=e.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=g),n.delegate=null,A):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,A)}function h(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function v(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function d(t){if(t){var n=t[w];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=g,n.done=!0,n};return e.next=e}}return{next:y}}function y(){return{value:g,done:!0}}var g,b=Object.prototype,m=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},w=x.iterator||"@@iterator",S=x.asyncIterator||"@@asyncIterator",_=x.toStringTag||"@@toStringTag",O="object"==typeof t,E=n.regeneratorRuntime;if(E)return void(O&&(t.exports=E));E=n.regeneratorRuntime=O?t.exports:{},E.wrap=e;var P="suspendedStart",j="suspendedYield",F="executing",M="completed",A={},N={};N[w]=function(){return this};var T=Object.getPrototypeOf,I=T&&T(T(d([])));I&&I!==b&&m.call(I,w)&&(N=I);var k=c.prototype=o.prototype=Object.create(N);u.prototype=k.constructor=c,c.constructor=u,c[_]=u.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===u||"GeneratorFunction"===(n.displayName||n.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_ in t||(t[_]="GeneratorFunction")),t.prototype=Object.create(k),t},E.awrap=function(t){return{__await:t}},f(a.prototype),a.prototype[S]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,i){var o=new a(e(t,n,r,i));return E.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},f(k),k[_]="Generator",k.toString=function(){return"[object Generator]"},E.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},E.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=g,this.done=!1,this.delegate=null,this.method="next",this.arg=g,this.tryEntries.forEach(v),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=g)},stop:function(){this.done=!0;var t=this.tryEntries[0],n=t.completion;if("throw"===n.type)throw n.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=g),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,A):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),A},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),v(r),A}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;v(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:d(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=g),A}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}(),r(158))}])</script><script src="/./main.0cf68a.js"></script><script>!function(){!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.e37972.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 50%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
        
      
      <li style="width: 50%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">SQL</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">随笔</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">写作</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">git</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">hexo blog</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">java</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">jvm</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Docker</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Python</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Data Structures and Algorithms</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>